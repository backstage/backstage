<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-stable docs-doc-page docs-doc-id-deployment/docker" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.5.2">
<title data-rh="true">Building a Docker image | Backstage Software Catalog and Developer Platform</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://backstage.io/img/sharing-opengraph.png"><meta data-rh="true" name="twitter:image" content="https://backstage.io/img/sharing-opengraph.png"><meta data-rh="true" property="og:url" content="https://backstage.io/docs/deployment/docker"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="stable"><meta data-rh="true" name="docusaurus_tag" content="docs-default-stable"><meta data-rh="true" name="docsearch:version" content="stable"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-stable"><meta data-rh="true" property="og:title" content="Building a Docker image | Backstage Software Catalog and Developer Platform"><meta data-rh="true" name="description" content="How to build a Backstage Docker image for deployment"><meta data-rh="true" property="og:description" content="How to build a Backstage Docker image for deployment"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://backstage.io/docs/deployment/docker"><link data-rh="true" rel="alternate" href="https://backstage.io/docs/deployment/docker" hreflang="en"><link data-rh="true" rel="alternate" href="https://backstage.io/docs/deployment/docker" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://JCMFNHCHI8-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Backstage Software Catalog and Developer Platform RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Backstage Software Catalog and Developer Platform Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-KSEVGGNCJW"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-KSEVGGNCJW",{})</script>


<link rel="search" type="application/opensearchdescription+xml" title="Backstage Software Catalog and Developer Platform" href="/opensearch.xml">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pushfeedback@latest/dist/pushfeedback/pushfeedback.css">


<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=IBM+Plex+Mono:500,700&display=swap">
<script src="https://buttons.github.io/buttons.js"></script>
<script src="https://unpkg.com/medium-zoom@1.0.6/dist/medium-zoom.min.js"></script>
<script src="/js/medium-zoom.js"></script>
<script src="/js/dismissable-banner.js"></script>
<script src="/js/scroll-nav-to-view-in-docs.js"></script><link rel="stylesheet" href="/assets/css/styles.4a5e1784.css">
<script src="/assets/js/runtime~main.d60bf69d.js" defer="defer"></script>
<script src="/assets/js/main.e8ab6fa3.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"dark")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo-black.svg" alt="Backstage Software Catalog and Developer Platform" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="Backstage Software Catalog and Developer Platform" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div></a><a href="https://github.com/backstage/backstage" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://discord.gg/backstage-687207715902193673" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a class="navbar__item navbar__link" href="/docs/overview/what-is-backstage">Docs</a><a class="navbar__item navbar__link" href="/plugins">Plugins</a><a class="navbar__item navbar__link" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/docs/releases/v1.41.0">Releases</a><a class="navbar__item navbar__link" href="/demos">Demos</a><a class="navbar__item navbar__link" href="/community">Community</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a aria-current="page" class="navbar__link active" aria-haspopup="true" aria-expanded="false" role="button" href="/docs/deployment/docker">Stable</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/next/deployment/docker">Next</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/docs/deployment/docker">Stable</a></li></ul></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently dark mode)" aria-label="Switch between dark and light mode (currently dark mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/overview/what-is-backstage">Overview</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/docs/getting-started/">Getting Started</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/getting-started/">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/getting-started/config/database">Configuring Backstage</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/docs/deployment/">Deploying Backstage</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/deployment/">Overview</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/deployment/scaling">Scaling</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/deployment/docker">Docker</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/deployment/k8s">Kubernetes</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/getting-started/logging-in">Using Backstage</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/overview/support">Support and community</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/getting-started/keeping-backstage-updated">Keeping Backstage Updated</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/auth/">Core Features</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/integrations/">Integrations</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/plugins/">Plugins</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/conf/">Configuration</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/backend-system/">Framework</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/overview/adopting">Tutorials</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/faq/">FAQ</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/contribute/">Contribute</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/dls/design">References</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_xLCN"><div class="docItemContainer_jfFK"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Getting Started</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Deploying Backstage</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Docker</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Building a Docker image</h1></header><div class="row"><div class="col col--12 markdown"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="summary">Summary<a href="#summary" class="hash-link" aria-label="Direct link to Summary" title="Direct link to Summary">​</a></h2>
<p>This section describes how to build a Backstage App into a deployable Docker image. It is split into three sections, first covering the host build approach, which is recommended due to its speed and more efficient and often simpler caching. The second section covers a full multi-stage Docker build, and the last section covers how to deploy the frontend and backend as separate images.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="prerequisites">Prerequisites<a href="#prerequisites" class="hash-link" aria-label="Direct link to Prerequisites" title="Direct link to Prerequisites">​</a></h2>
<p>This guide assumes your have a basic understanding of Docker and how it works. If you are new to Docker, you can start with the <a href="https://docs.docker.com/get-started/overview/" target="_blank" rel="noopener noreferrer">Docker overview</a> guide.</p>
<p>You&#x27;ll also want to complete the following prerequisites:</p>
<ol>
<li>Created an app following the <a href="/docs/getting-started/">Getting Started guide</a></li>
<li>Setup an auth provider, the <a href="/docs/getting-started/config/authentication">Authentication guide</a> is a good starting point for this, the default <a href="/docs/auth/guest/provider">Guest auth provider</a> is not intended for use in containerized environments</li>
<li>A Postgres database setup that you are able to connect to, the <a href="/docs/getting-started/config/database">Database guide</a> can help you with this</li>
</ol>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>Moving forward without addressing these prerequisites is very likely to cause undesirable results, the most common being not having a proper auth provider setup as the default <a href="/docs/auth/guest/provider">Guest auth provider</a> is not intended for use in containerized environments.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="host-build">Host Build<a href="#host-build" class="hash-link" aria-label="Direct link to Host Build" title="Direct link to Host Build">​</a></h2>
<p>This section describes how to build a Docker image from a Backstage repo with
most of the build happening outside of Docker. This is almost always the faster
approach, as the build steps tend to execute faster, and it&#x27;s possible to have
more efficient caching of dependencies on the host, where a single change won&#x27;t
bust the entire cache.</p>
<p>The required steps in the host build are to install dependencies with
<code>yarn install</code>, generate type definitions using <code>yarn tsc</code>, and build the backend
package with <code>yarn build:backend</code>.</p>
<p>In a CI workflow it might look something like this, from the root:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#232323"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#232323"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token function" style="color:rgb(220, 220, 170)">yarn</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">install</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(156, 220, 254)">--immutable</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># tsc outputs type definitions to dist-types/ in the repo root, which are then consumed by the build</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token function" style="color:rgb(220, 220, 170)">yarn</span><span class="token plain"> tsc</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Build the backend, which bundles it all up into the packages/backend/dist folder.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token function" style="color:rgb(220, 220, 170)">yarn</span><span class="token plain"> build:backend</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Once the host build is complete, we are ready to build our image. The following
<code>Dockerfile</code> is included when creating a new app with <code>@backstage/create-app</code>:</p>
<div class="language-dockerfile codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#232323"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-dockerfile codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#232323"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token instruction keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token instruction"> node:20-bookworm-slim</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Set Python interpreter for `node-gyp` to use</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(86, 156, 214)">ENV</span><span class="token instruction"> PYTHON=/usr/bin/python3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Install isolate-vm dependencies, these are needed by the @backstage/plugin-scaffolder-backend.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(86, 156, 214)">RUN</span><span class="token instruction"> </span><span class="token instruction options property">--mount</span><span class="token instruction options punctuation" style="color:rgb(212, 212, 212)">=</span><span class="token instruction options string" style="color:rgb(206, 145, 120)">type=cache,target=/var/cache/apt,sharing=locked</span><span class="token instruction options"> </span><span class="token instruction options operator" style="color:rgb(212, 212, 212)">\</span><span class="token instruction options"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token instruction options">    </span><span class="token instruction options property">--mount</span><span class="token instruction options punctuation" style="color:rgb(212, 212, 212)">=</span><span class="token instruction options string" style="color:rgb(206, 145, 120)">type=cache,target=/var/lib/apt,sharing=locked</span><span class="token instruction"> </span><span class="token instruction operator" style="color:rgb(212, 212, 212)">\</span><span class="token instruction"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token instruction">    apt-get update &amp;&amp; </span><span class="token instruction operator" style="color:rgb(212, 212, 212)">\</span><span class="token instruction"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token instruction">    apt-get install -y --no-install-recommends python3 g++ build-essential &amp;&amp; </span><span class="token instruction operator" style="color:rgb(212, 212, 212)">\</span><span class="token instruction"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token instruction">    rm -rf /var/lib/apt/lists/*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Install sqlite3 dependencies. You can skip this if you don&#x27;t use sqlite3 in the image,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># in which case you should also move better-sqlite3 to &quot;devDependencies&quot; in package.json.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(86, 156, 214)">RUN</span><span class="token instruction"> </span><span class="token instruction options property">--mount</span><span class="token instruction options punctuation" style="color:rgb(212, 212, 212)">=</span><span class="token instruction options string" style="color:rgb(206, 145, 120)">type=cache,target=/var/cache/apt,sharing=locked</span><span class="token instruction options"> </span><span class="token instruction options operator" style="color:rgb(212, 212, 212)">\</span><span class="token instruction options"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token instruction options">    </span><span class="token instruction options property">--mount</span><span class="token instruction options punctuation" style="color:rgb(212, 212, 212)">=</span><span class="token instruction options string" style="color:rgb(206, 145, 120)">type=cache,target=/var/lib/apt,sharing=locked</span><span class="token instruction"> </span><span class="token instruction operator" style="color:rgb(212, 212, 212)">\</span><span class="token instruction"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token instruction">    apt-get update &amp;&amp; </span><span class="token instruction operator" style="color:rgb(212, 212, 212)">\</span><span class="token instruction"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token instruction">    apt-get install -y --no-install-recommends libsqlite3-dev &amp;&amp; </span><span class="token instruction operator" style="color:rgb(212, 212, 212)">\</span><span class="token instruction"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token instruction">    rm -rf /var/lib/apt/lists/*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># From here on we use the least-privileged `node` user to run the backend.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(86, 156, 214)">USER</span><span class="token instruction"> node</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># This should create the app dir as `node`.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># If it is instead created as `root` then the `tar` command below will fail: `can&#x27;t create directory &#x27;packages/&#x27;: Permission denied`.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># If this occurs, then ensure BuildKit is enabled (`DOCKER_BUILDKIT=1`) so the app dir is correctly created as `node`.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(86, 156, 214)">WORKDIR</span><span class="token instruction"> /app</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Copy files needed by Yarn</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(86, 156, 214)">COPY</span><span class="token instruction"> </span><span class="token instruction options property">--chown</span><span class="token instruction options punctuation" style="color:rgb(212, 212, 212)">=</span><span class="token instruction options string" style="color:rgb(206, 145, 120)">node:node</span><span class="token instruction"> .yarn ./.yarn</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(86, 156, 214)">COPY</span><span class="token instruction"> </span><span class="token instruction options property">--chown</span><span class="token instruction options punctuation" style="color:rgb(212, 212, 212)">=</span><span class="token instruction options string" style="color:rgb(206, 145, 120)">node:node</span><span class="token instruction"> .yarnrc.yml ./</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(86, 156, 214)">COPY</span><span class="token instruction"> </span><span class="token instruction options property">--chown</span><span class="token instruction options punctuation" style="color:rgb(212, 212, 212)">=</span><span class="token instruction options string" style="color:rgb(206, 145, 120)">node:node</span><span class="token instruction"> backstage.json ./</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># This switches many Node.js dependencies to production mode.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(86, 156, 214)">ENV</span><span class="token instruction"> NODE_ENV=production</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># This disables node snapshot for Node 20 to work with the Scaffolder</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(86, 156, 214)">ENV</span><span class="token instruction"> NODE_OPTIONS=</span><span class="token instruction string" style="color:rgb(206, 145, 120)">&quot;--no-node-snapshot&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Copy repo skeleton first, to avoid unnecessary docker cache invalidation.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># The skeleton contains the package.json of each package in the monorepo,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># and along with yarn.lock and the root package.json, that&#x27;s enough to run yarn install.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(86, 156, 214)">COPY</span><span class="token instruction"> </span><span class="token instruction options property">--chown</span><span class="token instruction options punctuation" style="color:rgb(212, 212, 212)">=</span><span class="token instruction options string" style="color:rgb(206, 145, 120)">node:node</span><span class="token instruction"> yarn.lock package.json packages/backend/dist/skeleton.tar.gz ./</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(86, 156, 214)">RUN</span><span class="token instruction"> tar xzf skeleton.tar.gz &amp;&amp; rm skeleton.tar.gz</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(86, 156, 214)">RUN</span><span class="token instruction"> </span><span class="token instruction options property">--mount</span><span class="token instruction options punctuation" style="color:rgb(212, 212, 212)">=</span><span class="token instruction options string" style="color:rgb(206, 145, 120)">type=cache,target=/home/node/.cache/yarn,sharing=locked,uid=1000,gid=1000</span><span class="token instruction"> </span><span class="token instruction operator" style="color:rgb(212, 212, 212)">\</span><span class="token instruction"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token instruction">    yarn workspaces focus --all --production &amp;&amp; rm -rf </span><span class="token instruction string" style="color:rgb(206, 145, 120)">&quot;$(yarn cache clean)&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># This will include the examples, if you don&#x27;t need these simply remove this line</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(86, 156, 214)">COPY</span><span class="token instruction"> </span><span class="token instruction options property">--chown</span><span class="token instruction options punctuation" style="color:rgb(212, 212, 212)">=</span><span class="token instruction options string" style="color:rgb(206, 145, 120)">node:node</span><span class="token instruction"> examples ./examples</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Then copy the rest of the backend bundle, along with any other files we might want.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(86, 156, 214)">COPY</span><span class="token instruction"> </span><span class="token instruction options property">--chown</span><span class="token instruction options punctuation" style="color:rgb(212, 212, 212)">=</span><span class="token instruction options string" style="color:rgb(206, 145, 120)">node:node</span><span class="token instruction"> packages/backend/dist/bundle.tar.gz app-config*.yaml ./</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(86, 156, 214)">RUN</span><span class="token instruction"> tar xzf bundle.tar.gz &amp;&amp; rm bundle.tar.gz</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(86, 156, 214)">CMD</span><span class="token instruction"> [</span><span class="token instruction string" style="color:rgb(206, 145, 120)">&quot;node&quot;</span><span class="token instruction">, </span><span class="token instruction string" style="color:rgb(206, 145, 120)">&quot;packages/backend&quot;</span><span class="token instruction">, </span><span class="token instruction string" style="color:rgb(206, 145, 120)">&quot;--config&quot;</span><span class="token instruction">, </span><span class="token instruction string" style="color:rgb(206, 145, 120)">&quot;app-config.yaml&quot;</span><span class="token instruction">, </span><span class="token instruction string" style="color:rgb(206, 145, 120)">&quot;--config&quot;</span><span class="token instruction">, </span><span class="token instruction string" style="color:rgb(206, 145, 120)">&quot;app-config.production.yaml&quot;</span><span class="token instruction">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>For more details on how the <code>backend:bundle</code> command and the <code>skeleton.tar.gz</code>
file works, see the
<a href="/docs/tooling/cli/commands#backendbundle"><code>backend:bundle</code> command docs</a>.</p>
<p>The <code>Dockerfile</code> is located at <code>packages/backend/Dockerfile</code>, but needs to be
executed with the root of the repo as the build context, in order to get access
to the root <code>yarn.lock</code> and <code>package.json</code>, along with any other files that
might be needed, such as <code>.npmrc</code>.</p>
<p>The <code>@backstage/create-app</code> command adds the following <code>.dockerignore</code> in the
root of the repo to speed up the build by reducing build context size:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#232323"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#232323"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">.git</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">.yarn/cache</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">.yarn/install-state.gz</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">node_modules</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">packages/*/src</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">packages/*/node_modules</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">plugins</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">*.local.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>With the project built and the <code>.dockerignore</code> and <code>Dockerfile</code> in place, we are
now ready to build the final image. From the root of the repo, execute the
build:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#232323"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#232323"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token function" style="color:rgb(220, 220, 170)">docker</span><span class="token plain"> image build </span><span class="token builtin class-name" style="color:rgb(78, 201, 176)">.</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(156, 220, 254)">-f</span><span class="token plain"> packages/backend/Dockerfile </span><span class="token parameter variable" style="color:rgb(156, 220, 254)">--tag</span><span class="token plain"> backstage</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>To try out the image locally you can run the following:</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#232323"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#232323"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token function" style="color:rgb(220, 220, 170)">docker</span><span class="token plain"> run </span><span class="token parameter variable" style="color:rgb(156, 220, 254)">-it</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(156, 220, 254)">-p</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">7007</span><span class="token plain">:7007 backstage</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You should then start to get logs in your terminal, and then you can open your
browser at <code>http://localhost:7007</code></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="multi-stage-build">Multi-stage Build<a href="#multi-stage-build" class="hash-link" aria-label="Direct link to Multi-stage Build" title="Direct link to Multi-stage Build">​</a></h2>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>Note</div><div class="admonitionContent_BuS1"><p>The <code>.dockerignore</code> is different in this setup, read on for more
details.</p></div></div>
<p>This section describes how to set up a multi-stage Docker build that builds the
entire project within Docker. This is typically slower than a host build, but is
sometimes desired because Docker in Docker is not available in the build
environment, or due to other requirements.</p>
<p>The build is split into three different stages, where the first stage finds all
of the <code>package.json</code> files that are relevant for the initial install step
enabling us to cache the initial <code>yarn install</code> that installs all dependencies.
The second stage executes the build itself, and is similar to the steps we
execute on the host in the host build. The third and final stage then packages
it all together into the final image, and is similar to the <code>Dockerfile</code> of the
host build.</p>
<p>The following <code>Dockerfile</code> executes the multi-stage build and should be added to
the repo root:</p>
<div class="language-dockerfile codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#232323"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-dockerfile codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#232323"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"># Stage 1 - Create yarn install skeleton layer</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token instruction"> node:20-bookworm-slim </span><span class="token instruction keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token instruction"> packages</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(86, 156, 214)">WORKDIR</span><span class="token instruction"> /app</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(86, 156, 214)">COPY</span><span class="token instruction"> backstage.json package.json yarn.lock ./</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(86, 156, 214)">COPY</span><span class="token instruction"> .yarn ./.yarn</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(86, 156, 214)">COPY</span><span class="token instruction"> .yarnrc.yml ./</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(86, 156, 214)">COPY</span><span class="token instruction"> packages packages</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Comment this out if you don&#x27;t have any internal plugins</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(86, 156, 214)">COPY</span><span class="token instruction"> plugins plugins</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(86, 156, 214)">RUN</span><span class="token instruction"> find packages \! -name </span><span class="token instruction string" style="color:rgb(206, 145, 120)">&quot;package.json&quot;</span><span class="token instruction"> -mindepth 2 -maxdepth 2 -exec rm -rf {} \+</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Stage 2 - Install dependencies and build packages</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token instruction"> node:20-bookworm-slim </span><span class="token instruction keyword" style="color:rgb(86, 156, 214)">AS</span><span class="token instruction"> build</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Set Python interpreter for `node-gyp` to use</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(86, 156, 214)">ENV</span><span class="token instruction"> PYTHON=/usr/bin/python3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Install isolate-vm dependencies, these are needed by the @backstage/plugin-scaffolder-backend.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(86, 156, 214)">RUN</span><span class="token instruction"> </span><span class="token instruction options property">--mount</span><span class="token instruction options punctuation" style="color:rgb(212, 212, 212)">=</span><span class="token instruction options string" style="color:rgb(206, 145, 120)">type=cache,target=/var/cache/apt,sharing=locked</span><span class="token instruction options"> </span><span class="token instruction options operator" style="color:rgb(212, 212, 212)">\</span><span class="token instruction options"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token instruction options">    </span><span class="token instruction options property">--mount</span><span class="token instruction options punctuation" style="color:rgb(212, 212, 212)">=</span><span class="token instruction options string" style="color:rgb(206, 145, 120)">type=cache,target=/var/lib/apt,sharing=locked</span><span class="token instruction"> </span><span class="token instruction operator" style="color:rgb(212, 212, 212)">\</span><span class="token instruction"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token instruction">    apt-get update &amp;&amp; </span><span class="token instruction operator" style="color:rgb(212, 212, 212)">\</span><span class="token instruction"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token instruction">    apt-get install -y --no-install-recommends python3 g++ build-essential &amp;&amp; </span><span class="token instruction operator" style="color:rgb(212, 212, 212)">\</span><span class="token instruction"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token instruction">    rm -rf /var/lib/apt/lists/*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Install sqlite3 dependencies. You can skip this if you don&#x27;t use sqlite3 in the image,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># in which case you should also move better-sqlite3 to &quot;devDependencies&quot; in package.json.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(86, 156, 214)">RUN</span><span class="token instruction"> </span><span class="token instruction options property">--mount</span><span class="token instruction options punctuation" style="color:rgb(212, 212, 212)">=</span><span class="token instruction options string" style="color:rgb(206, 145, 120)">type=cache,target=/var/cache/apt,sharing=locked</span><span class="token instruction options"> </span><span class="token instruction options operator" style="color:rgb(212, 212, 212)">\</span><span class="token instruction options"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token instruction options">    </span><span class="token instruction options property">--mount</span><span class="token instruction options punctuation" style="color:rgb(212, 212, 212)">=</span><span class="token instruction options string" style="color:rgb(206, 145, 120)">type=cache,target=/var/lib/apt,sharing=locked</span><span class="token instruction"> </span><span class="token instruction operator" style="color:rgb(212, 212, 212)">\</span><span class="token instruction"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token instruction">    apt-get update &amp;&amp; </span><span class="token instruction operator" style="color:rgb(212, 212, 212)">\</span><span class="token instruction"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token instruction">    apt-get install -y --no-install-recommends libsqlite3-dev &amp;&amp; </span><span class="token instruction operator" style="color:rgb(212, 212, 212)">\</span><span class="token instruction"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token instruction">    rm -rf /var/lib/apt/lists/*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(86, 156, 214)">USER</span><span class="token instruction"> node</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(86, 156, 214)">WORKDIR</span><span class="token instruction"> /app</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(86, 156, 214)">COPY</span><span class="token instruction"> </span><span class="token instruction options property">--from</span><span class="token instruction options punctuation" style="color:rgb(212, 212, 212)">=</span><span class="token instruction options string" style="color:rgb(206, 145, 120)">packages</span><span class="token instruction options"> </span><span class="token instruction options property">--chown</span><span class="token instruction options punctuation" style="color:rgb(212, 212, 212)">=</span><span class="token instruction options string" style="color:rgb(206, 145, 120)">node:node</span><span class="token instruction"> /app .</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(86, 156, 214)">RUN</span><span class="token instruction"> </span><span class="token instruction options property">--mount</span><span class="token instruction options punctuation" style="color:rgb(212, 212, 212)">=</span><span class="token instruction options string" style="color:rgb(206, 145, 120)">type=cache,target=/home/node/.cache/yarn,sharing=locked,uid=1000,gid=1000</span><span class="token instruction"> </span><span class="token instruction operator" style="color:rgb(212, 212, 212)">\</span><span class="token instruction"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token instruction">    yarn install --immutable</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(86, 156, 214)">COPY</span><span class="token instruction"> </span><span class="token instruction options property">--chown</span><span class="token instruction options punctuation" style="color:rgb(212, 212, 212)">=</span><span class="token instruction options string" style="color:rgb(206, 145, 120)">node:node</span><span class="token instruction"> . .</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(86, 156, 214)">RUN</span><span class="token instruction"> yarn tsc</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(86, 156, 214)">RUN</span><span class="token instruction"> yarn --cwd packages/backend build</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(86, 156, 214)">RUN</span><span class="token instruction"> mkdir packages/backend/dist/skeleton packages/backend/dist/bundle </span><span class="token instruction operator" style="color:rgb(212, 212, 212)">\</span><span class="token instruction"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token instruction">    &amp;&amp; tar xzf packages/backend/dist/skeleton.tar.gz -C packages/backend/dist/skeleton </span><span class="token instruction operator" style="color:rgb(212, 212, 212)">\</span><span class="token instruction"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token instruction">    &amp;&amp; tar xzf packages/backend/dist/bundle.tar.gz -C packages/backend/dist/bundle</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Stage 3 - Build the actual backend image and install production dependencies</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(86, 156, 214)">FROM</span><span class="token instruction"> node:20-bookworm-slim</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Set Python interpreter for `node-gyp` to use</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(86, 156, 214)">ENV</span><span class="token instruction"> PYTHON=/usr/bin/python3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Install isolate-vm dependencies, these are needed by the @backstage/plugin-scaffolder-backend.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(86, 156, 214)">RUN</span><span class="token instruction"> </span><span class="token instruction options property">--mount</span><span class="token instruction options punctuation" style="color:rgb(212, 212, 212)">=</span><span class="token instruction options string" style="color:rgb(206, 145, 120)">type=cache,target=/var/cache/apt,sharing=locked</span><span class="token instruction options"> </span><span class="token instruction options operator" style="color:rgb(212, 212, 212)">\</span><span class="token instruction options"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token instruction options">    </span><span class="token instruction options property">--mount</span><span class="token instruction options punctuation" style="color:rgb(212, 212, 212)">=</span><span class="token instruction options string" style="color:rgb(206, 145, 120)">type=cache,target=/var/lib/apt,sharing=locked</span><span class="token instruction"> </span><span class="token instruction operator" style="color:rgb(212, 212, 212)">\</span><span class="token instruction"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token instruction">    apt-get update &amp;&amp; </span><span class="token instruction operator" style="color:rgb(212, 212, 212)">\</span><span class="token instruction"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token instruction">    apt-get install -y --no-install-recommends python3 g++ build-essential &amp;&amp; </span><span class="token instruction operator" style="color:rgb(212, 212, 212)">\</span><span class="token instruction"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token instruction">    rm -rf /var/lib/apt/lists/*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Install sqlite3 dependencies. You can skip this if you don&#x27;t use sqlite3 in the image,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># in which case you should also move better-sqlite3 to &quot;devDependencies&quot; in package.json.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(86, 156, 214)">RUN</span><span class="token instruction"> </span><span class="token instruction options property">--mount</span><span class="token instruction options punctuation" style="color:rgb(212, 212, 212)">=</span><span class="token instruction options string" style="color:rgb(206, 145, 120)">type=cache,target=/var/cache/apt,sharing=locked</span><span class="token instruction options"> </span><span class="token instruction options operator" style="color:rgb(212, 212, 212)">\</span><span class="token instruction options"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token instruction options">    </span><span class="token instruction options property">--mount</span><span class="token instruction options punctuation" style="color:rgb(212, 212, 212)">=</span><span class="token instruction options string" style="color:rgb(206, 145, 120)">type=cache,target=/var/lib/apt,sharing=locked</span><span class="token instruction"> </span><span class="token instruction operator" style="color:rgb(212, 212, 212)">\</span><span class="token instruction"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token instruction">    apt-get update &amp;&amp; </span><span class="token instruction operator" style="color:rgb(212, 212, 212)">\</span><span class="token instruction"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token instruction">    apt-get install -y --no-install-recommends libsqlite3-dev &amp;&amp; </span><span class="token instruction operator" style="color:rgb(212, 212, 212)">\</span><span class="token instruction"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token instruction">    rm -rf /var/lib/apt/lists/*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># From here on we use the least-privileged `node` user to run the backend.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(86, 156, 214)">USER</span><span class="token instruction"> node</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># This should create the app dir as `node`.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># If it is instead created as `root` then the `tar` command below will</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># fail: `can&#x27;t create directory &#x27;packages/&#x27;: Permission denied`.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># If this occurs, then ensure BuildKit is enabled (`DOCKER_BUILDKIT=1`)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># so the app dir is correctly created as `node`.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(86, 156, 214)">WORKDIR</span><span class="token instruction"> /app</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Copy the install dependencies from the build stage and context</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(86, 156, 214)">COPY</span><span class="token instruction"> </span><span class="token instruction options property">--from</span><span class="token instruction options punctuation" style="color:rgb(212, 212, 212)">=</span><span class="token instruction options string" style="color:rgb(206, 145, 120)">build</span><span class="token instruction options"> </span><span class="token instruction options property">--chown</span><span class="token instruction options punctuation" style="color:rgb(212, 212, 212)">=</span><span class="token instruction options string" style="color:rgb(206, 145, 120)">node:node</span><span class="token instruction"> /app/.yarn ./.yarn</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(86, 156, 214)">COPY</span><span class="token instruction"> </span><span class="token instruction options property">--from</span><span class="token instruction options punctuation" style="color:rgb(212, 212, 212)">=</span><span class="token instruction options string" style="color:rgb(206, 145, 120)">build</span><span class="token instruction options"> </span><span class="token instruction options property">--chown</span><span class="token instruction options punctuation" style="color:rgb(212, 212, 212)">=</span><span class="token instruction options string" style="color:rgb(206, 145, 120)">node:node</span><span class="token instruction"> /app/.yarnrc.yml  ./</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(86, 156, 214)">COPY</span><span class="token instruction"> </span><span class="token instruction options property">--from</span><span class="token instruction options punctuation" style="color:rgb(212, 212, 212)">=</span><span class="token instruction options string" style="color:rgb(206, 145, 120)">build</span><span class="token instruction options"> </span><span class="token instruction options property">--chown</span><span class="token instruction options punctuation" style="color:rgb(212, 212, 212)">=</span><span class="token instruction options string" style="color:rgb(206, 145, 120)">node:node</span><span class="token instruction"> /app/backstage.json ./</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(86, 156, 214)">COPY</span><span class="token instruction"> </span><span class="token instruction options property">--from</span><span class="token instruction options punctuation" style="color:rgb(212, 212, 212)">=</span><span class="token instruction options string" style="color:rgb(206, 145, 120)">build</span><span class="token instruction options"> </span><span class="token instruction options property">--chown</span><span class="token instruction options punctuation" style="color:rgb(212, 212, 212)">=</span><span class="token instruction options string" style="color:rgb(206, 145, 120)">node:node</span><span class="token instruction"> /app/yarn.lock /app/package.json /app/packages/backend/dist/skeleton/ ./</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Note: The skeleton bundle only includes package.json files -- if your app has</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># plugins that define a `bin` export, the bin files need to be copied as well to</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># be linked in node_modules/.bin during yarn install.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(86, 156, 214)">RUN</span><span class="token instruction"> </span><span class="token instruction options property">--mount</span><span class="token instruction options punctuation" style="color:rgb(212, 212, 212)">=</span><span class="token instruction options string" style="color:rgb(206, 145, 120)">type=cache,target=/home/node/.cache/yarn,sharing=locked,uid=1000,gid=1000</span><span class="token instruction"> </span><span class="token instruction operator" style="color:rgb(212, 212, 212)">\</span><span class="token instruction"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token instruction">    yarn workspaces focus --all --production &amp;&amp; rm -rf </span><span class="token instruction string" style="color:rgb(206, 145, 120)">&quot;$(yarn cache clean)&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Copy the built packages from the build stage</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(86, 156, 214)">COPY</span><span class="token instruction"> </span><span class="token instruction options property">--from</span><span class="token instruction options punctuation" style="color:rgb(212, 212, 212)">=</span><span class="token instruction options string" style="color:rgb(206, 145, 120)">build</span><span class="token instruction options"> </span><span class="token instruction options property">--chown</span><span class="token instruction options punctuation" style="color:rgb(212, 212, 212)">=</span><span class="token instruction options string" style="color:rgb(206, 145, 120)">node:node</span><span class="token instruction"> /app/packages/backend/dist/bundle/ ./</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Copy any other files that we need at runtime</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(86, 156, 214)">COPY</span><span class="token instruction"> </span><span class="token instruction options property">--chown</span><span class="token instruction options punctuation" style="color:rgb(212, 212, 212)">=</span><span class="token instruction options string" style="color:rgb(206, 145, 120)">node:node</span><span class="token instruction"> app-config*.yaml ./</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># This will include the examples, if you don&#x27;t need these simply remove this line</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(86, 156, 214)">COPY</span><span class="token instruction"> </span><span class="token instruction options property">--chown</span><span class="token instruction options punctuation" style="color:rgb(212, 212, 212)">=</span><span class="token instruction options string" style="color:rgb(206, 145, 120)">node:node</span><span class="token instruction"> examples ./examples</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># This switches many Node.js dependencies to production mode.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(86, 156, 214)">ENV</span><span class="token instruction"> NODE_ENV=production</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># This disables node snapshot for Node 20 to work with the Scaffolder</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(86, 156, 214)">ENV</span><span class="token instruction"> NODE_OPTIONS=</span><span class="token instruction string" style="color:rgb(206, 145, 120)">&quot;--no-node-snapshot&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(86, 156, 214)">CMD</span><span class="token instruction"> [</span><span class="token instruction string" style="color:rgb(206, 145, 120)">&quot;node&quot;</span><span class="token instruction">, </span><span class="token instruction string" style="color:rgb(206, 145, 120)">&quot;packages/backend&quot;</span><span class="token instruction">, </span><span class="token instruction string" style="color:rgb(206, 145, 120)">&quot;--config&quot;</span><span class="token instruction">, </span><span class="token instruction string" style="color:rgb(206, 145, 120)">&quot;app-config.yaml&quot;</span><span class="token instruction">, </span><span class="token instruction string" style="color:rgb(206, 145, 120)">&quot;--config&quot;</span><span class="token instruction">, </span><span class="token instruction string" style="color:rgb(206, 145, 120)">&quot;app-config.production.yaml&quot;</span><span class="token instruction">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Note that a newly created Backstage app will typically not have a <code>plugins/</code>
folder, so you will want to comment that line out. This build also does not work
in the main repo, since the <code>backstage-cli</code> which is used for the build doesn&#x27;t
end up being properly installed.</p>
<p>To speed up the build when not running in a fresh clone of the repo you should
set up a <code>.dockerignore</code>. This one is different than the host build one, because
we want to have access to the source code of all packages for the build. We can
however ignore any existing build output or dependencies on the host. For our
new <code>.dockerignore</code>, replace the contents of your existing one with this:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#232323"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#232323"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">dist-types</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">node_modules</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">packages/*/dist</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">packages/*/node_modules</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">plugins/*/dist</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">plugins/*/node_modules</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">*.local.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Once you have added both the <code>Dockerfile</code> and <code>.dockerignore</code> to the root of
your project, run the following to build the container under a specified tag.</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#232323"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#232323"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token function" style="color:rgb(220, 220, 170)">docker</span><span class="token plain"> image build </span><span class="token parameter variable" style="color:rgb(156, 220, 254)">-t</span><span class="token plain"> backstage </span><span class="token builtin class-name" style="color:rgb(78, 201, 176)">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>To try out the image locally you can run the following:</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#232323"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#232323"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token function" style="color:rgb(220, 220, 170)">docker</span><span class="token plain"> run </span><span class="token parameter variable" style="color:rgb(156, 220, 254)">-it</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(156, 220, 254)">-p</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">7007</span><span class="token plain">:7007 backstage</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You should then start to get logs in your terminal, and then you can open your
browser at <code>http://localhost:7007</code></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="separate-frontend">Separate Frontend<a href="#separate-frontend" class="hash-link" aria-label="Direct link to Separate Frontend" title="Direct link to Separate Frontend">​</a></h2>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>Note</div><div class="admonitionContent_BuS1"><p>This is an optional step, and you will lose out on the features of the
<code>@backstage/plugin-app-backend</code> plugin. Most notably the frontend configuration
will no longer be injected by the backend, you will instead need to use the
correct configuration when building the frontend bundle.</p></div></div>
<p>It is sometimes desirable to serve the frontend separately from the backend,
either from a separate image or for example a static file serving provider. The
first step in doing so is to remove the <code>app-backend</code> plugin from the backend
package, which is done as follows:</p>
<ol>
<li>
<p>Delete <code>packages/backend/src/plugins/app.ts</code></p>
</li>
<li>
<p>Remove the following line from <code>packages/backend/src/index.ts</code>:</p>
<div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#232323"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#232323"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">backend</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">add</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;@backstage/plugin-app-backend&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>Remove the <code>@backstage/plugin-app-backend</code> and the app package dependency
(e.g. <code>app</code>) from <code>packages/backend/package.json</code>. If you don&#x27;t remove the
app package dependency the app will still be built and bundled with the
backend.</p>
</li>
</ol>
<p>Once the <code>app-backend</code> is removed from the backend, you can use your favorite
static file serving method for serving the frontend. An example of how to set up
an NGINX image is available in the
<a href="https://github.com/backstage/backstage/blob/master/contrib/docker/frontend-with-nginx" target="_blank" rel="noopener noreferrer">contrib folder in the main repo</a></p>
<p>Note that if you&#x27;re building a separate docker build of the frontend you
probably need to adjust <code>.dockerignore</code> appropriately. Most likely by making
sure <code>packages/app/dist</code> is not ignored.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="troubleshooting-tips">Troubleshooting Tips<a href="#troubleshooting-tips" class="hash-link" aria-label="Direct link to Troubleshooting Tips" title="Direct link to Troubleshooting Tips">​</a></h2>
<p>When building Docker images you may run into problems from time to time, there are two handy flags you can use to help:</p>
<ul>
<li><code>--progress=plain</code>: this will give you a more verbose output and not fold the logs into sections. This is very useful when have an error but it just shows you the last command and possibly an exit code. Using this flag you are more likely to see where the error actually is.</li>
<li><code>--no-cache</code>: this will rebuild all the layers every time. This is helpful when you want to be sure that it&#x27;s building from scratch.</li>
</ul>
<p>Here&#x27;s an example of these flags in use:</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#232323"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#232323"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token function" style="color:rgb(220, 220, 170)">docker</span><span class="token plain"> image build </span><span class="token builtin class-name" style="color:rgb(78, 201, 176)">.</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(156, 220, 254)">-f</span><span class="token plain"> packages/backend/Dockerfile </span><span class="token parameter variable" style="color:rgb(156, 220, 254)">--tag</span><span class="token plain"> backstage </span><span class="token parameter variable" style="color:rgb(156, 220, 254)">--progress</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">plain --no-cache</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="community-contributed-dockerfile-alternatives">Community Contributed Dockerfile Alternatives<a href="#community-contributed-dockerfile-alternatives" class="hash-link" aria-label="Direct link to Community Contributed Dockerfile Alternatives" title="Direct link to Community Contributed Dockerfile Alternatives">​</a></h2>
<p>The <code>Dockerfile</code> mentioned above located in <code>packages/backend</code> is maintained by the maintainers of Backstage, however there are also community contributed Dockerfile alternatives located in <code>contrib/docker</code>. The <code>Dockerfile</code>s in <code>contrib/docker</code> are not maintained by the maintainers of Backstage and are not necessarily updated when the <code>Dockerfile</code> located in <code>packages/backend</code> is updated.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="minimal-hardened-image">Minimal Hardened Image<a href="#minimal-hardened-image" class="hash-link" aria-label="Direct link to Minimal Hardened Image" title="Direct link to Minimal Hardened Image">​</a></h3>
<p>A contributed <code>Dockerfile</code> exists within the directory of <code>contrib/docker/minimal-hardened-image</code> which uses the <a href="https://github.com/wolfi-dev" target="_blank" rel="noopener noreferrer"><code>wolfi-base</code></a> image to reduce vulnerabilities. When this was contributed, this alternative <code>Dockerfile</code> reduced 98.2% of vulnerabilities in the built Backstage docker image when compared with the image built from <code>packages/backend/Dockerfile</code>.</p>
<p>To reduce maintenance, the digest of the image has been removed from the <code>contrib/docker/minimal-hardened-image/Dockerfile</code> file. A complete example with the digest would be <code>cgr.dev/chainguard/wolfi-base:latest@sha256:3d6dece13cdb5546cd03b20e14f9af354bc1a56ab5a7b47dca3e6c1557211fcf</code> and it is suggested to update the <code>FROM</code> line in the <code>Dockerfile</code> to use a digest. Please do a docker pull on the image to get the latest digest. Using the digest allows tools such as Dependabot or Renovate to know exactly which image digest is being utilized and allows for Pull Requests to be triggered when a new digest is available.</p>
<p>It is suggested to setup Dependabot/Renovate or a similar tool to ensure the image is kept up to date so that vulnerability fixes that have been addressed are pulled in frequently.</p></div></div></div><div class="row"><div class="col col--12"><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/backstage/backstage/edit/master/docs/deployment/docker.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></div></div></article><div class="row"><div class="col col--12"><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/deployment/scaling"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Scaling</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/deployment/k8s"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Kubernetes</div></a></nav></div></div></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#summary" class="table-of-contents__link toc-highlight">Summary</a></li><li><a href="#prerequisites" class="table-of-contents__link toc-highlight">Prerequisites</a></li><li><a href="#host-build" class="table-of-contents__link toc-highlight">Host Build</a></li><li><a href="#multi-stage-build" class="table-of-contents__link toc-highlight">Multi-stage Build</a></li><li><a href="#separate-frontend" class="table-of-contents__link toc-highlight">Separate Frontend</a></li><li><a href="#troubleshooting-tips" class="table-of-contents__link toc-highlight">Troubleshooting Tips</a></li><li><a href="#community-contributed-dockerfile-alternatives" class="table-of-contents__link toc-highlight">Community Contributed Dockerfile Alternatives</a><ul><li><a href="#minimal-hardened-image" class="table-of-contents__link toc-highlight">Minimal Hardened Image</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title"></div><ul class="footer__items clean-list"><li class="footer__item">
                <a href="/" aria-label="Backstage Home">
                  <div class="footerLogo"></div>
                </a></li></ul></div><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/overview/what-is-backstage">What is Backstage?</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/getting-started/">Getting started</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/features/software-catalog/">Software Catalog</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/plugins/create-a-plugin">Create a Plugin</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/dls/design">Designing for Backstage</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://discord.gg/backstage-687207715902193673" target="_blank" rel="noopener noreferrer" class="footer__link-item">Support chatroom</a></li><li class="footer__item"><a href="https://github.com/backstage/backstage/blob/master/CONTRIBUTING.md" target="_blank" rel="noopener noreferrer" class="footer__link-item">Contributing</a></li><li class="footer__item"><a href="https://backstage.io/docs/getting-started/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Adopting</a></li><li class="footer__item"><a href="https://info.backstage.spotify.com/newsletter_subscribe" target="_blank" rel="noopener noreferrer" class="footer__link-item">Subscribe to our newsletter</a></li><li class="footer__item"><a href="https://www.cncf.io/projects/" target="_blank" rel="noopener noreferrer" class="footer__link-item">CNCF Incubation</a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/backstage/" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li><li class="footer__item"><a href="https://github.com/cncf/artwork/tree/main/projects/backstage" target="_blank" rel="noopener noreferrer" class="footer__link-item">Assets</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright"><p style="text-align:center"><a href="https://spotify.github.io/">Made with ❤️ at Spotify</a></p><p class="copyright">Copyright © 2025 Backstage Project Authors. All rights reserved. The Linux Foundation has registered trademarks and uses trademarks. For a list of trademarks of The Linux Foundation, please see our Trademark Usage page: <a href="https://www.linuxfoundation.org/trademark-usage">https://www.linuxfoundation.org/trademark-usage</p></div></div></div></footer></div>
<script type="module" src="https://cdn.jsdelivr.net/npm/pushfeedback@latest/dist/pushfeedback/pushfeedback.esm.js"></script>
<script>const feedbackButton=document.createElement("feedback-button");feedbackButton.setAttribute("project","q8w1i6cair"),feedbackButton.setAttribute("modal-position","bottom-right"),feedbackButton.setAttribute("button-style","dark"),feedbackButton.setAttribute("button-position","bottom-right"),feedbackButton.setAttribute("hide-icon","true"),feedbackButton.setAttribute("custom-font","true"),feedbackButton.setAttribute("rating-mode","stars"),feedbackButton.setAttribute("id","default"),feedbackButton.textContent="Feedback",document.body.appendChild(feedbackButton)</script></body>
</html>