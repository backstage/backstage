import{a as k}from"./lodash-DGzVoyEp.js";import{aR as I,aS as M,aT as m}from"./iframe-DA79yDb5.js";import{s as h,p as B,D as O}from"./ref-C0VTUPuL.js";import{c as j}from"./api-HfqloE_f.js";import{a as T}from"./appWrappers-n6jVhqF6.js";const p=Symbol.for("CATALOG_FILTER_EXISTS_0e15b590c0b343a2bae3e787e84c2111"),V=500,N=["attachments","relations","status","metadata.name","metadata.namespace","metadata.uid","metadata.etag"];function $(t){const e=[];function o(n,a){if(!N.includes(n)){if(a==null||["string","number","boolean"].includes(typeof a)){e.push({key:n,value:a});return}if(typeof a=="object"){if(Array.isArray(a)){for(const i of a)if(o(n,i),typeof i=="string"){const r=`${n}.${i}`;e.some(s=>s.key.toLocaleLowerCase("en-US")===r.toLocaleLowerCase("en-US"))||e.push({key:r,value:!0})}return}for(const[i,r]of Object.entries(a))o(n?`${n}.${i}`:i,r)}}}return o("",t),e}function A(t){return btoa(JSON.stringify(t))}function U(t){return JSON.parse(atob(t))}const S="\0CATALOG_FILTER_EXISTS";function z(t){return t===p?S:Array.isArray(t)?t.map(e=>e===p?S:e):t}function x(t){return t===S?p:Array.isArray(t)?t.map(e=>e===S?p:e):t}function X(t){if(t)return[t].flat().map(e=>Object.fromEntries(Object.entries(e).map(([o,n])=>[o,z(n)])))}function D(t){if(t)return t.map(e=>Object.fromEntries(Object.entries(e).map(([o,n])=>[o,x(n)])))}function v(t){const e=$(t);t.metadata?.name&&e.push({key:"metadata.name",value:t.metadata.name.toLocaleLowerCase("en-US")}),t.metadata?.namespace&&e.push({key:"metadata.namespace",value:t.metadata.namespace.toLocaleLowerCase("en-US")}),t.metadata?.uid&&e.push({key:"metadata.uid",value:t.metadata.uid.toLocaleLowerCase("en-US")}),t.metadata.namespace||e.push({key:"metadata.namespace",value:O});for(const o of t.relations??[])e.push({key:`relations.${o.type.toLocaleLowerCase("en-US")}`,value:o.targetRef.toLocaleLowerCase("en-US")});return e}function E(t){if(!t)return()=>!0;const e=[t].flat();return o=>{const n=v(o);return e.some(a=>{for(const[i,r]of Object.entries(a)){const s=n.filter(f=>f.key===i.toLocaleLowerCase("en-US")).map(f=>f.value?.toString().toLocaleLowerCase("en-US"));if(s.length===0)return!1;if(r!==p){if(Array.isArray(r))return r.some(f=>s?.includes(String(f).toLocaleLowerCase("en-US")));if(!s?.includes(String(r).toLocaleLowerCase("en-US")))return!1}}return!0})}}function G(t,e){return e.split(".").reduce(([o,n],a,i,r)=>k.hasIn(n,a)?[o.concat(a),n[a]]:r[i+1]!==void 0?(r[i+1]=`${a}.${r[i+1]}`,[o,n]):[o,void 0],[[],t])}function g(t,e){if(!e?.length)return t;const o={};for(const n of e){const[a,i]=G(t,n);i!==void 0&&k.set(o,a,i)}return o}function _(t,e){if(!e)return t;const o=[e].flat();if(o.length===0)return t;const n=new Map;for(const a of t)n.set(a,v(a));return[...t].sort((a,i)=>{const r=n.get(a),s=n.get(i);for(const{field:d,order:l}of o){const y=d.toLocaleLowerCase("en-US"),c=r.find(R=>R.key.toLocaleLowerCase("en-US")===y),C=s.find(R=>R.key.toLocaleLowerCase("en-US")===y),L=c?.value!==null&&c?.value!==void 0?String(c.value).toLocaleLowerCase("en-US"):null,w=C?.value!==null&&C?.value!==void 0?String(C.value).toLocaleLowerCase("en-US"):null;if(!(L===null&&w===null)){if(L===null)return 1;if(w===null)return-1;if(L<w)return l==="asc"?-1:1;if(L>w)return l==="asc"?1:-1}}const f=h(a),u=h(i);return f<u?-1:f>u?1:0})}function J(t,e){if(!e?.term?.trim())return t;const o=e.term.trim().toLocaleLowerCase("en-US"),n=e.fields?.map(a=>a.toLocaleLowerCase("en-US"));return t.filter(a=>v(a).some(r=>n?.length&&!n.includes(r.key.toLocaleLowerCase("en-US"))||r.value===null||r.value===void 0?!1:String(r.value).toLocaleLowerCase("en-US").includes(o)))}class b{#e;constructor(e){this.#e=e?.entities?.slice()??[]}async getEntities(e){const o=E(e?.filter);let n=this.#e.filter(o);n=_(n,e?.order);let a=e?.offset??0,i=e?.limit;if(e?.after)try{const r=U(e.after);r.offset!==void 0&&(a=r.offset),r.limit!==void 0&&(i=r.limit)}catch{throw new I("Invalid cursor")}return a>0&&(n=n.slice(a)),i!==void 0&&(n=n.slice(0,i)),{items:e?.fields?n.map(r=>g(r,e.fields)):n}}async getEntitiesByRefs(e){const o=E(e.filter),n=this.#t(),a=e.entityRefs.map(i=>n.get(i)).map(i=>i&&o(i)?i:void 0);return{items:e.fields?a.map(i=>i?g(i,e.fields):void 0):a}}async queryEntities(e){let o,n,a,i,r;if(e&&"cursor"in e){let c;try{c=U(e.cursor)}catch{throw new I("Invalid cursor")}o=D(c.filter),n=c.orderFields,a=c.fullTextFilter,i=c.offset,r=e.limit}else o=e?.filter,n=e?.orderFields,a=e?.fullTextFilter,i=e?.offset??0,r=e?.limit;let s=this.#e.filter(E(o));if(a){const c=n?[n].flat():[];s=J(s,{...a,fields:a.fields??[c[0]?.field??"metadata.uid"]})}s=_(s,n);const f=s.length;if(r===void 0&&i===0)return{items:e?.fields?s.map(c=>g(c,e?.fields)):s,pageInfo:{},totalItems:f};const u=r??f,d=s.slice(i,i+u),l={filter:X(o),orderFields:n,fullTextFilter:a,totalItems:f},y={};return i+u<f&&(y.nextCursor=A({...l,offset:i+u})),i>0&&(y.prevCursor=A({...l,offset:Math.max(0,i-u)})),{items:e?.fields?d.map(c=>g(c,e?.fields)):d,totalItems:f,pageInfo:y}}async getEntityAncestors(e){const o=this.#t().get(e.entityRef);if(!o)throw new M(`Entity with ref ${e.entityRef} not found`);return{items:[{entity:o,parentEntityRefs:[]}],rootEntityRef:e.entityRef}}async getEntityByRef(e){return this.#t().get(h(B(e)))}async removeEntityByUid(e){const o=this.#e.findIndex(n=>n.metadata.uid===e);o!==-1&&this.#e.splice(o,1)}async refreshEntity(e){}async getEntityFacets(e){const o=E(e.filter),n=this.#e.filter(o);return{facets:Object.fromEntries(e.facets.map(i=>{const r=new Map;for(const f of n){const u=v(f),d=new Set(u.filter(l=>l.key.toLocaleLowerCase("en-US")===i.toLocaleLowerCase("en-US")).map(l=>l.value).filter(l=>l!=null).map(l=>String(l)));for(const l of d)r.set(l,(r.get(l)??0)+1)}const s=Array.from(r.entries()).map(([f,u])=>({value:f,count:u}));return[i,s]}))}}async getLocations(e){throw new m("Method not implemented.")}async getLocationById(e){throw new m("Method not implemented.")}async getLocationByRef(e){throw new m("Method not implemented.")}async addLocation(e){throw new m("Method not implemented.")}async removeLocationById(e){throw new m("Method not implemented.")}async getLocationByEntity(e){throw new m("Method not implemented.")}async validateEntity(e,o){throw new m("Method not implemented.")}async analyzeLocation(e){throw new m("Method not implemented.")}async*streamEntities(e){let o;const n=e?.pageSize??V;do{const a=await this.queryEntities(o?{...e,limit:n,cursor:o}:{...e,limit:n});yield a.items,o=a.pageInfo.nextCursor}while(o)}#t(){return new Map(this.#e.map(e=>[h(e),e]))}}function K(t,e){return o=>{const n=e();if(o)for(const[a,i]of Object.entries(o))typeof i=="function"?n[a].mockImplementation(i):n[a]=i;return Object.assign(n,{factory:T({api:t,deps:{},factory:()=>n})})}}function F(t){return new b(t)}(t=>{t.factory=e=>T({api:j,deps:{},factory:()=>new b(e)}),t.mock=K(j,()=>({getEntities:jest.fn(),getEntitiesByRefs:jest.fn(),queryEntities:jest.fn(),getEntityAncestors:jest.fn(),getEntityByRef:jest.fn(),removeEntityByUid:jest.fn(),refreshEntity:jest.fn(),getEntityFacets:jest.fn(),getLocations:jest.fn(),getLocationById:jest.fn(),getLocationByRef:jest.fn(),addLocation:jest.fn(),removeLocationById:jest.fn(),getLocationByEntity:jest.fn(),validateEntity:jest.fn(),analyzeLocation:jest.fn(),streamEntities:jest.fn(),streamEntityPages:jest.fn()}))})(F||(F={}));export{F as c};
