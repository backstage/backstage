var p=Object.defineProperty;var b=(s,e,r)=>e in s?p(s,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):s[e]=r;var a=(s,e,r)=>b(s,typeof e!="symbol"?e+"":e,r);import{c as l}from"./ApiRef-CqkoWjZn.js";import{r as u}from"./index-CTjT7uj6.js";import{O as m}from"./index-CFaqwFgm.js";const v=l({id:"core.storage"});var d=typeof window<"u",g=d?u.useLayoutEffect:u.useEffect;function C(s,e){var r=u.useState(e),t=r[0],o=r[1];return g(function(){var h=s.subscribe(o);return function(){return h.unsubscribe()}},[s]),t}const c=new Map,i=class i{constructor(e,r){a(this,"subscribers",new Set);a(this,"observable",new m(e=>(this.subscribers.add(e),()=>{this.subscribers.delete(e)})));this.namespace=e,this.errorApi=r}static create(e){return new i(e.namespace??"",e.errorApi)}static addStorageEventListener(){window.addEventListener("storage",e=>{var r;for(const[t,o]of c.entries())(r=e.key)!=null&&r.startsWith(t)&&o.handleStorageChange(e.key)})}get(e){return this.snapshot(e).value}snapshot(e){let r,t="absent";try{const o=localStorage.getItem(this.getKeyName(e));o&&(r=JSON.parse(o,(h,n)=>(typeof n=="object"&&n!==null&&Object.freeze(n),n)),t="present")}catch{this.errorApi.post(new Error(`Error when parsing JSON config from storage for: ${e}`))}return{key:e,value:r,presence:t}}forBucket(e){const r=`${this.namespace}/${e}`;return c.has(r)||c.set(r,new i(r,this.errorApi)),c.get(r)}async set(e,r){localStorage.setItem(this.getKeyName(e),JSON.stringify(r)),this.notifyChanges(e)}async remove(e){localStorage.removeItem(this.getKeyName(e)),this.notifyChanges(e)}observe$(e){return i.hasSubscribed||(i.addStorageEventListener(),i.hasSubscribed=!0),this.observable.filter(({key:r})=>r===e)}handleStorageChange(e){if(!(e!=null&&e.startsWith(this.namespace)))return;const r=e==null?void 0:e.slice(`${this.namespace}/`.length);r.includes("/")||this.notifyChanges(decodeURIComponent(r))}getKeyName(e){return`${this.namespace}/${encodeURIComponent(e)}`}notifyChanges(e){const r=this.snapshot(e);for(const t of this.subscribers)t.next(r)}};a(i,"hasSubscribed",!1);let f=i;const w={subscribe:()=>({unsubscribe:()=>{},closed:!0}),[Symbol.observable](){return this}};class O{constructor(e={}){a(this,"errors",new Array);a(this,"waiters",new Set);this.options=e}post(e,r){if(this.options.collect){this.errors.push({error:e,context:r});for(const t of this.waiters)t.pattern.test(e.message)&&(this.waiters.delete(t),t.resolve({error:e,context:r}));return}throw new Error(`MockErrorApi received unexpected error, ${e}`)}error$(){return w}getErrors(){return this.errors}waitForError(e,r=2e3){return new Promise((t,o)=>{setTimeout(()=>{o(new Error("Timed out waiting for error"))},r),this.waiters.add({resolve:t,pattern:e})})}}export{O as M,f as W,v as s,C as u};
