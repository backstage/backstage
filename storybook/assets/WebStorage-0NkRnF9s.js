var p=Object.defineProperty;var b=(s,e,t)=>e in s?p(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var n=(s,e,t)=>b(s,typeof e!="symbol"?e+"":e,t);import{c as m}from"./ApiRef-CqkoWjZn.js";import{r as u}from"./index-CTjT7uj6.js";import{O as g}from"./index-CFaqwFgm.js";const C=m({id:"core.storage"});var d=typeof window<"u",l=d?u.useLayoutEffect:u.useEffect;function I(s,e){var t=u.useState(e),r=t[0],o=t[1];return l(function(){var h=s.subscribe(o);return function(){return h.unsubscribe()}},[s]),r}const c=new Map,a=class a{constructor(e,t){n(this,"subscribers",new Set);n(this,"observable",new g(e=>(this.subscribers.add(e),()=>{this.subscribers.delete(e)})));this.namespace=e,this.errorApi=t}static create(e){return new a(e.namespace??"",e.errorApi)}static addStorageEventListener(){window.addEventListener("storage",e=>{var t;for(const[r,o]of c.entries())(t=e.key)!=null&&t.startsWith(r)&&o.handleStorageChange(e.key)})}get(e){return this.snapshot(e).value}snapshot(e){let t,r="absent";try{const o=localStorage.getItem(this.getKeyName(e));o&&(t=JSON.parse(o,(h,i)=>(typeof i=="object"&&i!==null&&Object.freeze(i),i)),r="present")}catch{this.errorApi.post(new Error(`Error when parsing JSON config from storage for: ${e}`))}return{key:e,value:t,presence:r}}forBucket(e){const t=`${this.namespace}/${e}`;return c.has(t)||c.set(t,new a(t,this.errorApi)),c.get(t)}async set(e,t){localStorage.setItem(this.getKeyName(e),JSON.stringify(t)),this.notifyChanges(e)}async remove(e){localStorage.removeItem(this.getKeyName(e)),this.notifyChanges(e)}observe$(e){return a.hasSubscribed||(a.addStorageEventListener(),a.hasSubscribed=!0),this.observable.filter(({key:t})=>t===e)}handleStorageChange(e){if(!(e!=null&&e.startsWith(this.namespace)))return;const t=e==null?void 0:e.slice(`${this.namespace}/`.length);t.includes("/")||this.notifyChanges(decodeURIComponent(t))}getKeyName(e){return`${this.namespace}/${encodeURIComponent(e)}`}notifyChanges(e){const t=this.snapshot(e);for(const r of this.subscribers)r.next(t)}};n(a,"hasSubscribed",!1);let f=a;export{f as W,C as s,I as u};
