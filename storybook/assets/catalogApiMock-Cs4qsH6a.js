import{a as U}from"./lodash-DZtYjLW6.js";import{aV as j,aW as T,aX as m}from"./iframe-CXVefQjv.js";import{s as g,p as B,D as O}from"./ref-C0VTUPuL.js";import{c as I}from"./api-BZOU0Ezb.js";import{a as V}from"./appWrappers-D6Cdj31E.js";const p=Symbol.for("CATALOG_FILTER_EXISTS_0e15b590c0b343a2bae3e787e84c2111"),N=500,$=["attachments","relations","status","metadata.name","metadata.namespace","metadata.uid","metadata.etag"];function z(t){const e=[],o=new Set;function n(a,i){if(!$.includes(a)){if(i==null||["string","number","boolean"].includes(typeof i)){e.push({key:a,value:i});return}if(typeof i=="object"){if(Array.isArray(i)){for(const r of i)if(n(a,r),typeof r=="string"){const s=`${a}.${r}`,c=s.toLocaleLowerCase("en-US");o.has(c)||(o.add(c),e.push({key:s,value:!0}))}return}for(const[r,s]of Object.entries(i))n(a?`${a}.${r}`:r,s)}}}return n("",t),e}function A(t){return btoa(JSON.stringify(t))}function k(t){return JSON.parse(atob(t))}const S="\0CATALOG_FILTER_EXISTS";function x(t){return t===p?S:Array.isArray(t)?t.map(e=>e===p?S:e):t}function X(t){return t===S?p:Array.isArray(t)?t.map(e=>e===S?p:e):t}function K(t){if(t)return[t].flat().map(e=>Object.fromEntries(Object.entries(e).map(([o,n])=>[o,x(n)])))}function D(t){if(t)return t.map(e=>Object.fromEntries(Object.entries(e).map(([o,n])=>[o,X(n)])))}function v(t){const e=z(t);t.metadata?.name&&e.push({key:"metadata.name",value:t.metadata.name.toLocaleLowerCase("en-US")}),t.metadata?.namespace&&e.push({key:"metadata.namespace",value:t.metadata.namespace.toLocaleLowerCase("en-US")}),t.metadata?.uid&&e.push({key:"metadata.uid",value:t.metadata.uid.toLocaleLowerCase("en-US")}),t.metadata.namespace||e.push({key:"metadata.namespace",value:O});for(const o of t.relations??[])e.push({key:`relations.${o.type.toLocaleLowerCase("en-US")}`,value:o.targetRef.toLocaleLowerCase("en-US")});return e}function E(t){if(!t)return()=>!0;const e=[t].flat();return o=>{const n=v(o);return e.some(a=>{for(const[i,r]of Object.entries(a)){const s=n.filter(c=>c.key===i.toLocaleLowerCase("en-US")).map(c=>c.value?.toString().toLocaleLowerCase("en-US"));if(s.length===0)return!1;if(r!==p){if(Array.isArray(r))return r.some(c=>s?.includes(String(c).toLocaleLowerCase("en-US")));if(!s?.includes(String(r).toLocaleLowerCase("en-US")))return!1}}return!0})}}function G(t,e){return e.split(".").reduce(([o,n],a,i,r)=>U.hasIn(n,a)?[o.concat(a),n[a]]:r[i+1]!==void 0?(r[i+1]=`${a}.${r[i+1]}`,[o,n]):[o,void 0],[[],t])}function h(t,e){if(!e?.length)return t;const o={};for(const n of e){const[a,i]=G(t,n);i!==void 0&&U.set(o,a,i)}return o}function _(t,e){if(!e)return t;const o=[e].flat();if(o.length===0)return t;const n=new Map;for(const a of t)n.set(a,v(a));return[...t].sort((a,i)=>{const r=n.get(a),s=n.get(i);for(const{field:d,order:f}of o){const y=d.toLocaleLowerCase("en-US"),l=r.find(R=>R.key.toLocaleLowerCase("en-US")===y),C=s.find(R=>R.key.toLocaleLowerCase("en-US")===y),L=l?.value!==null&&l?.value!==void 0?String(l.value).toLocaleLowerCase("en-US"):null,w=C?.value!==null&&C?.value!==void 0?String(C.value).toLocaleLowerCase("en-US"):null;if(!(L===null&&w===null)){if(L===null)return 1;if(w===null)return-1;if(L<w)return f==="asc"?-1:1;if(L>w)return f==="asc"?1:-1}}const c=g(a),u=g(i);return c<u?-1:c>u?1:0})}function J(t,e){if(!e?.term?.trim())return t;const o=e.term.trim().toLocaleLowerCase("en-US"),n=e.fields?.map(a=>a.toLocaleLowerCase("en-US"));return t.filter(a=>v(a).some(r=>n?.length&&!n.includes(r.key.toLocaleLowerCase("en-US"))||r.value===null||r.value===void 0?!1:String(r.value).toLocaleLowerCase("en-US").includes(o)))}class M{#e;constructor(e){this.#e=e?.entities?.slice()??[]}async getEntities(e){const o=E(e?.filter);let n=this.#e.filter(o);n=_(n,e?.order);let a=e?.offset??0,i=e?.limit;if(e?.after)try{const r=k(e.after);r.offset!==void 0&&(a=r.offset),r.limit!==void 0&&(i=r.limit)}catch{throw new j("Invalid cursor")}return a>0&&(n=n.slice(a)),i!==void 0&&(n=n.slice(0,i)),{items:e?.fields?n.map(r=>h(r,e.fields)):n}}async getEntitiesByRefs(e){const o=E(e.filter),n=this.#t(),a=e.entityRefs.map(i=>n.get(i)).map(i=>i&&o(i)?i:void 0);return{items:e.fields?a.map(i=>i?h(i,e.fields):void 0):a}}async queryEntities(e){let o,n,a,i,r;if(e&&"cursor"in e){let l;try{l=k(e.cursor)}catch{throw new j("Invalid cursor")}o=D(l.filter),n=l.orderFields,a=l.fullTextFilter,i=l.offset,r=e.limit}else o=e?.filter,n=e?.orderFields,a=e?.fullTextFilter,i=e?.offset??0,r=e?.limit;let s=this.#e.filter(E(o));if(a){const l=n?[n].flat():[];s=J(s,{...a,fields:a.fields??[l[0]?.field??"metadata.uid"]})}s=_(s,n);const c=s.length;if(r===void 0&&i===0)return{items:e?.fields?s.map(l=>h(l,e?.fields)):s,pageInfo:{},totalItems:c};const u=r??c,d=s.slice(i,i+u),f={filter:K(o),orderFields:n,fullTextFilter:a,totalItems:c},y={};return i+u<c&&(y.nextCursor=A({...f,offset:i+u})),i>0&&(y.prevCursor=A({...f,offset:Math.max(0,i-u)})),{items:e?.fields?d.map(l=>h(l,e?.fields)):d,totalItems:c,pageInfo:y}}async getEntityAncestors(e){const o=this.#t().get(e.entityRef);if(!o)throw new T(`Entity with ref ${e.entityRef} not found`);return{items:[{entity:o,parentEntityRefs:[]}],rootEntityRef:e.entityRef}}async getEntityByRef(e){return this.#t().get(g(B(e)))}async removeEntityByUid(e){const o=this.#e.findIndex(n=>n.metadata.uid===e);o!==-1&&this.#e.splice(o,1)}async refreshEntity(e){}async getEntityFacets(e){const o=E(e.filter),n=this.#e.filter(o);return{facets:Object.fromEntries(e.facets.map(i=>{const r=new Map;for(const c of n){const u=v(c),d=new Set(u.filter(f=>f.key.toLocaleLowerCase("en-US")===i.toLocaleLowerCase("en-US")).map(f=>f.value).filter(f=>f!=null).map(f=>String(f)));for(const f of d)r.set(f,(r.get(f)??0)+1)}const s=Array.from(r.entries()).map(([c,u])=>({value:c,count:u}));return[i,s]}))}}async getLocations(e){throw new m("Method not implemented.")}async queryLocations(e){throw new m("Method not implemented.")}async*streamLocations(e){throw new m("Method not implemented.")}async getLocationById(e){throw new m("Method not implemented.")}async getLocationByRef(e){throw new m("Method not implemented.")}async addLocation(e){throw new m("Method not implemented.")}async removeLocationById(e){throw new m("Method not implemented.")}async getLocationByEntity(e){throw new m("Method not implemented.")}async validateEntity(e,o){throw new m("Method not implemented.")}async analyzeLocation(e){throw new m("Method not implemented.")}async*streamEntities(e){let o;const n=e?.pageSize??N;do{const a=await this.queryEntities(o?{...e,limit:n,cursor:o}:{...e,limit:n});yield a.items,o=a.pageInfo.nextCursor}while(o)}#t(){return new Map(this.#e.map(e=>[g(e),e]))}}const b=Symbol.for("@backstage/mock-api");function W(t,e){const o=e;return o[b]={api:t,deps:{},factory:()=>e},o}function Y(t,e){return o=>{const n=e();if(o)for(const[a,i]of Object.entries(o))typeof i=="function"?n[a].mockImplementation(i):n[a]=i;return n[b]={api:t,deps:{},factory:()=>n},n}}function F(t){const e=new M(t);return W(I,e)}(t=>{t.factory=e=>V({api:I,deps:{},factory:()=>new M(e)}),t.mock=Y(I,()=>({getEntities:jest.fn(),getEntitiesByRefs:jest.fn(),queryEntities:jest.fn(),getEntityAncestors:jest.fn(),getEntityByRef:jest.fn(),removeEntityByUid:jest.fn(),refreshEntity:jest.fn(),getEntityFacets:jest.fn(),getLocations:jest.fn(),queryLocations:jest.fn(),streamLocations:jest.fn(),getLocationById:jest.fn(),getLocationByRef:jest.fn(),addLocation:jest.fn(),removeLocationById:jest.fn(),getLocationByEntity:jest.fn(),validateEntity:jest.fn(),analyzeLocation:jest.fn(),streamEntities:jest.fn(),streamEntityPages:jest.fn()}))})(F||(F={}));export{F as c};
