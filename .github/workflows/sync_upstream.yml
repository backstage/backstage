name: Sync Fork with Upstream
on:
  workflow_dispatch:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/backstage/backstage.git || true
          git remote -v

      - name: Fetch upstream changes
        run: |
          # Fetch branches first
          git fetch upstream
          # Fetch tags with --force to update existing tags that may have conflicts
          git fetch upstream --tags --force

      - name: Sync master branch
        run: |
          git checkout master
          git merge upstream/master --ff-only || {
            echo "::warning::Unable to fast-forward merge. Manual intervention may be required."
            exit 1
          }

      - name: Push changes
        run: |
          git push origin master
          git push origin --tags

      - name: Create summary
        if: success()
        run: |
          echo "### :white_check_mark: Fork sync completed successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Synced branches:** master" >> $GITHUB_STEP_SUMMARY
          echo "**Tags synced:** All upstream tags" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u)" >> $GITHUB_STEP_SUMMARY

      - name: Create failure summary
        if: failure()
        run: |
          echo "### :x: Fork sync failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Manual intervention may be required to resolve conflicts." >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u)" >> $GITHUB_STEP_SUMMARY
