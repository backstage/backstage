"use strict";(self.webpackChunkbackstage_microsite=self.webpackChunkbackstage_microsite||[]).push([["24821"],{876727(e,n,t){t.r(n),t.d(n,{assets:()=>h,contentTitle:()=>a,default:()=>l,frontMatter:()=>o,metadata:()=>i,toc:()=>c});var i=t(144144),s=t(474848),r=t(28453);let o={id:"provider",title:"OpenShift Authentication Provider",sidebar_label:"OpenShift",description:"Adding OpenShift OAuth as an authentication provider in Backstage"},a,h={},c=[{value:"Use Case",id:"use-case",level:2},{value:"Create an OAuth client in OpenShift",id:"create-an-oauth-client-in-openshift",level:2},{value:"Configuration",id:"configuration",level:2},{value:"Backend Installation",id:"backend-installation",level:2}];function d(e){let n={a:"a",admonition:"admonition",code:"code",em:"em",h2:"h2",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(n.p,{children:["The Backstage ",(0,s.jsx)(n.code,{children:"core-plugin-api"})," package comes with a OpenShift authentication\nprovider that can authenticate users using OpenShift OAuth."]}),"\n",(0,s.jsx)(n.h2,{id:"use-case",children:"Use Case"}),"\n",(0,s.jsxs)(n.p,{children:["This setup enables the ",(0,s.jsx)(n.a,{href:"/docs/features/kubernetes/",children:"Kubernetes plugin"})," to access OpenShift clusters using the user's permissions,\nleveraging OAuth 2.0 ",(0,s.jsx)(n.em,{children:"On-Behalf-Of"})," flow via the ",(0,s.jsx)(n.a,{href:"/docs/features/kubernetes/authentication",children:"Kubernetes Client Side Provider"}),"."]}),"\n",(0,s.jsxs)(n.p,{children:["To make this work, the corresponding ",(0,s.jsx)(n.code,{children:"User"})," entities must exist in the Backstage catalog,\nand their names must match the OpenShift users."]}),"\n",(0,s.jsxs)(n.p,{children:["Although the OpenShift authentication provider does not support OIDC natively,\nyou can still configure it for use with the Kubernetes integration by treating it as an OIDC provider\nin the ",(0,s.jsx)(n.code,{children:"KubernetesAuthProviders"})," configuration."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",metastring:'title="packages/app/src/apis.ts"',children:"import {\n  KubernetesAuthProviders,\n  kubernetesAuthProvidersApiRef,\n} from '@backstage/plugin-kubernetes';\nimport {\n  googleAuthApiRef,\n  microsoftAuthApiRef,\n  openshiftAuthApiRef,\n} from '@backstage/core-plugin-api';\n\nexport const apis: AnyApiFactory[] = [\n  // ...\n  createApiFactory({\n    api: kubernetesAuthProvidersApiRef,\n    deps: {\n      microsoftAuthApi: microsoftAuthApiRef,\n      googleAuthApi: googleAuthApiRef,\n      openshiftAuthApi: openshiftAuthApiRef,\n    },\n    factory({ microsoftAuthApi, googleAuthApi, openshiftAuthApi }) {\n      return new KubernetesAuthProviders({\n        microsoftAuthApi,\n        googleAuthApi,\n        oidcProviders: {\n          openshift: {\n            async getIdToken(_) {\n              return await openshiftAuthApi.getAccessToken('user:full');\n            },\n          },\n        },\n      });\n    },\n  }),\n  //...\n];\n"})}),"\n",(0,s.jsx)(n.admonition,{title:"Note",type:"note",children:(0,s.jsxs)(n.p,{children:["The OpenShift auth API does ",(0,s.jsx)(n.strong,{children:"not"})," implement the ",(0,s.jsx)(n.code,{children:"OpenIdConnectApi"})," interface. In other words, it does ",(0,s.jsx)(n.strong,{children:"not"})," return an ID token.\nInstead, it returns an ",(0,s.jsx)(n.strong,{children:"access token"}),", which is used by the Kubernetes integration in place of an ID token.\nThis is the only functional difference from the standard OIDC-based authentication flow."]})}),"\n",(0,s.jsx)(n.h2,{id:"create-an-oauth-client-in-openshift",children:"Create an OAuth client in OpenShift"}),"\n",(0,s.jsx)(n.p,{children:"Make sure that an OAuth client exists in the OpenShift cluster."}),"\n",(0,s.jsxs)(n.p,{children:["To configure the OpenShift integration, create an ",(0,s.jsx)(n.a,{href:"https://docs.redhat.com/en/documentation/openshift_container_platform/latest/html/authentication_and_authorization/configuring-oauth-clients",children:(0,s.jsx)(n.code,{children:"OAuthClient"})}),"."]}),"\n",(0,s.jsxs)(n.p,{children:["The redirect URI must be in the following format: ",(0,s.jsx)(n.code,{children:"https://<fqdn>/api/auth/openshift/handler/frame"}),"."]}),"\n",(0,s.jsx)(n.h2,{id:"configuration",children:"Configuration"}),"\n",(0,s.jsxs)(n.p,{children:["The provider configuration can then be added to your ",(0,s.jsx)(n.code,{children:"app-config.yaml"})," under the\nroot ",(0,s.jsx)(n.code,{children:"auth"})," configuration:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"auth:\n  environment: development\n  providers:\n    openshift:\n      development:\n        clientId: ${AUTH_OPENSHIFT_CLIENT_ID}\n        clientSecret: ${AUTH_OPENSHIFT_CLIENT_SECRET}\n        authorizationUrl: ${AUTH_OPENSHIFT_AUTHORIZATION_URL}\n        tokenUrl: ${AUTH_OPENSHIFT_TOKEN_URL}\n        openshiftApiServerUrl: ${OPENSHIFT_API_SERVER_URL}\n        ## uncomment to set lifespan of user session\n        # sessionDuration: { hours: 24 } # supports `ms` library format (e.g. '24h', '2 days'), ISO duration, \"human duration\" as used in code\n        # sessionDuration: 1d\n        signIn:\n          resolvers:\n            - resolver: displayNameMatchingUserEntityName\n"})}),"\n",(0,s.jsx)(n.p,{children:"The OpenShift provider is a structure with these configuration keys:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"clientId"}),": The client ID of your OpenShift OAuth client, e.g., ",(0,s.jsx)(n.code,{children:"my-backstage"})]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"clientSecret"}),": The client secret tied to the OpenShift OAuth client."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"authorizationUrl"}),": The OpenShift OAuth client auth endpoint, format: ",(0,s.jsx)(n.code,{children:"https://<oauth-client-route>/oauth/authorize"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"tokenUrl"}),": The OpenShift OAuth client token endpoint, format: ",(0,s.jsx)(n.code,{children:"https://<oauth-client-route>/oauth/token"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"openshiftApiServerUrl"}),": The OpenShift API server endpoint, format: ",(0,s.jsx)(n.code,{children:"https://<openshift-api>"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"sessionDuration"}),": (optional): Lifespan of the user session."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"signIn"}),": The configuration for the sign-in process, including the ",(0,s.jsx)(n.strong,{children:"resolvers"}),"\nthat should be used to match the user from the auth provider with the user\nentity in the Backstage catalog (typically a single resolver is sufficient)."]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["The provider needs to use the scope ",(0,s.jsx)(n.strong,{children:"user:full"}),"."]}),"\n",(0,s.jsx)(n.h2,{id:"backend-installation",children:"Backend Installation"}),"\n",(0,s.jsx)(n.p,{children:"To add the provider to the backend we will first need to install the package by running this command:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",metastring:'title="from your Backstage root directory"',children:"yarn --cwd packages/backend add @backstage/plugin-auth-backend-module-openshift-provider\n"})}),"\n",(0,s.jsx)(n.p,{children:"Then we will need to add this line:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",metastring:'title="in packages/backend/src/index.ts"',children:"backend.add(import('@backstage/plugin-auth-backend'));\n/* highlight-add-start */\nbackend.add(import('@backstage/plugin-auth-backend-module-openshift-provider'));\n/* highlight-add-end */\n"})})]})}function l(e={}){let{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},28453(e,n,t){t.d(n,{R:()=>o,x:()=>a});var i=t(296540);let s={},r=i.createContext(s);function o(e){let n=i.useContext(r);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),i.createElement(r.Provider,{value:n},e.children)}},144144(e){e.exports=JSON.parse('{"id":"auth/openshift/provider","title":"OpenShift Authentication Provider","description":"Adding OpenShift OAuth as an authentication provider in Backstage","source":"@site/versioned_docs/version-stable/auth/openshift/provider.md","sourceDirName":"auth/openshift","slug":"/auth/openshift/provider","permalink":"/docs/auth/openshift/provider","draft":false,"unlisted":false,"editUrl":"https://github.com/backstage/backstage/edit/master/docs/auth/openshift/provider.md","tags":[],"version":"stable","frontMatter":{"id":"provider","title":"OpenShift Authentication Provider","sidebar_label":"OpenShift","description":"Adding OpenShift OAuth as an authentication provider in Backstage"}}')}}]);