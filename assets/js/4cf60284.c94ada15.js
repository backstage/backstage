/*! For license information please see 4cf60284.c94ada15.js.LICENSE.txt */
"use strict";(self.webpackChunkbackstage_microsite=self.webpackChunkbackstage_microsite||[]).push([[785066],{343897:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>a,default:()=>l,frontMatter:()=>o,metadata:()=>s,toc:()=>h});var r=t(474848),i=t(28453);const o={id:"add-auth-provider",title:"Contributing New Provider Modules",description:"Documentation on adding new authentication providers"},a=void 0,s={id:"auth/add-auth-provider",title:"Contributing New Provider Modules",description:"Documentation on adding new authentication providers",source:"@site/versioned_docs/version-stable/auth/add-auth-provider.md",sourceDirName:"auth",slug:"/auth/add-auth-provider",permalink:"/docs/auth/add-auth-provider",draft:!1,unlisted:!1,editUrl:"https://github.com/backstage/backstage/edit/master/docs/auth/add-auth-provider.md",tags:[],version:"stable",frontMatter:{id:"add-auth-provider",title:"Contributing New Provider Modules",description:"Documentation on adding new authentication providers"},sidebar:"docs",previous:{title:"OIDC provider from scratch",permalink:"/docs/auth/oidc"},next:{title:"Service to Service Auth",permalink:"/docs/auth/service-to-service-auth"}},d={},h=[{value:"How Does Authentication Work?",id:"how-does-authentication-work",level:2},{value:"Implementing Your Own Auth Wrapper",id:"implementing-your-own-auth-wrapper",level:2},{value:"Auth Environment Separation",id:"auth-environment-separation",level:3},{value:"Passport",id:"passport",level:2},{value:"How to add a new strategy provider",id:"how-to-add-a-new-strategy-provider",level:2},{value:"Quick guide",id:"quick-guide",level:3},{value:"Create new auth provider module",id:"create-new-auth-provider-module",level:3},{value:"Adding an OAuth based provider",id:"adding-an-oauth-based-provider",level:3},{value:"Creating proxy auth based provider",id:"creating-proxy-auth-based-provider",level:3},{value:"Verify Callback",id:"verify-callback",level:4},{value:"Add the provider to the backend",id:"add-the-provider-to-the-backend",level:3},{value:"Test the new provider",id:"test-the-new-provider",level:3}];function c(e){const n={a:"a",admonition:"admonition",blockquote:"blockquote",code:"code",h2:"h2",h3:"h3",h4:"h4",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.admonition,{title:"Note",type:"note",children:(0,r.jsx)(n.p,{children:"The primary audience for this documentation are contributors that want to add support for new authentication providers.\nWhile you can follow it to implement your own custom providers it is much\nmore advanced than using our built-in providers."})}),"\n",(0,r.jsx)(n.h2,{id:"how-does-authentication-work",children:"How Does Authentication Work?"}),"\n",(0,r.jsxs)(n.p,{children:["The Backstage application can use various external authentication providers for\nauthentication. An external provider is wrapped using an\n",(0,r.jsx)(n.code,{children:"AuthProviderRouteHandlers"})," interface for handling authentication. This\ninterface consists of four methods. Each of these methods is hosted at an\nendpoint (by default) ",(0,r.jsx)(n.code,{children:"/api/auth/[provider]/method"}),", where ",(0,r.jsx)(n.code,{children:"method"})," performs a\ncertain operation as follows:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"  /auth/[provider]/start -> Initiate a login from the web page\n  /auth/[provider]/handler/frame -> Handle a finished authentication operation\n  /auth/[provider]/refresh -> Refresh the validity of a login\n  /auth/[provider]/logout -> Log out a logged-in user\n"})}),"\n",(0,r.jsx)(n.p,{children:"The flow is as follows:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"A user attempts to sign in."}),"\n",(0,r.jsxs)(n.li,{children:["A popup window is opened, pointing to the ",(0,r.jsx)(n.code,{children:"auth"})," endpoint. That endpoint does\ninitial preparations and then re-directs the user to an external\nauthenticator, still inside the popup."]}),"\n",(0,r.jsxs)(n.li,{children:["The authenticator validates the user and returns the result of the validation\n(success OR failure), to the wrapper's endpoint (",(0,r.jsx)(n.code,{children:"handler/frame"}),")."]}),"\n",(0,r.jsxs)(n.li,{children:["The ",(0,r.jsx)(n.code,{children:"handler/frame"})," rendered webpage will issue the appropriate response to\nthe webpage that opened the popup window, and the popup is closed."]}),"\n",(0,r.jsx)(n.li,{children:"The user signs out by clicking on a UI interface and the webpage makes a\nrequest to logout the user."}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"implementing-your-own-auth-wrapper",children:"Implementing Your Own Auth Wrapper"}),"\n",(0,r.jsxs)(n.p,{children:["The core interface of any auth wrapper is the ",(0,r.jsx)(n.code,{children:"AuthProviderRouteHandlers"}),"\ninterface. This interface has four methods corresponding to the API described in\nthe initial section. Any auth wrapper will have to implement this interface."]}),"\n",(0,r.jsxs)(n.p,{children:["When initiating a login, a pop-up window is created by the frontend, to allow\nthe user to initiate a login. This login request is done to the ",(0,r.jsx)(n.code,{children:"/start"}),"\nendpoint which is handled by the ",(0,r.jsx)(n.code,{children:"start"})," method."]}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"start"})," method re-directs to the external auth provider who authenticates\nthe request and re-directs the request to the ",(0,r.jsx)(n.code,{children:"/handler/frame"})," endpoint, which\nis handled by the ",(0,r.jsx)(n.code,{children:"frameHandler"})," method."]}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"frameHandler"})," returns an HTML response, containing a script that does a\n",(0,r.jsx)(n.code,{children:"postMessage"})," to the frontend window, containing the result of the request.\nThe ",(0,r.jsx)(n.code,{children:"WebMessageResponse"})," type is the message sent by the ",(0,r.jsx)(n.code,{children:"postMessage"})," to the\nfrontend."]}),"\n",(0,r.jsxs)(n.p,{children:["A ",(0,r.jsx)(n.code,{children:"postMessageResponse"})," utility function wraps the logic of generating a\n",(0,r.jsx)(n.code,{children:"postMessage"})," response that ensures that CORS is successfully handled. This\nfunction takes an ",(0,r.jsx)(n.code,{children:"express.Response"}),", a ",(0,r.jsx)(n.code,{children:"WebMessageResponse"})," and the URL of the\nfrontend (",(0,r.jsx)(n.code,{children:"appOrigin"}),") as parameters and return an HTML page with the script and\nthe message."]}),"\n",(0,r.jsx)(n.h3,{id:"auth-environment-separation",children:"Auth Environment Separation"}),"\n",(0,r.jsxs)(n.p,{children:["The concept of an ",(0,r.jsx)(n.code,{children:"env"})," is core to the way the auth backend works. It uses an\n",(0,r.jsx)(n.code,{children:"env"})," query parameter to identify the environment in which the application is\nrunning (",(0,r.jsx)(n.code,{children:"development"}),", ",(0,r.jsx)(n.code,{children:"staging"}),", ",(0,r.jsx)(n.code,{children:"production"}),", etc). Each runtime can\nsimultaneously support multiple environments at the same time and the right\nhandler for each request is identified and dispatched to, based on the ",(0,r.jsx)(n.code,{children:"env"}),"\nparameter."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"OAuthEnvironmentHandler"})," is a utility wrapper for an ",(0,r.jsx)(n.code,{children:"OAuthHandlers"})," that\nimplements the ",(0,r.jsx)(n.code,{children:"AuthProviderRouteHandlers"})," interface while supporting multiple\n",(0,r.jsx)(n.code,{children:"env"}),"s."]}),"\n",(0,r.jsxs)(n.p,{children:["To instantiate OAuth providers (the same but for different environments), use\n",(0,r.jsx)(n.code,{children:"OAuthEnvironmentHandler.mapConfig"}),". It's a helper to iterate over a\nconfiguration object that is a map of environments to configurations. See one of\nthe existing OAuth providers for an example of how it is used."]}),"\n",(0,r.jsx)(n.p,{children:"Given the following configuration:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"development:\n  clientId: abc\n  clientSecret: secret\nproduction:\n  clientId: xyz\n  clientSecret: supersecret\n"})}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"OAuthEnvironmentHandler.mapConfig(config, envConfig => ...)"})," call will\nsplit the config by the top level ",(0,r.jsx)(n.code,{children:"development"})," and ",(0,r.jsx)(n.code,{children:"production"})," keys, and pass\non each block as ",(0,r.jsx)(n.code,{children:"envConfig"}),"."]}),"\n",(0,r.jsxs)(n.p,{children:["For convenience, the ",(0,r.jsx)(n.code,{children:"AuthProviderFactory"})," is a factory function that has to be\nimplemented which can then generate a ",(0,r.jsx)(n.code,{children:"AuthProviderRouteHandlers"})," for a given\nprovider."]}),"\n",(0,r.jsxs)(n.p,{children:["All of the supported providers provide an ",(0,r.jsx)(n.code,{children:"AuthProviderFactory"})," that returns an\n",(0,r.jsx)(n.code,{children:"OAuthEnvironmentHandler"}),", capable of handling authentication for multiple\nenvironments."]}),"\n",(0,r.jsx)(n.h2,{id:"passport",children:"Passport"}),"\n",(0,r.jsxs)(n.p,{children:["We chose ",(0,r.jsx)(n.a,{href:"http://www.passportjs.org/",children:"Passport"})," as our authentication platform\ndue to its comprehensive set of supported authentication\n",(0,r.jsx)(n.a,{href:"http://www.passportjs.org/packages/",children:"strategies"}),"."]}),"\n",(0,r.jsx)(n.h2,{id:"how-to-add-a-new-strategy-provider",children:"How to add a new strategy provider"}),"\n",(0,r.jsx)(n.h3,{id:"quick-guide",children:"Quick guide"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.a,{href:"#create-new-auth-provider-module",children:"1."})," Create a new auth provider module or ",(0,r.jsx)(n.a,{href:"#creating-proxy-auth-based-provider",children:"add a proxy auth based provider"})," depending on your needs."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.a,{href:"#add-the-provider-to-the-backend",children:"2."})," Add the provider to the backend."]}),"\n",(0,r.jsx)(n.h3,{id:"create-new-auth-provider-module",children:"Create new auth provider module"}),"\n",(0,r.jsx)(n.p,{children:"In this example we will create auth module for a made up service named foobar."}),"\n",(0,r.jsxs)(n.p,{children:["Create a new module using ",(0,r.jsx)(n.code,{children:"yarn new"}),", pick ",(0,r.jsx)(n.code,{children:"backend-module"})," and provide ",(0,r.jsx)(n.code,{children:"auth-backend"})," as the plugin ID and ",(0,r.jsx)(n.code,{children:"foobar-provider"})," as the module ID."]}),"\n",(0,r.jsx)(n.p,{children:"Make sure that the module has the appropriate passport provider as a dependency."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"cd plugins/auth-backend-backend-module-foobar-provider\nyarn add passport-provider-a\nyarn add @types/passport-provider-a\n"})}),"\n",(0,r.jsx)(n.h3,{id:"adding-an-oauth-based-provider",children:"Adding an OAuth based provider"}),"\n",(0,r.jsxs)(n.p,{children:["We're then creating a new module that can extend the Auth backend using the ",(0,r.jsx)(n.code,{children:"authProvidersExtensionPoint"}),"."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",metastring:'title="plugins/auth-backend-foobar-provider/src/module.ts"',children:"import { createBackendModule } from '@backstage/backend-plugin-api';\nimport {\n  authProvidersExtensionPoint,\n  commonSignInResolvers,\n  createOAuthProviderFactory,\n} from '@backstage/plugin-auth-node';\nimport { providerAuthenticator } from './authenticator';\n\n/** @public */\nexport const authModuleFoobarProvider = createBackendModule({\n  pluginId: 'auth',\n  moduleId: 'foobar',\n  register(reg) {\n    reg.registerInit({\n      deps: {\n        providers: authProvidersExtensionPoint,\n      },\n      async init({ providers }) {\n        providers.registerProvider({\n          providerId: 'foobar',\n          factory: createOAuthProviderFactory({\n            authenticator: providerAuthenticator,\n            signInResolverFactories: {\n              ...commonSignInResolvers,\n            },\n          }),\n        });\n      },\n    });\n  },\n});\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Now let's implement the actual authenticator for our provider using ",(0,r.jsx)(n.code,{children:"Strategy"})," from a passport package.\nThe authenticator is responsible for creating the passport strategy and handling the authentication flow using secrets from the config file."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",metastring:'title="plugins/auth-backend-foobar-provider/src/authenticator.ts"',children:"import { Strategy as ProviderStrategy } from 'passport-provider-a';\nimport {\n  createOAuthAuthenticator,\n  PassportOAuthAuthenticatorHelper,\n  PassportOAuthDoneCallback,\n  PassportProfile,\n} from '@backstage/plugin-auth-node';\n\n/** @public */\nexport const providerAuthenticator = createOAuthAuthenticator({\n  defaultProfileTransform:\n    PassportOAuthAuthenticatorHelper.defaultProfileTransform,\n  scopes: {\n    // Scopes required by the provider\n    required: ['openid', 'email', 'profile', 'offline_access'],\n  },\n  initialize({ callbackUrl, config }) {\n    const clientId = config.getString('clientId');\n    const clientSecret = config.getString('clientSecret');\n\n    return PassportOAuthAuthenticatorHelper.from(\n      new ProviderStrategy(\n        {\n          clientID: clientId,\n          clientSecret: clientSecret,\n          // ... other options\n        },\n        (\n          accessToken: string,\n          refreshToken: string,\n          params: any,\n          fullProfile: PassportProfile,\n          done: PassportOAuthDoneCallback,\n        ) => {\n          done(\n            undefined,\n            { fullProfile, params, accessToken },\n            { refreshToken },\n          );\n        },\n      ),\n    );\n  },\n\n  async start(input, helper) {\n    return helper.start(input);\n  },\n\n  async authenticate(input, helper) {\n    return helper.authenticate(input);\n  },\n\n  async refresh(input, helper) {\n    return helper.refresh(input);\n  },\n});\n"})}),"\n",(0,r.jsx)(n.p,{children:"Here are some examples of authenticators that are already implemented in the codebase:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://github.com/backstage/backstage/blob/master/plugins/auth-backend-module-google-provider/src/authenticator.ts",children:"Google"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://github.com/backstage/backstage/blob/master/plugins/auth-backend-module-github-provider/src/authenticator.ts",children:"GitHub"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://github.com/backstage/backstage/blob/master/plugins/auth-backend-module-okta-provider/src/authenticator.ts",children:"Okta"})}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"creating-proxy-auth-based-provider",children:"Creating proxy auth based provider"}),"\n",(0,r.jsx)(n.p,{children:"A proxy auth provider is a provider that uses another provider to authenticate for example Google IAP or AWS ALB, please note that those providers are already supported by Backstage."}),"\n",(0,r.jsxs)(n.p,{children:["The implementation is similar to the OAuth provider, but the ",(0,r.jsx)(n.code,{children:"authenticator"})," function is different. There are already some examples on how to implement a proxy provider in the codebase, for example ",(0,r.jsx)(n.a,{href:"https://github.com/backstage/backstage/tree/master/plugins/auth-backend-module-gcp-iap-provider",children:"auth-backend-module-gcp-iap-provider"})," and ",(0,r.jsx)(n.a,{href:"https://github.com/backstage/backstage/tree/master/plugins/auth-backend-module-aws-alb-provider",children:"auth-backend-module-aws-alb-provider"})]}),"\n",(0,r.jsx)(n.h4,{id:"verify-callback",children:"Verify Callback"}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsx)(n.p,{children:"Strategies require what is known as a verify callback. The purpose of a verify\ncallback is to find the user that possesses a set of credentials. When\nPassport authenticates a request, it parses the credentials contained in the\nrequest. It then invokes the verify callback with those credentials as\narguments [...]. If the credentials are valid, the verify callback invokes\ndone to supply Passport with the user that authenticated."}),"\n",(0,r.jsx)(n.p,{children:"If the credentials are not valid (for example, if the password is incorrect),\ndone should be invoked with false instead of a user to indicate an\nauthentication failure."}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.a,{href:"http://www.passportjs.org/docs/configure/",children:"http://www.passportjs.org/docs/configure/"})}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"add-the-provider-to-the-backend",children:"Add the provider to the backend"}),"\n",(0,r.jsx)(n.p,{children:"The process for adding the new module is the same as for any other type of module or backend plugin."}),"\n",(0,r.jsxs)(n.p,{children:["If this provider is internal to your installation the import path that you add to ",(0,r.jsx)(n.code,{children:"packages/backend/src/index.ts"})," would be something like:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"backend.add(import('@internal/plugin-auth-backend-module-foobar-provider'));\n"})}),"\n",(0,r.jsx)(n.p,{children:"But if this module is contributed directly to Backstage the module would be imported as"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"backend.add(import('@backstage/plugin-auth-backend-module-foobar-provider'));\n"})}),"\n",(0,r.jsxs)(n.p,{children:["By doing this ",(0,r.jsx)(n.code,{children:"auth-backend"})," automatically adds these endpoints:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"router.get('/auth/providerA/start');\nrouter.get('/auth/providerA/handler/frame');\nrouter.post('/auth/providerA/handler/frame');\nrouter.post('/auth/providerA/logout');\nrouter.get('/auth/providerA/refresh'); // if supported\nrouter.post('/auth/providerA/refresh'); // if supported\n"})}),"\n",(0,r.jsxs)(n.p,{children:["As you can see each endpoint is prefixed with both ",(0,r.jsx)(n.code,{children:"/auth"})," and its provider\nname."]}),"\n",(0,r.jsx)(n.h3,{id:"test-the-new-provider",children:"Test the new provider"}),"\n",(0,r.jsxs)(n.p,{children:["You can ",(0,r.jsx)(n.code,{children:"curl -i localhost:7007/api/auth/providerA/start"})," and which should\nprovide a ",(0,r.jsx)(n.code,{children:"302"})," redirect with a ",(0,r.jsx)(n.code,{children:"Location"})," header. Paste the URL from that\nheader into a web browser and you should be able to trigger the authorization\nflow."]})]})}function l(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(c,{...e})}):c(e)}},221020:(e,n,t)=>{var r=t(296540),i=Symbol.for("react.element"),o=Symbol.for("react.fragment"),a=Object.prototype.hasOwnProperty,s=r.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,d={key:!0,ref:!0,__self:!0,__source:!0};function h(e,n,t){var r,o={},h=null,c=null;for(r in void 0!==t&&(h=""+t),void 0!==n.key&&(h=""+n.key),void 0!==n.ref&&(c=n.ref),n)a.call(n,r)&&!d.hasOwnProperty(r)&&(o[r]=n[r]);if(e&&e.defaultProps)for(r in n=e.defaultProps)void 0===o[r]&&(o[r]=n[r]);return{$$typeof:i,type:e,key:h,ref:c,props:o,_owner:s.current}}n.Fragment=o,n.jsx=h,n.jsxs=h},474848:(e,n,t)=>{e.exports=t(221020)},28453:(e,n,t)=>{t.d(n,{R:()=>a,x:()=>s});var r=t(296540);const i={},o=r.createContext(i);function a(e){const n=r.useContext(o);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),r.createElement(o.Provider,{value:n},e.children)}}}]);