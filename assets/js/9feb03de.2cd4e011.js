/*! For license information please see 9feb03de.2cd4e011.js.LICENSE.txt */
"use strict";(self.webpackChunkbackstage_microsite=self.webpackChunkbackstage_microsite||[]).push([[23041],{97337:(e,n,o)=>{o.r(n),o.d(n,{assets:()=>r,contentTitle:()=>c,default:()=>h,frontMatter:()=>t,metadata:()=>a,toc:()=>l});var i=o(74848),s=o(28453);const t={id:"processors",title:"Processors",description:"How to setup notification processors"},c=void 0,a={id:"notifications/processors",title:"Processors",description:"How to setup notification processors",source:"@site/../docs/notifications/processors.md",sourceDirName:"notifications",slug:"/notifications/processors",permalink:"/docs/next/notifications/processors",draft:!1,unlisted:!1,editUrl:"https://github.com/backstage/backstage/edit/master/docs/notifications/processors.md",tags:[],version:"current",frontMatter:{id:"processors",title:"Processors",description:"How to setup notification processors"},sidebar:"docs",previous:{title:"Getting Started",permalink:"/docs/next/notifications/"},next:{title:"Usage",permalink:"/docs/next/notifications/usage"}},r={},l=[{value:"Built-in Processors",id:"built-in-processors",level:2},{value:"Email Processor",id:"email-processor",level:3},{value:"Slack Processor",id:"slack-processor",level:3},{value:"Slack Configuration",id:"slack-configuration",level:3},{value:"Configure Backstage",id:"configure-backstage",level:3},{value:"Broadcast Channel Routing",id:"broadcast-channel-routing",level:3},{value:"Route Matching Precedence",id:"route-matching-precedence",level:4},{value:"Configuration Options",id:"configuration-options",level:4},{value:"Entity Requirements",id:"entity-requirements",level:3},{value:"Observability",id:"observability",level:3}];function d(e){const n={a:"a",code:"code",h2:"h2",h3:"h3",h4:"h4",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(n.p,{children:["Notifications can be extended with ",(0,i.jsx)(n.code,{children:"NotificationProcessor"}),". These processors allow you to decorate notifications before they are sent and/or send the notifications to external services."]}),"\n",(0,i.jsx)(n.p,{children:"Depending on your needs, a processor can modify the content of a notification or route it to different systems like email, Slack, or other services."}),"\n",(0,i.jsxs)(n.p,{children:["A good example of how to write a processor is the ",(0,i.jsx)(n.a,{href:"https://github.com/backstage/backstage/tree/master/plugins/notifications-backend-module-email",children:"Email Processor"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"Start off by creating a notification processor:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"import { Notification } from '@backstage/plugin-notifications-common';\nimport { NotificationProcessor } from '@backstage/plugin-notifications-node';\n\nclass MyNotificationProcessor implements NotificationProcessor {\n  // preProcess is called before the notification is saved to database.\n  // This is a good place to modify the notification before it is saved and sent to the user.\n  async preProcess(notification: Notification): Promise<Notification> {\n    if (notification.origin === 'plugin-my-plugin') {\n      notification.payload.icon = 'my-icon';\n    }\n    return notification;\n  }\n\n  // postProcess is called after the notification is saved to database and the signal is emitted.\n  // This is a good place to send the notification to external services.\n  async postProcess(notification: Notification): Promise<void> {\n    nodemailer.sendEmail({\n      from: 'backstage',\n      to: 'user',\n      subject: notification.payload.title,\n      text: notification.payload.description,\n    });\n  }\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"Both of the processing functions are optional, and you can just implement one of them."}),"\n",(0,i.jsx)(n.p,{children:"Add the notification processor to the notification system by:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"import { notificationsProcessingExtensionPoint } from '@backstage/plugin-notifications-node';\nimport { Notification } from '@backstage/plugin-notifications-common';\n\nexport const myPlugin = createBackendPlugin({\n  pluginId: 'myPlugin',\n  register(env) {\n    env.registerInit({\n      deps: {\n        notifications: notificationsProcessingExtensionPoint,\n        // ...\n      },\n      async init({ notifications }) {\n        // ...\n        notifications.addProcessor(new MyNotificationProcessor());\n      },\n    });\n  },\n});\n"})}),"\n",(0,i.jsx)(n.h2,{id:"built-in-processors",children:"Built-in Processors"}),"\n",(0,i.jsx)(n.p,{children:"Backstage comes with some processors that can be used immediately."}),"\n",(0,i.jsx)(n.h3,{id:"email-processor",children:"Email Processor"}),"\n",(0,i.jsxs)(n.p,{children:["Email processor is used to send notifications to users using email. To install the email processor, add the ",(0,i.jsx)(n.code,{children:"@backstage/plugin-notifications-backend-module-email"})," package to your backend."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"yarn workspace backend add @backstage/plugin-notifications-backend-module-email\n"})}),"\n",(0,i.jsx)(n.p,{children:"Add the email processor to your backend:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"import { createBackend } from '@backstage/plugin-notifications-backend';\nconst backend = createBackend();\n// ...\nbackend.add(import('@backstage/plugin-notifications-backend-module-email'));\n"})}),"\n",(0,i.jsxs)(n.p,{children:["To configure the email processor, you need to add the following configuration to your ",(0,i.jsx)(n.code,{children:"app-config.yaml"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"notifications:\n  email:\n    smtp:\n      host: smtp.example.com\n      port: 587\n      secure: false\n      username: ${SMTP_USERNAME}\n      password: ${SMTP_PASSWORD}\n"})}),"\n",(0,i.jsx)(n.p,{children:"Apart from STMP, the email processor also supports the following transmissions:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"SES"}),"\n",(0,i.jsx)(n.li,{children:"sendmail"}),"\n",(0,i.jsx)(n.li,{children:"stream (only for debugging purposes)"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["See more information at ",(0,i.jsx)(n.a,{href:"https://github.com/backstage/backstage/blob/master/plugins/notifications-backend-module-email/README.md",children:"https://github.com/backstage/backstage/blob/master/plugins/notifications-backend-module-email/README.md"})]}),"\n",(0,i.jsx)(n.h3,{id:"slack-processor",children:"Slack Processor"}),"\n",(0,i.jsx)(n.p,{children:"Slack processor is used to send notifications to users and channels in Slack."}),"\n",(0,i.jsx)(n.h3,{id:"slack-configuration",children:"Slack Configuration"}),"\n",(0,i.jsxs)(n.p,{children:["To use this you'll need to create a Slack App or use an existing one. It should have at least the following scopes:\n",(0,i.jsx)(n.code,{children:"chat:write"}),", ",(0,i.jsx)(n.code,{children:"users:read"}),", ",(0,i.jsx)(n.code,{children:"im:write"})," (for direct message support)."]}),"\n",(0,i.jsxs)(n.p,{children:["Additionally you may include scopes ",(0,i.jsx)(n.code,{children:"chat:write.public"})," in order to send messages to public channels your app is not\na member of."]}),"\n",(0,i.jsxs)(n.p,{children:["These scopes are under OAuth & Permissions. You will also want to save the Bot User OAuth Token. This will be needed\nin the following step to configure ",(0,i.jsx)(n.code,{children:"app-config.yaml"}),"."]}),"\n",(0,i.jsx)(n.h3,{id:"configure-backstage",children:"Configure Backstage"}),"\n",(0,i.jsxs)(n.p,{children:["To install the Slack processor, add the ",(0,i.jsx)(n.code,{children:"@backstage/plugin-notifications-backend-module-slack"})," package to your backend."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"yarn workspace backend add @backstage/plugin-notifications-backend-module-slack\n"})}),"\n",(0,i.jsx)(n.p,{children:"Add the Slack processor to your backend:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"// packages/backend/src/index.ts\nimport { createBackend } from '@backstage/plugin-notifications-backend';\nconst backend = createBackend();\n// ...\nbackend.add(import('@backstage/plugin-notifications-backend-module-slack'));\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Using the token you obtained from your Slack App, configure the Slack module in your ",(0,i.jsx)(n.code,{children:"app-config.yaml"}),"."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'notifications:\n  processors:\n    slack:\n      - token: xoxb-XXXXXXXXX\n        broadcastChannels: # Optional, if you wish to support broadcast notifications.\n          - C12345678\n        username: \'Backstage Bot\' # Optional, defaults to the name of the Slack App.\n        concurrencyLimit: 20 # Optional, number of messages allowed per interval. Defaults to 10.\n        throttleInterval: 1m # Optional, Accepts ISO-8601 duration, ms-style ("1m", "30s"), or HumanDuration ({ minutes: 2  }). Defaults to 1 minute\n'})}),"\n",(0,i.jsxs)(n.p,{children:["Multiple instances can be added in the ",(0,i.jsx)(n.code,{children:"slack"})," array, allowing you to have multiple configurations if you need to send\nmessages to more than one Slack workspace. Org-Wide App installation is not currently supported."]}),"\n",(0,i.jsx)(n.h3,{id:"broadcast-channel-routing",children:"Broadcast Channel Routing"}),"\n",(0,i.jsxs)(n.p,{children:["For more granular control over where broadcast notifications are sent, you can use ",(0,i.jsx)(n.code,{children:"broadcastRoutes"})," to route notifications to different Slack channels based on their origin and/or topic. This is useful when you want different types of notifications to go to different channels."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"notifications:\n  processors:\n    slack:\n      - token: xoxb-XXXXXXXXX\n        # Legacy option - used as fallback when no routes match\n        broadcastChannels:\n          - general-notifications\n        # Route broadcasts based on origin and/or topic\n        broadcastRoutes:\n          # Most specific: matches both origin AND topic\n          - origin: plugin:catalog\n            topic: alerts\n            channel: catalog-alerts\n          # Origin only: all notifications from this origin\n          - origin: plugin:catalog\n            channel: catalog-updates\n          # Topic only: all notifications with this topic (any origin)\n          - topic: security\n            channel: security-team\n          # Multiple channels: send to several channels at once\n          - origin: external:monitoring\n            channel:\n              - ops-team\n              - on-call-alerts\n"})}),"\n",(0,i.jsx)(n.h4,{id:"route-matching-precedence",children:"Route Matching Precedence"}),"\n",(0,i.jsx)(n.p,{children:"Routes are evaluated in the following order of priority:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Origin + Topic match"})," (most specific) - A route that specifies both ",(0,i.jsx)(n.code,{children:"origin"})," and ",(0,i.jsx)(n.code,{children:"topic"})," will match first"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Origin-only match"})," - A route with only ",(0,i.jsx)(n.code,{children:"origin"})," specified (no ",(0,i.jsx)(n.code,{children:"topic"}),")"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Topic-only match"})," - A route with only ",(0,i.jsx)(n.code,{children:"topic"})," specified (no ",(0,i.jsx)(n.code,{children:"origin"}),")"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Default fallback"})," - If no routes match, falls back to ",(0,i.jsx)(n.code,{children:"broadcastChannels"})]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["The first matching route wins. If no routes match and no ",(0,i.jsx)(n.code,{children:"broadcastChannels"})," are configured, the broadcast notification will not be sent to Slack."]}),"\n",(0,i.jsx)(n.h4,{id:"configuration-options",children:"Configuration Options"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Property"}),(0,i.jsx)(n.th,{children:"Type"}),(0,i.jsx)(n.th,{children:"Description"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"origin"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"string"})}),(0,i.jsxs)(n.td,{children:["Optional. The notification origin to match (e.g., ",(0,i.jsx)(n.code,{children:"plugin:catalog"}),", ",(0,i.jsx)(n.code,{children:"external:my-service"}),")"]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"topic"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"string"})}),(0,i.jsxs)(n.td,{children:["Optional. The notification topic to match (e.g., ",(0,i.jsx)(n.code,{children:"alerts"}),", ",(0,i.jsx)(n.code,{children:"updates"}),", ",(0,i.jsx)(n.code,{children:"security"}),")"]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"channel"})}),(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.code,{children:"string"})," or ",(0,i.jsx)(n.code,{children:"string[]"})]}),(0,i.jsx)(n.td,{children:"Required. The Slack channel(s) to send to. Can be channel IDs, channel names, or user IDs"})]})]})]}),"\n",(0,i.jsx)(n.h3,{id:"entity-requirements",children:"Entity Requirements"}),"\n",(0,i.jsx)(n.p,{children:"Entities must be annotated with the following annotation:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"slack.com/bot-notify"})}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["The value may be any Slack ID supported by ",(0,i.jsx)(n.a,{href:"https://api.slack.com/methods/chat.postMessage",children:"chat.postMessage"}),", for example a user (U12345678), channel (C12345678), group, or direct message chat."]}),"\n",(0,i.jsx)(n.p,{children:"It's also possible to use a user's email address or channel name, however IDs are recommended by Slack.\nPrivate channels/chats must use an ID."}),"\n",(0,i.jsx)(n.h3,{id:"observability",children:"Observability"}),"\n",(0,i.jsx)(n.p,{children:"The processor includes the following counter metrics if you are exporting metrics using OpenTelemetry:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"notifications.processors.slack.sent.count"})," - The number of messages sent"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"notifications.processors.slack.error.count"})," - The number of messages that failed to send"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},21020:(e,n,o)=>{var i=o(96540),s=Symbol.for("react.element"),t=Symbol.for("react.fragment"),c=Object.prototype.hasOwnProperty,a=i.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,r={key:!0,ref:!0,__self:!0,__source:!0};function l(e,n,o){var i,t={},l=null,d=null;for(i in void 0!==o&&(l=""+o),void 0!==n.key&&(l=""+n.key),void 0!==n.ref&&(d=n.ref),n)c.call(n,i)&&!r.hasOwnProperty(i)&&(t[i]=n[i]);if(e&&e.defaultProps)for(i in n=e.defaultProps)void 0===t[i]&&(t[i]=n[i]);return{$$typeof:s,type:e,key:l,ref:d,props:t,_owner:a.current}}n.Fragment=t,n.jsx=l,n.jsxs=l},74848:(e,n,o)=>{e.exports=o(21020)},28453:(e,n,o)=>{o.d(n,{R:()=>c,x:()=>a});var i=o(96540);const s={},t=i.createContext(s);function c(e){const n=i.useContext(t);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:c(e.components),i.createElement(t.Provider,{value:n},e.children)}}}]);