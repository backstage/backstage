"use strict";(self.webpackChunkbackstage_microsite=self.webpackChunkbackstage_microsite||[]).push([["52248"],{440510(e,s,t){t.r(s),t.d(s,{assets:()=>a,contentTitle:()=>o,default:()=>l,frontMatter:()=>i,metadata:()=>n,toc:()=>d});var n=t(324847),r=t(474848),c=t(28453);let i={id:"adrs-adr014",title:"ADR014: Proper use of HTTP fetching libraries",description:"Architecture Decision Record (ADR) for the proper use of fetchApiRef, native fetch, and cross-fetch for data fetching."},o,a={},d=[{value:"Context",id:"context",level:2},{value:"Decision",id:"decision",level:2},{value:"Consequences",id:"consequences",level:2}];function h(e){let s={a:"a",code:"code",h2:"h2",p:"p",pre:"pre",...(0,c.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(s.h2,{id:"context",children:"Context"}),"\n",(0,r.jsxs)(s.p,{children:["Until now we have been recommending the use of ",(0,r.jsx)(s.code,{children:"node-fetch"})," in Node.js contexts\nthrough ",(0,r.jsx)(s.a,{href:"/docs/next/architecture-decisions/adrs-adr013",children:"ADR013"}),". Since then, Backstage has had its\nminimum requirements upgraded to Node.js 20 or newer. The Node.js platform has\nestablished a stable, reliable ",(0,r.jsx)(s.code,{children:"undici"})," based native ",(0,r.jsx)(s.code,{children:"fetch"})," in these versions.\nAdditionally, there are ",(0,r.jsx)(s.a,{href:"https://github.com/backstage/backstage/issues/24590",children:"some issues"}),"\nwith using third party libraries that only appeared in newer versions of\nNode.js."]}),"\n",(0,r.jsx)(s.h2,{id:"decision",children:"Decision"}),"\n",(0,r.jsxs)(s.p,{children:["All code that is executed in Node.js (including backend and CLIs) should use the\nnative ",(0,r.jsx)(s.code,{children:"fetch"})," for HTTP data fetching, and ",(0,r.jsx)(s.code,{children:"typeof fetch"})," as the TypeScript type\nin code where a ",(0,r.jsx)(s.code,{children:"fetch"})," implementation can be injected or is referred to.\nExample:"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-ts",children:"import { ResponseError } from '@backstage/errors';\n\n// this is implicitly global.fetch\nconst response = await fetch('https://example.com/api/v1/users.json');\nif (!response.ok) {\n  throw await ResponseError.fromResponse(response);\n}\nconst users = await response.json();\n"})}),"\n",(0,r.jsxs)(s.p,{children:["Frontend plugins and packages should prefer to use the\n",(0,r.jsx)(s.a,{href:"https://backstage.io/api/stable/variables/_backstage_core-plugin-api.index.fetchApiRef.html",children:(0,r.jsx)(s.code,{children:"fetchApiRef"})}),"."]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-ts",children:"import { useApi } from '@backstage/core-plugin-api';\n\n// Inside some React component...\nconst { fetch } = useApi(fetchApiRef);\n\nconst response = await fetch('https://example.com/api/v1/users.json');\nif (!response.ok) {\n  throw await ResponseError.fromResponse(response);\n}\nconst users = await response.json();\n"})}),"\n",(0,r.jsxs)(s.p,{children:["Isomorphic packages should have a dependency on the ",(0,r.jsx)(s.code,{children:"cross-fetch"})," package for\nmocking and type definitions. Preferably, classes and functions in isomorphic\npackages should accept an argument of type ",(0,r.jsx)(s.code,{children:"typeof fetch"})," to let callers supply\ntheir preferred implementation of ",(0,r.jsx)(s.code,{children:"fetch"}),". This lets them adorn the calls with\nauth or other information, and track metrics etc, in a cross-platform way.\nExample:"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-ts",children:"import crossFetch from 'cross-fetch';\n\nexport class MyClient {\n  private readonly fetch: typeof crossFetch;\n\n  constructor(options: { fetch?: typeof crossFetch }) {\n    this.fetch = options.fetch || crossFetch;\n  }\n\n  async users() {\n    return await this.fetch('https://example.com/api/v1/users.json');\n  }\n}\n"})}),"\n",(0,r.jsx)(s.h2,{id:"consequences",children:"Consequences"}),"\n",(0,r.jsxs)(s.p,{children:["We will gradually transition away from third party ",(0,r.jsx)(s.code,{children:"fetch"})," replacement packages\nsuch as ",(0,r.jsx)(s.code,{children:"node-fetch"})," and others on the Node.js platform."]}),"\n",(0,r.jsxs)(s.p,{children:["The ",(0,r.jsx)(s.code,{children:"@mswjs/interceptors"})," library as used by ",(0,r.jsx)(s.code,{children:"msw"})," version 1.x ",(0,r.jsx)(s.a,{href:"https://github.com/mswjs/msw/issues/1563#issuecomment-1694249010",children:"does not support native fetch properly"})," and likely never will. When you switch to using native fetch, you may see ",(0,r.jsx)(s.code,{children:"msw"})," based tests start to fail to both capture and block traffic. Certain tests may need to be rewritten to use ",(0,r.jsx)(s.code,{children:"msw"})," 2.x or newer instead, which uses a newer version of the interceptors."]})]})}function l(e={}){let{wrapper:s}={...(0,c.R)(),...e.components};return s?(0,r.jsx)(s,{...e,children:(0,r.jsx)(h,{...e})}):h(e)}},28453(e,s,t){t.d(s,{R:()=>i,x:()=>o});var n=t(296540);let r={},c=n.createContext(r);function i(e){let s=n.useContext(c);return n.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function o(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),n.createElement(c.Provider,{value:s},e.children)}},324847(e){e.exports=JSON.parse('{"id":"architecture-decisions/adrs-adr014","title":"ADR014: Proper use of HTTP fetching libraries","description":"Architecture Decision Record (ADR) for the proper use of fetchApiRef, native fetch, and cross-fetch for data fetching.","source":"@site/../docs/architecture-decisions/adr014-use-fetch.md","sourceDirName":"architecture-decisions","slug":"/architecture-decisions/adrs-adr014","permalink":"/docs/next/architecture-decisions/adrs-adr014","draft":false,"unlisted":false,"editUrl":"https://github.com/backstage/backstage/edit/master/docs/architecture-decisions/adr014-use-fetch.md","tags":[],"version":"current","frontMatter":{"id":"adrs-adr014","title":"ADR014: Proper use of HTTP fetching libraries","description":"Architecture Decision Record (ADR) for the proper use of fetchApiRef, native fetch, and cross-fetch for data fetching."},"sidebar":"docs","previous":{"title":"ADR013: [superseded] Proper use of HTTP fetching libraries","permalink":"/docs/next/architecture-decisions/adrs-adr013"},"next":{"title":"ADR015: Types and naming for element and component options","permalink":"/docs/next/architecture-decisions/adrs-adr015"}}')}}]);