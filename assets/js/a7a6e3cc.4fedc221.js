/*! For license information please see a7a6e3cc.4fedc221.js.LICENSE.txt */
"use strict";(self.webpackChunkbackstage_microsite=self.webpackChunkbackstage_microsite||[]).push([[525184],{583021:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>u,frontMatter:()=>r,metadata:()=>a,toc:()=>c});var i=s(474848),t=s(28453);const r={id:"authorizing-scaffolder-template-details",title:"Authorizing scaffolder tasks, parameters, steps, and actions",description:"How to authorize parts of a template and authorize scaffolder task access"},o=void 0,a={id:"features/software-templates/authorizing-scaffolder-template-details",title:"Authorizing scaffolder tasks, parameters, steps, and actions",description:"How to authorize parts of a template and authorize scaffolder task access",source:"@site/../docs/features/software-templates/authorizing-scaffolder-template-details.md",sourceDirName:"features/software-templates",slug:"/features/software-templates/authorizing-scaffolder-template-details",permalink:"/docs/next/features/software-templates/authorizing-scaffolder-template-details",draft:!1,unlisted:!1,editUrl:"https://github.com/backstage/backstage/edit/master/docs/features/software-templates/authorizing-scaffolder-template-details.md",tags:[],version:"current",frontMatter:{id:"authorizing-scaffolder-template-details",title:"Authorizing scaffolder tasks, parameters, steps, and actions",description:"How to authorize parts of a template and authorize scaffolder task access"},sidebar:"docs",previous:{title:"Writing custom step layouts",permalink:"/docs/next/features/software-templates/writing-custom-step-layouts"},next:{title:"Migrating to react-jsonschema-form@v5",permalink:"/docs/next/features/software-templates/migrating-to-rjsf-v5"}},l={},c=[{value:"Authorizing parameters and steps",id:"authorizing-parameters-and-steps",level:3},{value:"Authorizing actions",id:"authorizing-actions",level:3},{value:"Authorizing scaffolder tasks",id:"authorizing-scaffolder-tasks",level:3},{value:"Authorizing in the New Backend System",id:"authorizing-in-the-new-backend-system",level:3}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h3:"h3",li:"li",p:"p",pre:"pre",ul:"ul",...(0,t.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(n.p,{children:["The scaffolder plugin integrates with the Backstage ",(0,i.jsx)(n.a,{href:"/docs/next/permissions/overview",children:"permission framework"}),", which allows you to control access to certain parameters and steps in your templates based on the user executing the template. It also allows you to control access to scaffolder tasks."]}),"\n",(0,i.jsx)(n.h3,{id:"authorizing-parameters-and-steps",children:"Authorizing parameters and steps"}),"\n",(0,i.jsxs)(n.p,{children:["To mark specific parameters or steps as requiring permission, add the ",(0,i.jsx)(n.code,{children:"backstage:permissions"})," property to the parameter or step with one or more tags. For example:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"apiVersion: scaffolder.backstage.io/v1beta3\nkind: Template\nmetadata:\n  name: my_custom_template\nspec:\n  type: service\n  parameters:\n    - title: Provide some simple information\n      properties:\n        title:\n          title: Title\n          type: string\n    - title: Extra information\n      properties:\n        description:\n          title: Description\n          type: string\n      backstage:permissions:\n        tags:\n          - secret\n  steps:\n    - id: step1\n      name: First log\n      action: debug:log\n      input:\n        message: hello\n    - id: step2\n      name: Log message\n      action: debug:log\n      input:\n        message: hello\n      backstage:permissions:\n        tags:\n          - secret\n"})}),"\n",(0,i.jsxs)(n.p,{children:["In this example, the ",(0,i.jsx)(n.code,{children:"description"})," parameter and the ",(0,i.jsx)(n.code,{children:"step2"})," step are marked with the ",(0,i.jsx)(n.code,{children:"secret"})," tag."]}),"\n",(0,i.jsxs)(n.p,{children:["To conditionally authorize parameters and steps based on the user executing the template, ",(0,i.jsx)(n.a,{href:"/docs/next/permissions/writing-a-policy",children:"edit your permission policy"}),", by targeting ",(0,i.jsx)(n.code,{children:"templateParameterReadPermission"})," and ",(0,i.jsx)(n.code,{children:"templateStepReadPermission"})," permissions, which are provided by the scaffolder plugin. For example:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",metastring:'title="packages/backend/src/plugins/permission.ts"',children:"/* highlight-add-start */\nimport {\n  templateParameterReadPermission,\n  templateStepReadPermission,\n} from '@backstage/plugin-scaffolder-common/alpha';\nimport {\n  createScaffolderActionConditionalDecision,\n  scaffolderTemplateConditions,\n} from '@backstage/plugin-scaffolder-backend/alpha';\n/* highlight-add-end */\n\nclass ExamplePermissionPolicy implements PermissionPolicy {\n  async handle(\n    request: PolicyQuery,\n    user?: PolicyQueryUser,\n  ): Promise<PolicyDecision> {\n    /* highlight-add-start */\n    if (\n      isPermission(request.permission, templateParameterReadPermission) ||\n      isPermission(request.permission, templateStepReadPermission)\n    ) {\n      if (user?.info.userEntityRef === 'user:default/bob')\n        return createScaffolderTemplateConditionalDecision(request.permission, {\n          not: scaffolderTemplateConditions.hasTag({ tag: 'secret' }),\n        });\n    }\n    /* highlight-add-end */\n\n    return {\n      result: AuthorizeResult.ALLOW,\n    };\n  }\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:["In this example, the user ",(0,i.jsx)(n.code,{children:"bob"})," is not authorized to read parameters or steps marked with the ",(0,i.jsx)(n.code,{children:"secret"})," tag."]}),"\n",(0,i.jsx)(n.p,{children:"By combining this feature with restricting the ingestion of templates in the Catalog as recommended in our threat model, you can create a solid system to restrict certain actions."}),"\n",(0,i.jsx)(n.h3,{id:"authorizing-actions",children:"Authorizing actions"}),"\n",(0,i.jsx)(n.p,{children:"Similar to parameters and steps, the scaffolder plugin exposes permissions to restrict access to certain actions. This can be useful if you want to secure your templates."}),"\n",(0,i.jsx)(n.p,{children:"To restrict access to a particular action, you can modify your permission policy as follows:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",metastring:'title="packages/backend/src/plugins/permission.ts"',children:"/* highlight-add-start */\nimport { actionExecutePermission } from '@backstage/plugin-scaffolder-common/alpha';\nimport {\n  createScaffolderActionConditionalDecision,\n  scaffolderActionConditions,\n} from '@backstage/plugin-scaffolder-backend/alpha';\n/* highlight-add-end */\n\nclass ExamplePermissionPolicy implements PermissionPolicy {\n  async handle(\n    request: PolicyQuery,\n    user?: PolicyQueryUser,\n  ): Promise<PolicyDecision> {\n    /* highlight-add-start */\n    if (isPermission(request.permission, actionExecutePermission)) {\n      if (user?.info.userEntityRef === 'user:default/alice') {\n        return createScaffolderActionConditionalDecision(request.permission, {\n          not: scaffolderActionConditions.hasActionId({\n            actionId: 'debug:log',\n          }),\n        });\n      }\n    }\n    /* highlight-add-end */\n\n    return {\n      result: AuthorizeResult.ALLOW,\n    };\n  }\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:["With this permission policy, the user ",(0,i.jsx)(n.code,{children:"alice"})," won't be able to execute the ",(0,i.jsx)(n.code,{children:"debug:log"})," action."]}),"\n",(0,i.jsxs)(n.p,{children:["You can also restrict the input provided to the action by combining multiple rules.\nIn the example below, ",(0,i.jsx)(n.code,{children:"alice"})," won't be able to execute ",(0,i.jsx)(n.code,{children:"debug:log"})," when passing ",(0,i.jsx)(n.code,{children:'{ "message": "not-this!" }'})," as action input:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",metastring:'title="packages/backend/src/plugins/permission.ts"',children:"/* highlight-add-start */\nimport { actionExecutePermission } from '@backstage/plugin-scaffolder-common/alpha';\nimport {\n  createScaffolderActionConditionalDecision,\n  scaffolderActionConditions,\n} from '@backstage/plugin-scaffolder-backend/alpha';\n/* highlight-add-end */\n\nclass ExamplePermissionPolicy implements PermissionPolicy {\n  async handle(\n    request: PolicyQuery,\n    user?: PolicyQueryUser,\n  ): Promise<PolicyDecision> {\n    /* highlight-add-start */\n    if (isPermission(request.permission, actionExecutePermission)) {\n      if (user?.info.userEntityRef === 'user:default/alice') {\n        return createScaffolderActionConditionalDecision(request.permission, {\n          not: {\n            allOf: [\n              scaffolderActionConditions.hasActionId({ actionId: 'debug:log' }),\n              scaffolderActionConditions.hasProperty({\n                key: 'message',\n                value: 'not-this!',\n              }),\n            ],\n          },\n        });\n      }\n    }\n    /* highlight-add-end */\n\n    return {\n      result: AuthorizeResult.ALLOW,\n    };\n  }\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"authorizing-scaffolder-tasks",children:"Authorizing scaffolder tasks"}),"\n",(0,i.jsx)(n.p,{children:"The scaffolder plugin also exposes permissions that can restrict access to tasks, task logs, task creation, and task cancellation. This can be useful if you want to control who has access to these areas of the scaffolder. You can configure policies to restrict access to tasks to only their creators, while also granting specific users the permission to view all tasks."}),"\n",(0,i.jsx)(n.p,{children:"The following is a simple example of how to do this:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",metastring:'title="packages/src/backend/plugins/permissions.ts"',children:"/* highlight-add-start */\nimport {\n  taskCancelPermission,\n  taskCreatePermission,\n  taskReadPermission,\n} from '@backstage/plugin-scaffolder-common/alpha';\nimport {\n  AuthorizeResult,\n  isPermission,\n  PolicyDecision,\n} from '@backstage/plugin-permission-common';\nimport {\n  PermissionPolicy,\n  PolicyQuery,\n  PolicyQueryUser,\n} from '@backstage/plugin-permission-node';\nimport {\n  createScaffolderTaskConditionalDecision,\n  scaffolderTaskConditions,\n} from '@backstage/plugin-scaffolder-backend/alpha';\n/* highlight-add-end */\n\nclass ExamplePermissionPolicy implements PermissionPolicy {\n  async handle(\n    request: PolicyQuery,\n    user?: PolicyQueryUser,\n  ): Promise<PolicyDecision> {\n    /* highlight-add-start */\n    if (isPermission(request.permission, taskReadPermission)) {\n      // Allow alice to read any task\n      if (user?.info.userEntityRef === 'user:default/alice') {\n        return {\n          result: AuthorizeResult.ALLOW,\n        };\n      }\n\n      // Allow users to read tasks they created\n      return createScaffolderTaskConditionalDecision(\n        request.permission,\n        scaffolderTaskConditions.isTaskOwner({\n          createdBy: user?.info.userEntityRef ? [user?.info.userEntityRef] : [],\n        }),\n      );\n    }\n\n    if (isPermission(request.permission, taskCreatePermission)) {\n      const userArray = ['user:default/bob', 'user:default/alice'];\n      const allowed = userArray.some(\n        allowedUser => user?.info.userEntityRef === allowedUser,\n      );\n      if (allowed) {\n        return {\n          result: AuthorizeResult.ALLOW,\n        };\n      }\n      return {\n        result: AuthorizeResult.DENY,\n      };\n    }\n    if (isPermission(request.permission, taskCancelPermission)) {\n      // Allow bob to cancel only his tasks\n      if (user?.info.userEntityRef === 'user:default/bob') {\n        return createScaffolderTaskConditionalDecision(\n          request.permission,\n          scaffolderTaskConditions.isTaskOwner({\n            createdBy: user?.info.userEntityRef\n              ? [user?.info.userEntityRef]\n              : [],\n          }),\n        );\n      }\n      // Allow alice to cancel any task\n      if (user?.info.userEntityRef === 'user:default/alice') {\n        return {\n          result: AuthorizeResult.ALLOW,\n        };\n      }\n      return {\n        result: AuthorizeResult.DENY,\n      };\n    }\n    /* highlight-add-end */\n\n    return {\n      result: AuthorizeResult.DENY,\n    };\n  }\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:["In the provided example permission policy, we only grant the user ",(0,i.jsx)(n.code,{children:"bob"})," permissions to perform/access the following actions/resources:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Read scaffolder tasks and their associated events/logs for tasks created by ",(0,i.jsx)(n.code,{children:"bob"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["Cancel ongoing scaffolder tasks created by ",(0,i.jsx)(n.code,{children:"bob"}),"."]}),"\n",(0,i.jsx)(n.li,{children:"Trigger software templates, which effectively creates new scaffolder tasks."}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["On the other hand, the user ",(0,i.jsx)(n.code,{children:"alice"})," is granted:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Read access to all scaffolder tasks and their associated events/logs."}),"\n",(0,i.jsx)(n.li,{children:"The ability to cancel any ongoing scaffolder task."}),"\n",(0,i.jsx)(n.li,{children:"The ability to trigger software templates."}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"All other users are granted permissions to perform/access the following actions/resources:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Read scaffolder tasks and their associated events/logs for tasks created by the user."}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Although the rules exported by the scaffolder are simple, combining them can help you achieve more complex use cases."}),"\n",(0,i.jsx)(n.h3,{id:"authorizing-in-the-new-backend-system",children:"Authorizing in the New Backend System"}),"\n",(0,i.jsxs)(n.p,{children:["Instead of the changes in ",(0,i.jsx)(n.code,{children:"permission.ts"})," noted in the above example you will make them in your ",(0,i.jsx)(n.code,{children:"index.ts"}),". You will need to create a module where your permission policy will get added. Here is a very simplified example of how to do that:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",metastring:'title="packages/backend/src/index.ts"',children:"import { createBackendModule } from '@backstage/backend-plugin-api';\nimport {\n  PolicyDecision,\n  AuthorizeResult,\n} from '@backstage/plugin-permission-common';\nimport {\n  PermissionPolicy,\n  PolicyQuery,\n  PolicyQueryUser,\n} from '@backstage/plugin-permission-node';\nimport { policyExtensionPoint } from '@backstage/plugin-permission-node/alpha';\n\nclass ExamplePermissionPolicy implements PermissionPolicy {\n  async handle(\n    request: PolicyQuery,\n    user?: PolicyQueryUser,\n  ): Promise<PolicyDecision> {\n    // Various scaffolder permission checks ...\n\n    return {\n      result: AuthorizeResult.ALLOW,\n    };\n  }\n}\n\nconst customPermissionBackendModule = createBackendModule({\n  pluginId: 'permission',\n  moduleId: 'allow-all-policy',\n  register(reg) {\n    reg.registerInit({\n      deps: { policy: policyExtensionPoint },\n      async init({ policy }) {\n        policy.setPolicy(new ExamplePermissionPolicy());\n      },\n    });\n  },\n});\n\nconst backend = createBackend();\n\n// Other plugins...\n\n/* highlight-add-start */\nbackend.add(import('@backstage/plugin-permission-backend'));\nbackend.add(customPermissionBackendModule);\n/* highlight-add-end */\n"})}),"\n",(0,i.jsx)(n.admonition,{title:"Note",type:"note",children:(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"ExamplePermissionPolicy"})," here could be the one from the ",(0,i.jsx)(n.a,{href:"#authorizing-parameters-and-steps",children:"Authorizing parameters and steps"})," example or from the ",(0,i.jsx)(n.a,{href:"#authorizing-actions",children:"Authorizing actions"})," example. It would work the same way for both of them."]})})]})}function u(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},221020:(e,n,s)=>{var i=s(296540),t=Symbol.for("react.element"),r=Symbol.for("react.fragment"),o=Object.prototype.hasOwnProperty,a=i.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,l={key:!0,ref:!0,__self:!0,__source:!0};function c(e,n,s){var i,r={},c=null,d=null;for(i in void 0!==s&&(c=""+s),void 0!==n.key&&(c=""+n.key),void 0!==n.ref&&(d=n.ref),n)o.call(n,i)&&!l.hasOwnProperty(i)&&(r[i]=n[i]);if(e&&e.defaultProps)for(i in n=e.defaultProps)void 0===r[i]&&(r[i]=n[i]);return{$$typeof:t,type:e,key:c,ref:d,props:r,_owner:a.current}}n.Fragment=r,n.jsx=c,n.jsxs=c},474848:(e,n,s)=>{e.exports=s(221020)},28453:(e,n,s)=>{s.d(n,{R:()=>o,x:()=>a});var i=s(296540);const t={},r=i.createContext(t);function o(e){const n=i.useContext(r);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:o(e.components),i.createElement(r.Provider,{value:n},e.children)}}}]);