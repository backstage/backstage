"use strict";(self.webpackChunkbackstage_microsite=self.webpackChunkbackstage_microsite||[]).push([["45950"],{883073(e,n,t){t.r(n),t.d(n,{assets:()=>a,contentTitle:()=>o,default:()=>p,frontMatter:()=>c,metadata:()=>s,toc:()=>d});var s=t(216536),i=t(474848),r=t(28453);let c={id:"testing",title:"Testing with Utility APIs",sidebar_label:"Testing",description:"Mocking and testing Utility APIs"},o,a={},d=[{value:"The <code>mockApis</code> namespace",id:"the-mockapis-namespace",level:2},{value:"Fake instances",id:"fake-instances",level:3},{value:"Jest mocks",id:"jest-mocks",level:3},{value:"Providing mock APIs in tests",id:"providing-mock-apis-in-tests",level:2},{value:"With <code>renderInTestApp</code>",id:"with-renderintestapp",level:3},{value:"With <code>renderTestApp</code>",id:"with-rendertestapp",level:3},{value:"With <code>TestApiProvider</code>",id:"with-testapiprovider",level:3},{value:"Plugin-specific test mocks",id:"plugin-specific-test-mocks",level:2},{value:"Creating your own mock APIs",id:"creating-your-own-mock-apis",level:3},{value:"Available mock APIs",id:"available-mock-apis",level:2}];function l(e){let n={code:"code",h2:"h2",h3:"h3",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(n.p,{children:["When testing frontend components and extensions, you often need to provide mock implementations of the utility APIs they depend on. The ",(0,i.jsx)(n.code,{children:"@backstage/frontend-test-utils"})," package provides the ",(0,i.jsx)(n.code,{children:"mockApis"})," namespace with ready-made mocks for all core utility APIs."]}),"\n",(0,i.jsxs)(n.h2,{id:"the-mockapis-namespace",children:["The ",(0,i.jsx)(n.code,{children:"mockApis"})," namespace"]}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"mockApis"})," namespace is the main entry point for creating mock utility API instances in tests. It provides two usage patterns for each API:"]}),"\n",(0,i.jsx)(n.h3,{id:"fake-instances",children:"Fake instances"}),"\n",(0,i.jsx)(n.p,{children:"Call the API function directly to create a fake instance with simplified but functional behavior. These are useful when your test needs the API to actually work, not just be stubbed."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"import { mockApis } from '@backstage/frontend-test-utils';\n\nconst configApi = mockApis.config({ data: { app: { title: 'Test' } } });\nconfigApi.getString('app.title'); // 'Test'\n\nconst alertApi = mockApis.alert();\nalertApi.post({ message: 'hello' });\nexpect(alertApi.getAlerts()).toHaveLength(1);\n"})}),"\n",(0,i.jsx)(n.h3,{id:"jest-mocks",children:"Jest mocks"}),"\n",(0,i.jsxs)(n.p,{children:["Call ",(0,i.jsx)(n.code,{children:".mock()"})," to get an instance where every method is a ",(0,i.jsx)(n.code,{children:"jest.fn()"}),". You can optionally provide partial implementations. This is useful when you want to assert that specific methods were called."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"import { mockApis } from '@backstage/frontend-test-utils';\nimport { AuthorizeResult } from '@backstage/plugin-permission-common';\n\nconst permissionApi = mockApis.permission.mock({\n  authorize: async () => ({ result: AuthorizeResult.ALLOW }),\n});\n\n// ... exercise the component ...\n\nexpect(permissionApi.authorize).toHaveBeenCalledTimes(1);\n"})}),"\n",(0,i.jsx)(n.h2,{id:"providing-mock-apis-in-tests",children:"Providing mock APIs in tests"}),"\n",(0,i.jsxs)(n.h3,{id:"with-renderintestapp",children:["With ",(0,i.jsx)(n.code,{children:"renderInTestApp"})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-tsx",children:"import { screen } from '@testing-library/react';\nimport { renderInTestApp, mockApis } from '@backstage/frontend-test-utils';\n\nawait renderInTestApp(<MyComponent />, {\n  apis: [\n    mockApis.identity({ userEntityRef: 'user:default/guest' }),\n    mockApis.config({ data: { app: { title: 'Test App' } } }),\n  ],\n});\n"})}),"\n",(0,i.jsxs)(n.p,{children:["You can also use the ",(0,i.jsx)(n.code,{children:"[apiRef, implementation]"})," tuple syntax to provide any API implementation, including ones that aren't from ",(0,i.jsx)(n.code,{children:"mockApis"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-tsx",children:"import { myCustomApiRef } from '../apis';\n\nconst myCustomApiInstance = {\n  // ...\n};\n\nawait renderInTestApp(<MyComponent />, {\n  apis: [\n    mockApis.identity({ userEntityRef: 'user:default/guest' }),\n    [myCustomApiRef, myCustomApiInstance],\n  ],\n});\n"})}),"\n",(0,i.jsxs)(n.h3,{id:"with-rendertestapp",children:["With ",(0,i.jsx)(n.code,{children:"renderTestApp"})]}),"\n",(0,i.jsxs)(n.p,{children:["The same ",(0,i.jsx)(n.code,{children:"apis"})," option is available on ",(0,i.jsx)(n.code,{children:"renderTestApp"}),", which is commonly used when testing extensions or entity pages:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-tsx",children:"import { renderTestApp, mockApis } from '@backstage/frontend-test-utils';\nimport { createTestEntityPage } from '@backstage/plugin-catalog-react/testUtils';\n\nrenderTestApp({\n  extensions: [createTestEntityPage({ entity }), myEntityCard],\n  apis: [mockApis.permission()],\n});\n"})}),"\n",(0,i.jsxs)(n.h3,{id:"with-testapiprovider",children:["With ",(0,i.jsx)(n.code,{children:"TestApiProvider"})]}),"\n",(0,i.jsxs)(n.p,{children:["For standalone rendering scenarios where you're not using ",(0,i.jsx)(n.code,{children:"renderInTestApp"}),", the ",(0,i.jsx)(n.code,{children:"TestApiProvider"})," component accepts the same ",(0,i.jsx)(n.code,{children:"apis"})," format:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-tsx",children:"import { render } from '@testing-library/react';\nimport { TestApiProvider, mockApis } from '@backstage/frontend-test-utils';\n\nrender(\n  <TestApiProvider\n    apis={[\n      mockApis.identity({ userEntityRef: 'user:default/guest' }),\n      mockApis.alert(),\n    ]}\n  >\n    <MyComponent />\n  </TestApiProvider>,\n);\n"})}),"\n",(0,i.jsx)(n.h2,{id:"plugin-specific-test-mocks",children:"Plugin-specific test mocks"}),"\n",(0,i.jsxs)(n.p,{children:["Plugins can provide their own mock APIs that follow the same pattern. For example, ",(0,i.jsx)(n.code,{children:"@backstage/plugin-catalog-react"})," provides ",(0,i.jsx)(n.code,{children:"catalogApiMock"})," in its ",(0,i.jsx)(n.code,{children:"/testUtils"})," entry point:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-tsx",children:"import { renderTestApp } from '@backstage/frontend-test-utils';\nimport { catalogApiMock } from '@backstage/plugin-catalog-react/testUtils';\n\nrenderTestApp({\n  extensions: [myExtension],\n  apis: [catalogApiMock({ entities: [entity] })],\n});\n"})}),"\n",(0,i.jsx)(n.h3,{id:"creating-your-own-mock-apis",children:"Creating your own mock APIs"}),"\n",(0,i.jsxs)(n.p,{children:["If you maintain a plugin that exposes a utility API, you can provide mock utilities that follow the same function + ",(0,i.jsx)(n.code,{children:".mock()"})," pattern as the built-in ",(0,i.jsx)(n.code,{children:"mockApis"}),"."]}),"\n",(0,i.jsxs)(n.p,{children:["Use ",(0,i.jsx)(n.code,{children:"attachMockApiFactory"})," for fake instances with real behavior, and ",(0,i.jsx)(n.code,{children:"createApiMock"})," for the jest-mocked ",(0,i.jsx)(n.code,{children:".mock()"})," variant where all methods are ",(0,i.jsx)(n.code,{children:"jest.fn()"}),". The full pattern looks like this:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"import {\n  attachMockApiFactory,\n  createApiMock,\n  type ApiMock,\n} from '@backstage/frontend-test-utils';\nimport { myApiRef, type MyApi } from '@internal/plugin-example-react';\n\n// Fake instance with real behavior\nexport function myApiMock(options?: { greeting?: string }) {\n  return attachMockApiFactory(myApiRef, {\n    greet: async () => options?.greeting ?? 'Hello!',\n  });\n}\n\n// Jest mock variant where all methods are jest.fn()\nexport namespace myApiMock {\n  export const mock = createApiMock(myApiRef, () => ({\n    greet: jest.fn(),\n  }));\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"Consumers can then use it just like the core mocks:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-tsx",children:"// Fake with real behavior\nawait renderInTestApp(<MyComponent />, {\n  apis: [myApiMock({ greeting: 'Hi there!' })],\n});\n\n// Jest mock for assertions\nconst api = myApiMock.mock({\n  greet: async () => 'mocked',\n});\n\nawait renderInTestApp(<MyComponent />, {\n  apis: [api],\n});\n\nexpect(api.greet).toHaveBeenCalledTimes(1);\n"})}),"\n",(0,i.jsx)(n.h2,{id:"available-mock-apis",children:"Available mock APIs"}),"\n",(0,i.jsxs)(n.p,{children:["The table below lists all core APIs available through the ",(0,i.jsx)(n.code,{children:"mockApis"})," namespace."]}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"API"}),(0,i.jsx)(n.th,{children:"Fake instance"}),(0,i.jsx)(n.th,{children:"Notes"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"mockApis.alert()"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"MockAlertApi"})}),(0,i.jsxs)(n.td,{children:["Collects alerts; has ",(0,i.jsx)(n.code,{children:"getAlerts()"}),", ",(0,i.jsx)(n.code,{children:"clearAlerts()"}),", ",(0,i.jsx)(n.code,{children:"waitForAlert()"})]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"mockApis.analytics()"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"MockAnalyticsApi"})}),(0,i.jsxs)(n.td,{children:["Collects events; has ",(0,i.jsx)(n.code,{children:"getEvents()"})]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"mockApis.config({ data })"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"MockConfigApi"})}),(0,i.jsx)(n.td,{children:"Reads from a plain JSON object"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"mockApis.discovery({ baseUrl })"})}),(0,i.jsx)(n.td,{children:"Inline"}),(0,i.jsxs)(n.td,{children:["Returns ",(0,i.jsx)(n.code,{children:"${baseUrl}/api/${pluginId}"}),", defaults to ",(0,i.jsx)(n.code,{children:"http://example.com"})]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"mockApis.error(options?)"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"MockErrorApi"})}),(0,i.jsxs)(n.td,{children:["Collects errors; has ",(0,i.jsx)(n.code,{children:"getErrors()"}),", ",(0,i.jsx)(n.code,{children:"waitForError()"})]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"mockApis.featureFlags(options?)"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"MockFeatureFlagsApi"})}),(0,i.jsxs)(n.td,{children:["In-memory flag state; has ",(0,i.jsx)(n.code,{children:"getState()"}),", ",(0,i.jsx)(n.code,{children:"setState()"}),", ",(0,i.jsx)(n.code,{children:"clearState()"})]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"mockApis.fetch(options?)"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"MockFetchApi"})}),(0,i.jsxs)(n.td,{children:["Wraps native ",(0,i.jsx)(n.code,{children:"fetch"}),"; supports identity injection and plugin protocol"]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"mockApis.identity(options?)"})}),(0,i.jsx)(n.td,{children:"Inline"}),(0,i.jsx)(n.td,{children:"Configurable user ref, ownership, token, profile"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"mockApis.permission(options?)"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"MockPermissionApi"})}),(0,i.jsxs)(n.td,{children:["Defaults to ",(0,i.jsx)(n.code,{children:"ALLOW"}),"; accepts a handler function"]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"mockApis.storage({ data })"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"MockStorageApi"})}),(0,i.jsx)(n.td,{children:"In-memory storage with bucket support"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"mockApis.translation()"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"MockTranslationApi"})}),(0,i.jsx)(n.td,{children:"Passthrough returning default messages from translation refs"})]})]})]}),"\n",(0,i.jsxs)(n.p,{children:["Each of these also has a ",(0,i.jsx)(n.code,{children:".mock()"})," variant that returns jest mocks, as described above."]})]})}function p(e={}){let{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(l,{...e})}):l(e)}},28453(e,n,t){t.d(n,{R:()=>c,x:()=>o});var s=t(296540);let i={},r=s.createContext(i);function c(e){let n=s.useContext(r);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:c(e.components),s.createElement(r.Provider,{value:n},e.children)}},216536(e){e.exports=JSON.parse('{"id":"frontend-system/utility-apis/testing","title":"Testing with Utility APIs","description":"Mocking and testing Utility APIs","source":"@site/../docs/frontend-system/utility-apis/05-testing.md","sourceDirName":"frontend-system/utility-apis","slug":"/frontend-system/utility-apis/testing","permalink":"/docs/next/frontend-system/utility-apis/testing","draft":false,"unlisted":false,"editUrl":"https://github.com/backstage/backstage/edit/master/docs/frontend-system/utility-apis/05-testing.md","tags":[],"version":"current","sidebarPosition":5,"frontMatter":{"id":"testing","title":"Testing with Utility APIs","sidebar_label":"Testing","description":"Mocking and testing Utility APIs"},"sidebar":"docs","previous":{"title":"Configuring","permalink":"/docs/next/frontend-system/utility-apis/configuring"},"next":{"title":"Backstage CLI","permalink":"/docs/next/backstage-cli/generated-index"}}')}}]);