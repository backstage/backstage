/*! For license information please see 96b71b62.3d2ba173.js.LICENSE.txt */
"use strict";(self.webpackChunkbackstage_microsite=self.webpackChunkbackstage_microsite||[]).push([[204690],{868001:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>i,default:()=>h,frontMatter:()=>o,metadata:()=>a,toc:()=>l});var r=n(474848),s=n(28453);const o={id:"jest30-migration",title:"Migrating to Jest 30",description:"A guide to migrating your project to Jest 30 and JSDOM 27"},i=void 0,a={id:"tutorials/jest30-migration",title:"Migrating to Jest 30",description:"A guide to migrating your project to Jest 30 and JSDOM 27",source:"@site/../docs/tutorials/jest30-migration.md",sourceDirName:"tutorials",slug:"/tutorials/jest30-migration",permalink:"/docs/next/tutorials/jest30-migration",draft:!1,unlisted:!1,editUrl:"https://github.com/backstage/backstage/edit/master/docs/tutorials/jest30-migration.md",tags:[],version:"current",frontMatter:{id:"jest30-migration",title:"Migrating to Jest 30",description:"A guide to migrating your project to Jest 30 and JSDOM 27"}},c={},l=[{value:"Migration Guide",id:"migration-guide",level:2},{value:"Jest 30",id:"jest-30",level:3},{value:"JSDOM 27",id:"jsdom-27",level:3},{value:"If you run into <code>Cannot read properties of null (reading &#39;constructor&#39;)</code>",id:"if-you-run-into-cannot-read-properties-of-null-reading-constructor",level:4}];function d(e){const t={a:"a",code:"code",h2:"h2",h3:"h3",h4:"h4",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(t.p,{children:["Starting with a recent version of ",(0,r.jsx)(t.code,{children:"@backstage/cli"}),", ",(0,r.jsx)(t.code,{children:"jest"})," is a peer dependency. If you run tests using Backstage CLI, you must add Jest and its environment dependencies as ",(0,r.jsx)(t.code,{children:"devDependencies"})," in your project."]}),"\n",(0,r.jsxs)(t.p,{children:["You can choose to install either Jest 29 or Jest 30. The built-in Jest version before this change was Jest 29, however, we recommend that you switch to Jest 30. Upgrading will solve the ",(0,r.jsx)(t.code,{children:"Could not parse CSS stylesheet"})," errors, allow you to use MSW v2 in web packages, and ensure that you remain compatible with future versions of the Backstage CLI. Support for Jest 29 is temporary, with the purpose of allowing you to upgrade at your own pace, but it will eventually be removed."]}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.strong,{children:"Jest 29"}),": Install ",(0,r.jsx)(t.code,{children:"jest@^29"})," and ",(0,r.jsx)(t.code,{children:"jest-environment-jsdom@^29"}),". No migration needed, but you may see ",(0,r.jsx)(t.code,{children:"Could not parse CSS stylesheet"})," warnings/errors when testing components from ",(0,r.jsx)(t.code,{children:"@backstage/ui"})," or other packages using CSS ",(0,r.jsx)(t.code,{children:"@layer"})," declarations."]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.strong,{children:"Jest 30"}),": Install ",(0,r.jsx)(t.code,{children:"jest@^30"}),", ",(0,r.jsx)(t.code,{children:"@jest/environment-jsdom-abstract@^30"}),", and ",(0,r.jsx)(t.code,{children:"jsdom@^27"}),". Fixes the stylesheet parsing warnings/errors, but requires the migration steps below."]}),"\n"]}),"\n",(0,r.jsx)(t.h2,{id:"migration-guide",children:"Migration Guide"}),"\n",(0,r.jsx)(t.p,{children:"The examples below are issues we encountered while migrating the Backstage repository. For a complete list of breaking changes, see the official documentation:"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"https://jestjs.io/docs/upgrading-to-jest30",children:"Jest 30 upgrade guide"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"https://github.com/jsdom/jsdom/releases",children:"JSDOM changelog"})}),"\n"]}),"\n",(0,r.jsx)(t.h3,{id:"jest-30",children:"Jest 30"}),"\n",(0,r.jsxs)(t.p,{children:[(0,r.jsx)(t.strong,{children:"Asymmetric matchers with arrays"}),": ",(0,r.jsx)(t.code,{children:"expect.objectContaining()"})," no longer works with arrays."]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-diff",children:"- expect(result).toEqual(expect.objectContaining([{ id: '123' }]));\n+ expect(result).toEqual([{ id: '123' }]);\n// or\n+ expect(result).toEqual(expect.arrayContaining([{ id: '123' }]));\n"})}),"\n",(0,r.jsxs)(t.p,{children:[(0,r.jsx)(t.strong,{children:"Array length assertions"}),": ",(0,r.jsx)(t.code,{children:"expect.objectContaining({ length: N })"})," no longer works."]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-diff",children:"- expect(fn).toHaveBeenCalledWith(expect.objectContaining({ length: 2 }));\n+ expect(fn).toHaveBeenCalledWith(expect.any(Array));\n+ expect(fn.mock.calls[0][0]).toHaveLength(2);\n"})}),"\n",(0,r.jsxs)(t.p,{children:[(0,r.jsx)(t.strong,{children:"Deprecated matcher aliases removed"}),": Replace with canonical names."]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-diff",children:"- expect(fn).toBeCalled();\n+ expect(fn).toHaveBeenCalled();\n"})}),"\n",(0,r.jsxs)(t.p,{children:[(0,r.jsx)(t.strong,{children:"Snapshots"}),": Regenerate snapshots as the header format has changed."]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-bash",children:"yarn test --no-watch -u\n"})}),"\n",(0,r.jsx)(t.h3,{id:"jsdom-27",children:"JSDOM 27"}),"\n",(0,r.jsxs)(t.p,{children:[(0,r.jsx)(t.strong,{children:"window.location is non-configurable"}),": You can no longer mock location via ",(0,r.jsx)(t.code,{children:"Object.defineProperty"}),"."]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-diff",children:"- Object.defineProperty(window, 'location', { value: { href: '' } });\n+ // Option 1: Use history API\n+ history.replaceState({}, '', '/new-path');\n+ // Option 2: Spy on navigation methods\n+ const spy = jest.spyOn(component, 'navigate');\n"})}),"\n",(0,r.jsxs)(t.p,{children:[(0,r.jsx)(t.strong,{children:"CSS color values"}),": Colors may be returned as RGB instead of named colors."]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-diff",children:"- expect(element.style.color).toBe('red');\n+ expect(element.style.color).toBe('rgb(255, 0, 0)');\n"})}),"\n",(0,r.jsxs)(t.p,{children:[(0,r.jsx)(t.strong,{children:"Error format changes"}),": Error messages and stack traces may have different formatting."]}),"\n",(0,r.jsxs)(t.h4,{id:"if-you-run-into-cannot-read-properties-of-null-reading-constructor",children:["If you run into ",(0,r.jsx)(t.code,{children:"Cannot read properties of null (reading 'constructor')"})]}),"\n",(0,r.jsxs)(t.p,{children:["Certain Backstage UI-components (e.g. Button) have a combination of CSS that triggers this error in tests. The solution is to make sure you have at least v0.9.25 of ",(0,r.jsx)(t.code,{children:"@acemir/cssom"}),"."]})]})}function h(e={}){const{wrapper:t}={...(0,s.R)(),...e.components};return t?(0,r.jsx)(t,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},221020:(e,t,n)=>{var r=n(296540),s=Symbol.for("react.element"),o=Symbol.for("react.fragment"),i=Object.prototype.hasOwnProperty,a=r.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,c={key:!0,ref:!0,__self:!0,__source:!0};function l(e,t,n){var r,o={},l=null,d=null;for(r in void 0!==n&&(l=""+n),void 0!==t.key&&(l=""+t.key),void 0!==t.ref&&(d=t.ref),t)i.call(t,r)&&!c.hasOwnProperty(r)&&(o[r]=t[r]);if(e&&e.defaultProps)for(r in t=e.defaultProps)void 0===o[r]&&(o[r]=t[r]);return{$$typeof:s,type:e,key:l,ref:d,props:o,_owner:a.current}}t.Fragment=o,t.jsx=l,t.jsxs=l},474848:(e,t,n)=>{e.exports=n(221020)},28453:(e,t,n)=>{n.d(t,{R:()=>i,x:()=>a});var r=n(296540);const s={},o=r.createContext(s);function i(e){const t=r.useContext(o);return r.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),r.createElement(o.Provider,{value:t},e.children)}}}]);