"use strict";(self.webpackChunkbackstage_microsite=self.webpackChunkbackstage_microsite||[]).push([["31725"],{380362(e,n,a){a.r(n),a.d(n,{assets:()=>o,contentTitle:()=>c,default:()=>h,frontMatter:()=>r,metadata:()=>s,toc:()=>d});var s=a(339345),t=a(474848),i=a(28453);let r={id:"search-engines",title:"Search Engines",description:"Choosing and configuring your search engine for Backstage"},c,o={},d=[{value:"Lunr",id:"lunr",level:2},{value:"Postgres",id:"postgres",level:2},{value:"Optional Configuration",id:"optional-configuration",level:3},{value:"Elasticsearch",id:"elasticsearch",level:2},{value:"Example configurations",id:"example-configurations",level:3},{value:"AWS",id:"aws",level:4},{value:"Elastic.co",id:"elasticco",level:4},{value:"OpenSearch",id:"opensearch",level:4},{value:"Others",id:"others",level:4},{value:"With username and password",id:"with-username-and-password",level:5},{value:"With API key",id:"with-api-key",level:5},{value:"Elasticsearch batch size",id:"elasticsearch-batch-size",level:3},{value:"Elasticsearch batch key field",id:"elasticsearch-batch-key-field",level:3},{value:"Elasticsearch Index Name Customization",id:"elasticsearch-index-name-customization",level:3},{value:"Elasticsearch query config",id:"elasticsearch-query-config",level:3},{value:"Custom Authentication Extension Point",id:"custom-authentication-extension-point",level:3}];function l(e){let n={a:"a",admonition:"admonition",blockquote:"blockquote",br:"br",code:"code",h2:"h2",h3:"h3",h4:"h4",h5:"h5",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(n.p,{children:["Backstage supports 3 search engines by default, an in-memory engine called ",(0,t.jsx)(n.a,{href:"#lunr",children:"Lunr"}),", ",(0,t.jsx)(n.a,{href:"#postgres",children:"Postgres"}),"\nand ",(0,t.jsx)(n.a,{href:"#elasticsearch",children:"Elasticsearch"}),"."]}),"\n",(0,t.jsx)(n.h2,{id:"lunr",children:"Lunr"}),"\n",(0,t.jsx)(n.p,{children:"Lunr search engine is enabled by default for your Backstage instance if you have not done additional changes to the scaffolded app."}),"\n",(0,t.jsx)(n.p,{children:"As Lunr is built into the Search backend plugin it can be added like this:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",metastring:'title="From your Backstage root directory"',children:"yarn --cwd packages/backend add @backstage/plugin-search-backend\n"})}),"\n",(0,t.jsx)(n.p,{children:"Then add the following line:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",metastring:'title="packages/backend/src/index.ts"',children:"const backend = createBackend();\n\n// Other plugins...\n\n/* highlight-add-start */\nbackend.add(import('@backstage/plugin-search-backend'));\n/* highlight-add-end */\n\nbackend.start();\n"})}),"\n",(0,t.jsx)(n.admonition,{title:"Note",type:"note",children:(0,t.jsx)(n.p,{children:"Lunr is appropriate as a zero-config search engine when developing\nother parts of Backstage locally, however its use is highly discouraged when\nrunning Backstage in production. When deploying Backstage, use one of the\nother search engines instead."})}),"\n",(0,t.jsx)(n.h2,{id:"postgres",children:"Postgres"}),"\n",(0,t.jsx)(n.p,{children:"The Postgres based search engine only requires that Postgres being configured as\nthe database engine for Backstage. Therefore it targets setups that want to\navoid maintaining another external service like Elasticsearch. The search\nprovides decent results and performs well with ten thousands of indexed\ndocuments. The connection to Postgres is established via the database manager\nalso used by other plugins."}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Important"}),": The search plugin requires at least Postgres 12!"]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"First we need to add the plugin:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",metastring:'title="From your Backstage root directory"',children:"yarn --cwd packages/backend add @backstage/plugin-search-backend-module-pg\n"})}),"\n",(0,t.jsx)(n.p,{children:"Then add the following line:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",metastring:'title="packages/backend/src/index.ts"',children:"const backend = createBackend();\n\n// Other plugins...\n\n// search plugin\nbackend.add(import('@backstage/plugin-search-backend'));\n\n/* highlight-add-start */\nbackend.add(import('@backstage/plugin-search-backend-module-pg'));\n/* highlight-add-end */\n\nbackend.start();\n"})}),"\n",(0,t.jsx)(n.h3,{id:"optional-configuration",children:"Optional Configuration"}),"\n",(0,t.jsx)(n.p,{children:"The following is an example of the optional configuration that can be applied when using Postgres as the search backend. Currently this is mostly for just the highlight feature:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"search:\n  pg:\n    highlightOptions:\n      useHighlight: true # Used to enable to disable the highlight feature. The default value is true\n      maxWord: 35 # Used to set the longest headlines to output. The default value is 35.\n      minWord: 15 # Used to set the shortest headlines to output. The default value is 15.\n      shortWord: 3 # Words of this length or less will be dropped at the start and end of a headline, unless they are query terms. The default value of three (3) eliminates common English articles.\n      highlightAll: false # If true the whole document will be used as the headline, ignoring the preceding three parameters. The default is false.\n      maxFragments: 0 # Maximum number of text fragments to display. The default value of zero selects a non-fragment-based headline generation method. A value greater than zero selects fragment-based headline generation (see the linked documentation above for more details).\n      fragmentDelimiter: ' ... ' # Delimiter string used to concatenate fragments. Defaults to \" ... \".\n"})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Note:"})," the highlight search term feature uses ",(0,t.jsx)(n.code,{children:"ts_headline"})," which has been known to potentially impact performance. You only need this minimal config to disable it should you have issues:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"search:\n  pg:\n    highlightOptions:\n      useHighlight: false\n"})}),"\n",(0,t.jsxs)(n.p,{children:["The Postgres documentation on ",(0,t.jsx)(n.a,{href:"https://www.postgresql.org/docs/current/textsearch-controls.html#TEXTSEARCH-HEADLINE",children:"Highlighting Results"})," has more details."]}),"\n",(0,t.jsx)(n.h2,{id:"elasticsearch",children:"Elasticsearch"}),"\n",(0,t.jsx)(n.p,{children:"Backstage supports Elasticsearch (and OpenSearch) search engine connections,\nindexing and querying out of the box. Available configuration options enable\nusage of either AWS or Elastic.co hosted solutions, or a custom self-hosted solution."}),"\n",(0,t.jsx)(n.p,{children:"Similarly to Postgres above, Elasticsearch can be set up as follows."}),"\n",(0,t.jsx)(n.p,{children:"First we need to add the plugin:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",metastring:'title="From your Backstage root directory"',children:"yarn --cwd packages/backend add @backstage/plugin-search-backend-module-elasticsearch\n"})}),"\n",(0,t.jsx)(n.p,{children:"Then add the following line:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",metastring:'title="packages/backend/src/index.ts"',children:"const backend = createBackend();\n\n// Other plugins...\n\n// search plugin\nbackend.add(import('@backstage/plugin-search-backend'));\n\n/* highlight-add-start */\nbackend.add(import('@backstage/plugin-search-backend-module-elasticsearch'));\n/* highlight-add-end */\n\nbackend.start();\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Elasticsearch needs some additional configuration before it is ready to use\nwithin your instance. The configuration options are documented in the\n",(0,t.jsx)(n.a,{href:"https://github.com/backstage/backstage/blob/master/plugins/search-backend-module-elasticsearch/config.d.ts",children:"configuration schema definition file."})]}),"\n",(0,t.jsxs)(n.p,{children:["The underlying functionality uses either the official Elasticsearch client\nversion 7.x (meaning that Elasticsearch version 7 is the only one confirmed to\nbe supported), or the OpenSearch client, when the ",(0,t.jsx)(n.code,{children:"aws"})," or ",(0,t.jsx)(n.code,{children:"opensearch"})," provider\nis configured."]}),"\n",(0,t.jsx)(n.h3,{id:"example-configurations",children:"Example configurations"}),"\n",(0,t.jsx)(n.h4,{id:"aws",children:"AWS"}),"\n",(0,t.jsxs)(n.p,{children:["Using AWS hosted Elasticsearch the only configuration option needed is the URL\nto the Elasticsearch service. The implementation assumes that environment\nvariables for AWS access key id and secret access key are defined in accordance\nto the\n",(0,t.jsx)(n.a,{href:"https://docs.aws.amazon.com/sdk-for-javascript/v2/developer-guide/setting-credentials-node.html",children:"default AWS credential chain."}),"."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"search:\n  elasticsearch:\n    provider: aws\n    node: https://my-backstage-search-asdfqwerty.eu-west-1.es.amazonaws.com\n"})}),"\n",(0,t.jsx)(n.h4,{id:"elasticco",children:"Elastic.co"}),"\n",(0,t.jsxs)(n.p,{children:["Elastic Cloud hosted Elasticsearch uses a Cloud ID to determine the instance of\nhosted Elasticsearch to connect to. Additionally, username and password needs to\nbe provided either directly or using environment variables like defined in\n",(0,t.jsx)(n.a,{href:"https://backstage.io/docs/conf/writing#includes-and-dynamic-data",children:"Backstage documentation."})]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"search:\n  elasticsearch:\n    provider: elastic\n    cloudId: backstage-elastic:asdfqwertyasdfqwertyasdfqwertyasdfqwerty==\n    auth:\n      username: elastic\n      password: changeme\n"})}),"\n",(0,t.jsx)(n.h4,{id:"opensearch",children:"OpenSearch"}),"\n",(0,t.jsxs)(n.p,{children:["OpenSearch can be self hosted for example with the ",(0,t.jsx)(n.a,{href:"https://hub.docker.com/r/opensearchproject/opensearch",children:"official docker image"}),". The configuration requires only the node and authentication."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"search:\n  elasticsearch:\n    provider: opensearch\n    node: http://0.0.0.0:9200\n    auth:\n      username: opensearch\n      password: changeme\n"})}),"\n",(0,t.jsx)(n.h4,{id:"others",children:"Others"}),"\n",(0,t.jsxs)(n.p,{children:["Other Elasticsearch instances can be connected to by using standard\nElasticsearch authentication methods and exposed URL, provided that the cluster\nsupports that. The configuration options needed are the URL to the node and\nauthentication information. Authentication can be handled by either providing\nusername/password or an API key. For more information how to create an API key,\nsee\n",(0,t.jsx)(n.a,{href:"https://www.elastic.co/guide/en/elasticsearch/reference/current/security-api-create-api-key.html",children:"Elastic documentation on API keys"}),"."]}),"\n",(0,t.jsx)(n.h5,{id:"with-username-and-password",children:"With username and password"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"search:\n  elasticsearch:\n    node: http://localhost:9200\n    auth:\n      username: elastic\n      password: changeme\n"})}),"\n",(0,t.jsx)(n.h5,{id:"with-api-key",children:"With API key"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"search:\n  elasticsearch:\n    node: http://localhost:9200\n    auth:\n      apiKey: base64EncodedKey\n"})}),"\n",(0,t.jsx)(n.h3,{id:"elasticsearch-batch-size",children:"Elasticsearch batch size"}),"\n",(0,t.jsxs)(n.p,{children:["Default batch size of the Elasticsearch engine is set to 1000. If you are using a lower spec computing resources (like AWS small instance),\nyou may get an error caused by limited ",(0,t.jsx)(n.code,{children:"thread_pool"})," configuration. ( ",(0,t.jsx)(n.code,{children:"429 Too Many Requests /_bulk"})," )"]}),"\n",(0,t.jsxs)(n.p,{children:["In this case you need to decrease the batch size to index the resources to prevent this kind of error. You can easily decrease\nor increase the batch size in your ",(0,t.jsx)(n.code,{children:"app-config.yaml"})," using the ",(0,t.jsx)(n.code,{children:"batchSize"})," option provided for Elasticsearch configuration."]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Set batch size to 100"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"search:\n  elasticsearch:\n    batchSize: 100\n"})}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsx)(n.p,{children:"You can also increase the batch size if you are using a large ES instance."}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"elasticsearch-batch-key-field",children:"Elasticsearch batch key field"}),"\n",(0,t.jsxs)(n.p,{children:["By default, during bulk uploads with the Elasticsearch indexer, each document is assigned an auto-generated ",(0,t.jsx)(n.code,{children:"_id"})," unless a ",(0,t.jsx)(n.code,{children:"batchKeyField"})," is explicitly set. This configuration is optional and most users won\u2019t need to customize it. However, if your use case involves frequent lookups or updates to existing documents, setting ",(0,t.jsx)(n.code,{children:"batchKeyField"})," can be beneficial. It allows you to define a consistent identifier for each document, helping to streamline updates and prevent duplicate entries. Be aware that if the value provided for ",(0,t.jsx)(n.code,{children:"batchKeyField"})," is not unique across documents, Elasticsearch will overwrite any existing document with the same ",(0,t.jsx)(n.code,{children:"_id"}),"."]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsxs)(n.strong,{children:["Using ",(0,t.jsx)(n.code,{children:"batchKeyField"})," (Custom ",(0,t.jsx)(n.code,{children:"_id"}),")"]})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"search:\n  elasticsearch:\n    batchKeyField: document_id\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsxs)(n.strong,{children:["Default Behavior (Auto-generated ",(0,t.jsx)(n.code,{children:"_id"}),")"]})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"search:\n  elasticsearch:\n    # No batchKeyField specified \u2014 Elasticsearch will autogenerate _id\n"})}),"\n",(0,t.jsx)(n.h3,{id:"elasticsearch-index-name-customization",children:"Elasticsearch Index Name Customization"}),"\n",(0,t.jsx)(n.p,{children:"By default, the Elasticsearch indexer creates index names based on their type, a separator, and the current date as a postfix. You can configure a custom prefix for all indices by adding the following section to your app configuration."}),"\n",(0,t.jsxs)(n.p,{children:["An example of a default index name would look like this:",(0,t.jsx)(n.br,{}),"\n",(0,t.jsx)(n.code,{children:"software-catalog-index__20250219"})]}),"\n",(0,t.jsxs)(n.p,{children:["To prefix all indices with a custom string (e.g., ",(0,t.jsx)(n.code,{children:"custom-prefix"}),"), use the following configuration:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"search:\n  elasticsearch:\n    indexPrefix: custom-prefix-\n"})}),"\n",(0,t.jsxs)(n.p,{children:["After applying this setting, an index name would look like this: ",(0,t.jsx)(n.code,{children:"custom-prefix-software-catalog-index__20250219"})]}),"\n",(0,t.jsx)(n.h3,{id:"elasticsearch-query-config",children:"Elasticsearch query config"}),"\n",(0,t.jsxs)(n.p,{children:["By default the default settings for the Elasticsearch queries is used. If you need to tweak the fuzziness of the query results you can do this with 2 parameters, ",(0,t.jsx)(n.code,{children:"fuzziness"})," and ",(0,t.jsx)(n.code,{children:"prefixLength"}),"."]}),"\n",(0,t.jsxs)(n.p,{children:["Fuzziness allows you to define the maximum Levenshtein distance, AUTO is the default and widely accepted standard.\n",(0,t.jsx)(n.code,{children:"prefixLength"})," allows you to control the minimum number of characters that must match exactly at the beginning of the query term. This defaults to 0\n",(0,t.jsx)(n.a,{href:"https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-fuzzy-query.html",children:"More info"})]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"search:\n  elasticsearch:\n    queryOptions:\n      fuzziness: AUTO\n      prefixLength: 3;\n"})}),"\n",(0,t.jsx)(n.h3,{id:"custom-authentication-extension-point",children:"Custom Authentication Extension Point"}),"\n",(0,t.jsx)(n.p,{children:"For enterprise environments that require dynamic authentication mechanisms such as bearer tokens with automatic rotation, the Elasticsearch module provides an authentication extension point. This is useful when:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Using OAuth2/OIDC identity providers for service authentication"}),"\n",(0,t.jsx)(n.li,{children:"Tokens need to be refreshed automatically (e.g., tokens that expire hourly)"}),"\n",(0,t.jsx)(n.li,{children:"Integrating with internal identity services"}),"\n",(0,t.jsx)(n.li,{children:"Running Elasticsearch/OpenSearch clusters secured by token-based authentication"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"To use custom authentication, create a backend module that provides an auth provider:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",metastring:'title="packages/backend/src/modules/elasticsearchAuth.ts"',children:"import { createBackendModule } from '@backstage/backend-plugin-api';\nimport { elasticsearchAuthExtensionPoint } from '@backstage/plugin-search-backend-module-elasticsearch';\n\nexport default createBackendModule({\n  pluginId: 'search',\n  moduleId: 'elasticsearch-custom-auth',\n  register(env) {\n    env.registerInit({\n      deps: {\n        elasticsearchAuth: elasticsearchAuthExtensionPoint,\n      },\n      async init({ elasticsearchAuth }) {\n        elasticsearchAuth.setAuthProvider({\n          async getAuthHeaders() {\n            // Fetch token from your identity service\n            const token = await myTokenService.getToken();\n            return { Authorization: `Bearer ${token}` };\n          },\n        });\n      },\n    });\n  },\n});\n"})}),"\n",(0,t.jsx)(n.p,{children:"Then register this module in your backend:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",metastring:'title="packages/backend/src/index.ts"',children:"const backend = createBackend();\n\n// Other plugins...\n\nbackend.add(import('@backstage/plugin-search-backend'));\nbackend.add(import('@backstage/plugin-search-backend-module-elasticsearch'));\n\n/* highlight-add-start */\nbackend.add(import('./modules/elasticsearchAuth'));\n/* highlight-add-end */\n\nbackend.start();\n"})}),"\n",(0,t.jsxs)(n.p,{children:["The ",(0,t.jsx)(n.code,{children:"getAuthHeaders"})," method is called before each request, allowing for just-in-time token retrieval and automatic rotation. When an auth provider is configured, it takes precedence over any static authentication in ",(0,t.jsx)(n.code,{children:"app-config.yaml"}),"."]}),"\n",(0,t.jsx)(n.admonition,{title:"Note",type:"note",children:(0,t.jsxs)(n.p,{children:["Custom authentication is supported for the ",(0,t.jsx)(n.code,{children:"elastic"}),", ",(0,t.jsx)(n.code,{children:"opensearch"}),", and default providers. The ",(0,t.jsx)(n.code,{children:"aws"})," provider uses AWS SigV4 request signing and does not support custom auth providers."]})})]})}function h(e={}){let{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(l,{...e})}):l(e)}},28453(e,n,a){a.d(n,{R:()=>r,x:()=>c});var s=a(296540);let t={},i=s.createContext(t);function r(e){let n=s.useContext(i);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:r(e.components),s.createElement(i.Provider,{value:n},e.children)}},339345(e){e.exports=JSON.parse('{"id":"features/search/search-engines","title":"Search Engines","description":"Choosing and configuring your search engine for Backstage","source":"@site/../docs/features/search/search-engines.md","sourceDirName":"features/search","slug":"/features/search/search-engines","permalink":"/docs/next/features/search/search-engines","draft":false,"unlisted":false,"editUrl":"https://github.com/backstage/backstage/edit/master/docs/features/search/search-engines.md","tags":[],"version":"current","frontMatter":{"id":"search-engines","title":"Search Engines","description":"Choosing and configuring your search engine for Backstage"},"sidebar":"docs","previous":{"title":"Search Architecture","permalink":"/docs/next/features/search/architecture"},"next":{"title":"Collators","permalink":"/docs/next/features/search/collators"}}')}}]);