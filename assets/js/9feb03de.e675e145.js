/*! For license information please see 9feb03de.e675e145.js.LICENSE.txt */
"use strict";(self.webpackChunkbackstage_microsite=self.webpackChunkbackstage_microsite||[]).push([[723041],{397337:(e,n,o)=>{o.r(n),o.d(n,{assets:()=>r,contentTitle:()=>a,default:()=>p,frontMatter:()=>t,metadata:()=>c,toc:()=>l});var s=o(474848),i=o(28453);const t={id:"processors",title:"Processors",description:"How to setup notification processors"},a=void 0,c={id:"notifications/processors",title:"Processors",description:"How to setup notification processors",source:"@site/../docs/notifications/processors.md",sourceDirName:"notifications",slug:"/notifications/processors",permalink:"/docs/next/notifications/processors",draft:!1,unlisted:!1,editUrl:"https://github.com/backstage/backstage/edit/master/docs/notifications/processors.md",tags:[],version:"current",frontMatter:{id:"processors",title:"Processors",description:"How to setup notification processors"},sidebar:"docs",previous:{title:"Getting Started",permalink:"/docs/next/notifications/"},next:{title:"Usage",permalink:"/docs/next/notifications/usage"}},r={},l=[{value:"Built-in Processors",id:"built-in-processors",level:2},{value:"Email Processor",id:"email-processor",level:3},{value:"Slack Processor",id:"slack-processor",level:3},{value:"Slack Configuration",id:"slack-configuration",level:3},{value:"Configure Backstage",id:"configure-backstage",level:3},{value:"Entity Requirements",id:"entity-requirements",level:3},{value:"Observability",id:"observability",level:3}];function d(e){const n={a:"a",code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",ul:"ul",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(n.p,{children:["Notifications can be extended with ",(0,s.jsx)(n.code,{children:"NotificationProcessor"}),". These processors allow you to decorate notifications before they are sent and/or send the notifications to external services."]}),"\n",(0,s.jsx)(n.p,{children:"Depending on your needs, a processor can modify the content of a notification or route it to different systems like email, Slack, or other services."}),"\n",(0,s.jsxs)(n.p,{children:["A good example of how to write a processor is the ",(0,s.jsx)(n.a,{href:"https://github.com/backstage/backstage/tree/master/plugins/notifications-backend-module-email",children:"Email Processor"}),"."]}),"\n",(0,s.jsx)(n.p,{children:"Start off by creating a notification processor:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"import { Notification } from '@backstage/plugin-notifications-common';\nimport { NotificationProcessor } from '@backstage/plugin-notifications-node';\n\nclass MyNotificationProcessor implements NotificationProcessor {\n  // preProcess is called before the notification is saved to database.\n  // This is a good place to modify the notification before it is saved and sent to the user.\n  async preProcess(notification: Notification): Promise<Notification> {\n    if (notification.origin === 'plugin-my-plugin') {\n      notification.payload.icon = 'my-icon';\n    }\n    return notification;\n  }\n\n  // postProcess is called after the notification is saved to database and the signal is emitted.\n  // This is a good place to send the notification to external services.\n  async postProcess(notification: Notification): Promise<void> {\n    nodemailer.sendEmail({\n      from: 'backstage',\n      to: 'user',\n      subject: notification.payload.title,\n      text: notification.payload.description,\n    });\n  }\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:"Both of the processing functions are optional, and you can just implement one of them."}),"\n",(0,s.jsx)(n.p,{children:"Add the notification processor to the notification system by:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"import { notificationsProcessingExtensionPoint } from '@backstage/plugin-notifications-node';\nimport { Notification } from '@backstage/plugin-notifications-common';\n\nexport const myPlugin = createBackendPlugin({\n  pluginId: 'myPlugin',\n  register(env) {\n    env.registerInit({\n      deps: {\n        notifications: notificationsProcessingExtensionPoint,\n        // ...\n      },\n      async init({ notifications }) {\n        // ...\n        notifications.addProcessor(new MyNotificationProcessor());\n      },\n    });\n  },\n});\n"})}),"\n",(0,s.jsx)(n.h2,{id:"built-in-processors",children:"Built-in Processors"}),"\n",(0,s.jsx)(n.p,{children:"Backstage comes with some processors that can be used immediately."}),"\n",(0,s.jsx)(n.h3,{id:"email-processor",children:"Email Processor"}),"\n",(0,s.jsxs)(n.p,{children:["Email processor is used to send notifications to users using email. To install the email processor, add the ",(0,s.jsx)(n.code,{children:"@backstage/plugin-notifications-backend-module-email"})," package to your backend."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"yarn workspace backend add @backstage/plugin-notifications-backend-module-email\n"})}),"\n",(0,s.jsx)(n.p,{children:"Add the email processor to your backend:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"import { createBackend } from '@backstage/plugin-notifications-backend';\nconst backend = createBackend();\n// ...\nbackend.add(import('@backstage/plugin-notifications-backend-module-email'));\n"})}),"\n",(0,s.jsxs)(n.p,{children:["To configure the email processor, you need to add the following configuration to your ",(0,s.jsx)(n.code,{children:"app-config.yaml"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"notifications:\n  email:\n    smtp:\n      host: smtp.example.com\n      port: 587\n      secure: false\n      username: ${SMTP_USERNAME}\n      password: ${SMTP_PASSWORD}\n"})}),"\n",(0,s.jsx)(n.p,{children:"Apart from STMP, the email processor also supports the following transmissions:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"SES"}),"\n",(0,s.jsx)(n.li,{children:"sendmail"}),"\n",(0,s.jsx)(n.li,{children:"stream (only for debugging purposes)"}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["See more information at ",(0,s.jsx)(n.a,{href:"https://github.com/backstage/backstage/blob/master/plugins/notifications-backend-module-email/README.md",children:"https://github.com/backstage/backstage/blob/master/plugins/notifications-backend-module-email/README.md"})]}),"\n",(0,s.jsx)(n.h3,{id:"slack-processor",children:"Slack Processor"}),"\n",(0,s.jsx)(n.p,{children:"Slack processor is used to send notifications to users and channels in Slack."}),"\n",(0,s.jsx)(n.h3,{id:"slack-configuration",children:"Slack Configuration"}),"\n",(0,s.jsxs)(n.p,{children:["To use this you'll need to create a Slack App or use an existing one. It should have at least the following scopes:\n",(0,s.jsx)(n.code,{children:"chat:write"}),", ",(0,s.jsx)(n.code,{children:"users:read"}),", ",(0,s.jsx)(n.code,{children:"im:write"})," (for direct message support)."]}),"\n",(0,s.jsxs)(n.p,{children:["Additionally you may include scopes ",(0,s.jsx)(n.code,{children:"chat:write.public"})," in order to send messages to public channels your app is not\na member of."]}),"\n",(0,s.jsxs)(n.p,{children:["These scopes are under OAuth & Permissions. You will also want to save the Bot User OAuth Token. This will be needed\nin the following step to configure ",(0,s.jsx)(n.code,{children:"app-config.yaml"}),"."]}),"\n",(0,s.jsx)(n.h3,{id:"configure-backstage",children:"Configure Backstage"}),"\n",(0,s.jsxs)(n.p,{children:["To install the Slack processor, add the ",(0,s.jsx)(n.code,{children:"@backstage/plugin-notifications-backend-module-slack"})," package to your backend."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"yarn workspace backend add @backstage/plugin-notifications-backend-module-slack\n"})}),"\n",(0,s.jsx)(n.p,{children:"Add the Slack processor to your backend:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"// packages/backend/src/index.ts\nimport { createBackend } from '@backstage/plugin-notifications-backend';\nconst backend = createBackend();\n// ...\nbackend.add(import('@backstage/plugin-notifications-backend-module-slack'));\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Using the token you obtained from your Slack App, configure the Slack module in your ",(0,s.jsx)(n.code,{children:"app-config.yaml"}),"."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"notifications:\n  processors:\n    slack:\n      - token: xoxb-XXXXXXXXX\n        broadcastChannels: # Optional, if you wish to support broadcast notifications.\n          - C12345678\n        username: 'Backstage Bot' # Optional, defaults to the name of the Slack App.\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Multiple instances can be added in the ",(0,s.jsx)(n.code,{children:"slack"})," array, allowing you to have multiple configurations if you need to send\nmessages to more than one Slack workspace. Org-Wide App installation is not currently supported."]}),"\n",(0,s.jsx)(n.h3,{id:"entity-requirements",children:"Entity Requirements"}),"\n",(0,s.jsx)(n.p,{children:"Entities must be annotated with the following annotation:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"slack.com/bot-notify"})}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["The value may be any Slack ID supported by ",(0,s.jsx)(n.a,{href:"https://api.slack.com/methods/chat.postMessage",children:"chat.postMessage"}),", for example a user (U12345678), channel (C12345678), group, or direct message chat."]}),"\n",(0,s.jsx)(n.p,{children:"It's also possible to use a user's email address or channel name, however IDs are recommended by Slack.\nPrivate channels/chats must use an ID."}),"\n",(0,s.jsx)(n.h3,{id:"observability",children:"Observability"}),"\n",(0,s.jsx)(n.p,{children:"The processor includes the following counter metrics if you are exporting metrics using OpenTelemetry:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"notifications.processors.slack.sent.count"})," - The number of messages sent"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"notifications.processors.slack.error.count"})," - The number of messages that failed to send"]}),"\n"]})]})}function p(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},221020:(e,n,o)=>{var s=o(296540),i=Symbol.for("react.element"),t=Symbol.for("react.fragment"),a=Object.prototype.hasOwnProperty,c=s.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,r={key:!0,ref:!0,__self:!0,__source:!0};function l(e,n,o){var s,t={},l=null,d=null;for(s in void 0!==o&&(l=""+o),void 0!==n.key&&(l=""+n.key),void 0!==n.ref&&(d=n.ref),n)a.call(n,s)&&!r.hasOwnProperty(s)&&(t[s]=n[s]);if(e&&e.defaultProps)for(s in n=e.defaultProps)void 0===t[s]&&(t[s]=n[s]);return{$$typeof:i,type:e,key:l,ref:d,props:t,_owner:c.current}}n.Fragment=t,n.jsx=l,n.jsxs=l},474848:(e,n,o)=>{e.exports=o(221020)},28453:(e,n,o)=>{o.d(n,{R:()=>a,x:()=>c});var s=o(296540);const i={},t=s.createContext(i);function a(e){const n=s.useContext(t);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),s.createElement(t.Provider,{value:n},e.children)}}}]);