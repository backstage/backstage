/*! For license information please see 0e88bd40.f6e822e4.js.LICENSE.txt */
"use strict";(self.webpackChunkbackstage_microsite=self.webpackChunkbackstage_microsite||[]).push([[174124],{191134:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>i,default:()=>u,frontMatter:()=>s,metadata:()=>r,toc:()=>l});var a=t(474848),o=t(28453);const s={id:"manual-knex-rollback",title:"Manual Rollback using Knex",description:"Guide on how to rollback Knex migrations."},i=void 0,r={id:"tutorials/manual-knex-rollback",title:"Manual Rollback using Knex",description:"Guide on how to rollback Knex migrations.",source:"@site/versioned_docs/version-stable/tutorials/manual-knex-rollback.md",sourceDirName:"tutorials",slug:"/tutorials/manual-knex-rollback",permalink:"/docs/tutorials/manual-knex-rollback",draft:!1,unlisted:!1,editUrl:"https://github.com/backstage/backstage/edit/master/docs/tutorials/manual-knex-rollback.md",tags:[],version:"stable",frontMatter:{id:"manual-knex-rollback",title:"Manual Rollback using Knex",description:"Guide on how to rollback Knex migrations."},sidebar:"docs",previous:{title:"Configuring Plugin Databases",permalink:"/docs/tutorials/configuring-plugin-databases"},next:{title:"Switching Backstage from SQLite to PostgreSQL",permalink:"/docs/tutorials/switching-sqlite-postgres"}},c={},l=[];function d(e){const n={a:"a",code:"code",p:"p",pre:"pre",strong:"strong",...(0,o.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)(n.p,{children:["The most common case to use Knex directly is when you want to ",(0,a.jsx)(n.strong,{children:"rollback a migration"})," that was applied when you upgraded your Backstage instance and want to downgrade due to some problem. You can use the ",(0,a.jsx)(n.code,{children:"migrate:down"})," command to rollback a specific migration. You can also use the ",(0,a.jsx)(n.code,{children:"migrate:rollback"})," command to rollback the last batch of migrations. This is necessary because Knex will mark migrations as corrupted if you try to downgrade your Backstage instance without the rollback. Be aware to run those commands in the new version of the Backstage instance, so you can avoid the corrupted migrations for lower versions."]}),"\n",(0,a.jsx)(n.p,{children:"You are likely to receive a message like this when you try a downgrade without the rollback:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-sh",children:"Backend failed to start up Error: The migration directory is corrupt, the following files are missing: 20230428155633_sessions.js\n"})}),"\n",(0,a.jsxs)(n.p,{children:["Currently, we don't have a simple way to check which migrations and which plugins have been applied in the database, but you can follow this ",(0,a.jsx)(n.a,{href:"https://github.com/backstage/backstage/issues/22439",children:"issue"})," to get more information about this.\nThis guide covers a simple way to rollback migrations using Knex. We have plans to support this in Backstage's CLI (",(0,a.jsx)(n.a,{href:"https://github.com/backstage/backstage/issues/6366",children:"issue"}),"), but for now it is possible to use Knex CLI to manage migrations in necessary cases."]}),"\n",(0,a.jsxs)(n.p,{children:["To start, you are going to need two things: database access and the plugin migrations directory you want to handle. We are going to use environment variables to access the database and we'll be using the ",(0,a.jsx)(n.code,{children:"@backstage/plugin-catalog-backend"})," plugin as an example. In most cases, there is a ",(0,a.jsx)(n.code,{children:"migrations"})," directory in the root of the plugin package, but you can check the ",(0,a.jsx)(n.code,{children:"package.json"})," file to confirm the directory.\nYou can get more information about how Backstage handles Databases in ",(0,a.jsx)(n.a,{href:"/docs/tutorials/configuring-plugin-databases",children:"Configuring Plugin Databases"}),". This tutorial follows the information in the ",(0,a.jsx)(n.a,{href:"https://knexjs.org/guide/migrations.html",children:"Knex migration guide"}),", so you can get more details about the commands there."]}),"\n",(0,a.jsx)(n.p,{children:"You can interact with Knex running the commands below in the project root:"}),"\n",(0,a.jsx)(n.p,{children:"We want to check the migration status:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-sh",children:'$ node_modules/.bin/knex migrate:status --connection "postgresql://$POSTGRES_USER:$POSTGRES_PASSWORD@$POSTGRES_HOST/backstage_plugin_catalog" --client pg --migrations-directory node_modules/@backstage/plugin-catalog-backend/migrations/\nUsing environment: production\nFound 2 Completed Migration file/files.\n20211229105307_init.js\n20240113144027_assets-namespace.js\nNo Pending Migration files Found.\n'})}),"\n",(0,a.jsxs)(n.p,{children:["Now lets rollback a specific migration called ",(0,a.jsx)(n.code,{children:"20240113144027_assets-namespace.js"}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-sh",children:'$ node_modules/.bin/knex migrate:down 20240113144027_assets-namespace.js --connection "postgresql://$POSTGRES_USER:$POSTGRES_PASSWORD@$POSTGRES_HOST/backstage_plugin_catalog" --client pg --migrations-directory node_modules/@backstage/plugin-catalog-backend/migrations/\nUsing environment: production\nBatch 2 rolled back the following migrations:\n20240113144027_assets-namespace.js\n'})}),"\n",(0,a.jsx)(n.p,{children:"Now we can check the migration status again to confirm the rollback:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-sh",children:'$ node_modules/.bin/knex migrate:status --connection "postgresql://$POSTGRES_USER:$POSTGRES_PASSWORD@$POSTGRES_HOST/backstage_plugin_catalog" --client pg --migrations-directory node_modules/@backstage/plugin-catalog-backend/migrations/\nUsing environment: production\nFound 1 Completed Migration file/files.\n20211229105307_init.js\nFound 1 Pending Migration file/files.\n20240113144027_assets-namespace.js\n'})}),"\n",(0,a.jsxs)(n.p,{children:["Now lets use ",(0,a.jsx)(n.code,{children:"migrate:currentVersion"}),' which retrieves the current migration version. If there aren\'t any migrations run yet, it will return "none".']}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-sh",children:'$ node_modules/.bin/knex migrate:currentVersion --connection "postgresql://$POSTGRES_USER:$POSTGRES_PASSWORD@$POSTGRES_HOST/backstage_plugin_catalog" --client pg\nUsing environment: production\nCurrent Version: 20240113144027\n'})})]})}function u(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(d,{...e})}):d(e)}},221020:(e,n,t)=>{var a=t(296540),o=Symbol.for("react.element"),s=Symbol.for("react.fragment"),i=Object.prototype.hasOwnProperty,r=a.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,c={key:!0,ref:!0,__self:!0,__source:!0};function l(e,n,t){var a,s={},l=null,d=null;for(a in void 0!==t&&(l=""+t),void 0!==n.key&&(l=""+n.key),void 0!==n.ref&&(d=n.ref),n)i.call(n,a)&&!c.hasOwnProperty(a)&&(s[a]=n[a]);if(e&&e.defaultProps)for(a in n=e.defaultProps)void 0===s[a]&&(s[a]=n[a]);return{$$typeof:o,type:e,key:l,ref:d,props:s,_owner:r.current}}n.Fragment=s,n.jsx=l,n.jsxs=l},474848:(e,n,t)=>{e.exports=t(221020)},28453:(e,n,t)=>{t.d(n,{R:()=>i,x:()=>r});var a=t(296540);const o={},s=a.createContext(o);function i(e){const n=a.useContext(s);return a.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:i(e.components),a.createElement(s.Provider,{value:n},e.children)}}}]);