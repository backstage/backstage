/*! For license information please see 7f88e01c.3060b5b2.js.LICENSE.txt */
"use strict";(self.webpackChunkbackstage_microsite=self.webpackChunkbackstage_microsite||[]).push([[941231],{641368:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>c,contentTitle:()=>o,default:()=>h,frontMatter:()=>s,metadata:()=>i,toc:()=>l});var n=a(474848),r=a(28453);const s={id:"experimental",title:"Experimental Features",description:"Information on Experimental Features that are currently available in the Scaffolder"},o=void 0,i={id:"features/software-templates/experimental",title:"Experimental Features",description:"Information on Experimental Features that are currently available in the Scaffolder",source:"@site/versioned_docs/version-stable/features/software-templates/experimental.md",sourceDirName:"features/software-templates",slug:"/features/software-templates/experimental",permalink:"/docs/features/software-templates/experimental",draft:!1,unlisted:!1,editUrl:"https://github.com/backstage/backstage/edit/master/docs/features/software-templates/experimental.md",tags:[],version:"stable",frontMatter:{id:"experimental",title:"Experimental Features",description:"Information on Experimental Features that are currently available in the Scaffolder"},sidebar:"docs",previous:{title:"Dry Run Testing",permalink:"/docs/features/software-templates/dry-run-testing"},next:{title:"Templating Extensions",permalink:"/docs/features/software-templates/templating-extensions"}},c={},l=[{value:"Introduction",id:"introduction",level:2},{value:"Retries and Recovery",id:"retries-and-recovery",level:2},{value:"Form Decorators",id:"form-decorators",level:2},{value:"Installation",id:"installation",level:4},{value:"Creating a Decorator",id:"creating-a-decorator",level:4}];function d(e){const t={a:"a",code:"code",h2:"h2",h4:"h4",p:"p",pre:"pre",...(0,r.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(t.h2,{id:"introduction",children:"Introduction"}),"\n",(0,n.jsx)(t.p,{children:"This section contains information and guides on the experimental features that are currently available in the Scaffolder. Be advised that these features are still in development and may not be fully stable or complete, and are subject to change at any time."}),"\n",(0,n.jsxs)(t.p,{children:["Please leave feedback on these features in the ",(0,n.jsx)(t.a,{href:"https://discord.com/invite/MUpMjP2",children:"Backstage Discord"})," or by ",(0,n.jsx)(t.a,{href:"https://github.com/backstage/backstage/issues/new/choose",children:"creating an issue"})," on the Backstage GitHub repository."]}),"\n",(0,n.jsx)(t.h2,{id:"retries-and-recovery",children:"Retries and Recovery"}),"\n",(0,n.jsxs)(t.p,{children:["Running tasks, especially longer running ones can be at risk of being lost when the ",(0,n.jsx)(t.code,{children:"scaffolder-backend"})," plugin is redeployed. These tasks will just be stuck in a ",(0,n.jsx)(t.code,{children:"processing"})," state, with no real way to recover them."]}),"\n",(0,n.jsx)(t.p,{children:"The experimental Retries and Recovery is here to help mitigate this."}),"\n",(0,n.jsxs)(t.p,{children:["Whenever you do redeploy, on startup there will be a check of all tasks in ",(0,n.jsx)(t.code,{children:"processing"})," state that you identified in your template as being capable of starting over."]}),"\n",(0,n.jsxs)(t.p,{children:["More details about the motivation and the goals of this feature can be found in ",(0,n.jsxs)(t.a,{href:"https://github.com/backstage/backstage/tree/master/beps/0004-scaffolder-task-idempotency",children:["the ",(0,n.jsx)(t.code,{children:"Scaffolder Retries and Idempotency"})," BEP"]})]}),"\n",(0,n.jsxs)(t.p,{children:["Here is an example of how you can enable this in your ",(0,n.jsx)(t.code,{children:"template.yaml"})," manifest:"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-yaml",children:"apiVersion: scaffolder.backstage.io/v1beta3\nkind: Template\nmetadata:\n  name: recoverable-template\nspec:\n  EXPERIMENTAL_recovery:\n    EXPERIMENTAL_strategy: startOver\n"})}),"\n",(0,n.jsxs)(t.p,{children:["You'll also need enable the recovery feature, add this snippet into your ",(0,n.jsx)(t.code,{children:"app-config.yaml"})," file:"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-yaml",children:"scaffolder:\n  EXPERIMENTAL_recoverTasks: true\n"})}),"\n",(0,n.jsxs)(t.p,{children:["By default, the tasks that are in a ",(0,n.jsx)(t.code,{children:"processing"})," state and have not reported back with a heartbeat for longer than 30 seconds will be automatically recovered."]}),"\n",(0,n.jsxs)(t.p,{children:["This implies that the task's status will shift to ",(0,n.jsx)(t.code,{children:"open"})," initiating and will be restarted from the beginning. This means that it's important that your actions that you have in the template run are idempotent."]}),"\n",(0,n.jsxs)(t.p,{children:["You can look at how to incorporate ",(0,n.jsx)(t.a,{href:"https://backstage.io/docs/features/software-templates/writing-custom-actions#using-checkpoints-in-custom-actions-experimental",children:"checkpoints"})," into your custom actions to achieve that."]}),"\n",(0,n.jsx)(t.p,{children:"In the case that you would like to make the heartbeat threshold shorter or longer than the default 30 seconds, you can customize it for your needs with the configuration:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-yaml",children:"scaffolder:\n  EXPERIMENTAL_recoverTasksTimeout: { minutes: 1 }\n"})}),"\n",(0,n.jsxs)(t.p,{children:["If your task works with the filesystem and stores files in the workspace and you want to store these workspaces across runs, you can enable this with some additional config to ",(0,n.jsx)(t.code,{children:"app-config.yaml"})]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-yaml",children:"scaffolder:\n  EXPERIMENTAL_workspaceSerialization: true\n"})}),"\n",(0,n.jsx)(t.p,{children:"By default, the serialized workspace will be stored in the database, however if there's larger files, or if you're worried about the size of these files taking up space in the database you can configure bucket storage and have a sensible retention policy there to cleanup older files."}),"\n",(0,n.jsx)(t.p,{children:"At the moment we also support integration with Google GCS; to switch the serialization to this provider, you can do so with:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-yaml",children:"scaffolder:\n  EXPERIMENTAL_workspaceSerializationProvider: gcpBucket\n  EXPERIMENTAL_workspaceSerializationGcpBucketName: name-of-your-bucket\n"})}),"\n",(0,n.jsxs)(t.p,{children:["You don't need to provide any extra configuration, but you have to be sure that you are using ",(0,n.jsx)(t.a,{href:"https://cloud.google.com/iam/docs/workload-identity-federation",children:"workload identity"}),"."]}),"\n",(0,n.jsx)(t.h2,{id:"form-decorators",children:"Form Decorators"}),"\n",(0,n.jsxs)(t.p,{children:["Form decorators provide the ability to run arbitrary code before the form is submitted along with secrets to the ",(0,n.jsx)(t.code,{children:"scaffolder-backend"})," plugin. They are provided to the ",(0,n.jsx)(t.code,{children:"app"})," using a Utility API."]}),"\n",(0,n.jsx)(t.h4,{id:"installation",children:"Installation"}),"\n",(0,n.jsxs)(t.p,{children:["To install the Form Decorators, add the following to your ",(0,n.jsx)(t.code,{children:"packages/app/src/apis.ts"}),":"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-ts",children:"  createApiFactory({\n    api: formDecoratorsApiRef,\n    deps: {},\n    factory: () =>\n      DefaultScaffolderFormDecoratorsApi.create({\n        decorators: [\n          // add decorators here\n        ],\n      }),\n  }),\n"})}),"\n",(0,n.jsxs)(t.p,{children:["And then you'll also need to define which decorators run in each template using the ",(0,n.jsx)(t.code,{children:"EXPERIMENTAL_formDecorators"})," key in the template's ",(0,n.jsx)(t.code,{children:"spec"}),":"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-yaml",children:"kind: Template\nmetadata:\n  name: my-template\nspec:\n  EXPERIMENTAL_formDecorators:\n    - id: myDecorator\n      input:\n        test: something funky\n\n  parameters: ...\n  steps: ...\n"})}),"\n",(0,n.jsx)(t.h4,{id:"creating-a-decorator",children:"Creating a Decorator"}),"\n",(0,n.jsxs)(t.p,{children:["You can create a decorator using the simple helper method ",(0,n.jsx)(t.code,{children:"createScaffolderFormDecorator"}),":"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-ts",children:"export const mockDecorator = createScaffolderFormDecorator({\n  // give the decorator a name\n  id: 'mockDecorator',\n\n  // define the schema for the input that can be provided in `template.yaml`\n  schema: {\n    input: {\n      test: z => z.string(),\n    },\n  },\n  deps: {\n    // define dependencies here\n    githubApi: githubAuthApiRef,\n  },\n  decorator: async (\n    // Context has all the things needed to write simple decorators\n    { setSecrets, setFormState, input: { test } },\n    // Depepdencies injected here\n    { githubApi },\n  ) => {\n    // mutate the form state\n    setFormState(state => ({ ...state, test, mock: 'MOCK' }));\n\n    // mutate the form secrets\n    setSecrets(state => ({ ...state, GITHUB_TOKEN: 'MOCK_TOKEN' }));\n  },\n});\n"})})]})}function h(e={}){const{wrapper:t}={...(0,r.R)(),...e.components};return t?(0,n.jsx)(t,{...e,children:(0,n.jsx)(d,{...e})}):d(e)}},221020:(e,t,a)=>{var n=a(296540),r=Symbol.for("react.element"),s=Symbol.for("react.fragment"),o=Object.prototype.hasOwnProperty,i=n.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,c={key:!0,ref:!0,__self:!0,__source:!0};function l(e,t,a){var n,s={},l=null,d=null;for(n in void 0!==a&&(l=""+a),void 0!==t.key&&(l=""+t.key),void 0!==t.ref&&(d=t.ref),t)o.call(t,n)&&!c.hasOwnProperty(n)&&(s[n]=t[n]);if(e&&e.defaultProps)for(n in t=e.defaultProps)void 0===s[n]&&(s[n]=t[n]);return{$$typeof:r,type:e,key:l,ref:d,props:s,_owner:i.current}}t.Fragment=s,t.jsx=l,t.jsxs=l},474848:(e,t,a)=>{e.exports=a(221020)},28453:(e,t,a)=>{a.d(t,{R:()=>o,x:()=>i});var n=a(296540);const r={},s=n.createContext(r);function o(e){const t=n.useContext(s);return n.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function i(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),n.createElement(s.Provider,{value:t},e.children)}}}]);