/*! For license information please see 04819315.6724bd72.js.LICENSE.txt */
"use strict";(self.webpackChunkbackstage_microsite=self.webpackChunkbackstage_microsite||[]).push([[783564],{904324:(e,r,n)=>{n.r(r),n.d(r,{assets:()=>d,contentTitle:()=>a,default:()=>h,frontMatter:()=>s,metadata:()=>o,toc:()=>l});var t=n(474848),i=n(28453);const s={id:"org",title:"Microsoft Entra Tenant Data",sidebar_label:"Org Data",description:"Importing users and groups from Microsoft Entra ID into Backstage"},a=void 0,o={id:"integrations/azure/org",title:"Microsoft Entra Tenant Data",description:"Importing users and groups from Microsoft Entra ID into Backstage",source:"@site/versioned_docs/version-stable/integrations/azure/org.md",sourceDirName:"integrations/azure",slug:"/integrations/azure/org",permalink:"/docs/integrations/azure/org",draft:!1,unlisted:!1,editUrl:"https://github.com/backstage/backstage/edit/master/docs/integrations/azure/org.md",tags:[],version:"stable",frontMatter:{id:"org",title:"Microsoft Entra Tenant Data",sidebar_label:"Org Data",description:"Importing users and groups from Microsoft Entra ID into Backstage"},sidebar:"docs",previous:{title:"Discovery",permalink:"/docs/integrations/azure/discovery"},next:{title:"Locations",permalink:"/docs/integrations/bitbucketCloud/locations"}},d={},l=[{value:"Installation",id:"installation",level:2},{value:"Authenticating with Microsoft Graph",id:"authenticating-with-microsoft-graph",level:2},{value:"Local Development",id:"local-development",level:3},{value:"App Registration",id:"app-registration",level:3},{value:"Managed Identity",id:"managed-identity",level:3},{value:"Filtering imported Users and Groups",id:"filtering-imported-users-and-groups",level:2},{value:"Groups",id:"groups",level:3},{value:"Users",id:"users",level:3},{value:"Using <code>path</code> parameter",id:"using-path-parameter",level:3},{value:"Example",id:"example",level:4},{value:"User photos",id:"user-photos",level:3},{value:"Customizing Transformation",id:"customizing-transformation",level:2},{value:"Using Provider Config Transformer",id:"using-provider-config-transformer",level:3},{value:"Example Use Cases:",id:"example-use-cases",level:4},{value:"Using Custom Transformers",id:"using-custom-transformers",level:3},{value:"Transformer Examples",id:"transformer-examples",level:3},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"No data",id:"no-data",level:3},{value:"Authentication / Token Errors",id:"authentication--token-errors",level:3},{value:"Error while reading users from Microsoft Graph: Authorization_RequestDenied - Insufficient privileges to complete the operation",id:"error-while-reading-users-from-microsoft-graph-authorization_requestdenied---insufficient-privileges-to-complete-the-operation",level:3}];function c(e){const r={a:"a",admonition:"admonition",code:"code",div:"div",em:"em",h2:"h2",h3:"h3",h4:"h4",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(r.admonition,{type:"info",children:(0,t.jsxs)(r.p,{children:["This documentation is written for ",(0,t.jsx)(r.a,{href:"/docs/backend-system/",children:"the new backend system"})," which is the default since Backstage ",(0,t.jsx)(r.a,{href:"/docs/releases/v1.24.0",children:"version 1.24"}),". If you are still on the old backend system, you may want to read ",(0,t.jsx)(r.a,{href:"https://github.com/backstage/backstage/blob/v1.37.0/docs/integrations/azure/org--old.md",children:"its own article"})," instead, and ",(0,t.jsx)(r.a,{href:"/docs/backend-system/building-backends/migrating",children:"consider migrating"}),"!"]})}),"\n",(0,t.jsx)(r.p,{children:"The Backstage catalog can be set up to ingest organizational data - users and\nteams - directly from a tenant in Microsoft Entra ID via the\nMicrosoft Graph API."}),"\n",(0,t.jsx)(r.h2,{id:"installation",children:"Installation"}),"\n",(0,t.jsxs)(r.p,{children:["The package is not installed by default, therefore you have to add ",(0,t.jsx)(r.code,{children:"@backstage/plugin-catalog-backend-module-msgraph"})," to your backend package."]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-bash",metastring:'title="From your Backstage root directory"',children:"yarn --cwd packages/backend add @backstage/plugin-catalog-backend-module-msgraph\n"})}),"\n",(0,t.jsxs)(r.p,{children:["Next add the basic configuration to ",(0,t.jsx)(r.code,{children:"app-config.yaml"})]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-yaml",metastring:'title="app-config.yaml"',children:"catalog:\n  providers:\n    microsoftGraphOrg:\n      default:\n        tenantId: ${AZURE_TENANT_ID}\n        user:\n          filter: accountEnabled eq true and userType eq 'member'\n        group:\n          filter: >\n            securityEnabled eq false\n            and mailEnabled eq true\n            and groupTypes/any(c:c+eq+'Unified')\n        schedule:\n          frequency: PT1H\n          timeout: PT50M\n"})}),"\n",(0,t.jsx)(r.admonition,{type:"note",children:(0,t.jsx)(r.p,{children:"For large organizations, this plugin can take a long time, so be careful setting low frequency / timeouts and importing a large amount of users / groups for the first try."})}),"\n",(0,t.jsx)(r.p,{children:"Finally, updated your backend by adding the following line:"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-ts",metastring:'title="packages/backend/src/index.ts"',children:"backend.add(import('@backstage/plugin-catalog-backend'));\n/* highlight-add-start */\nbackend.add(import('@backstage/plugin-catalog-backend-module-msgraph'));\n/* highlight-add-end */\n"})}),"\n",(0,t.jsx)(r.h2,{id:"authenticating-with-microsoft-graph",children:"Authenticating with Microsoft Graph"}),"\n",(0,t.jsx)(r.h3,{id:"local-development",children:"Local Development"}),"\n",(0,t.jsxs)(r.p,{children:["For a local dev environment, it's recommended you have the Azure CLI or Azure PowerShell installed, and are logged in to those.\nAlternatively you can use VSCode with the Azure extension if you install ",(0,t.jsx)(r.code,{children:"@azure/identity-vscode"}),".\nWhen these are set up, the plugin will authenticate with the Microsoft Graph API without you needing to configure any credentials, or granting any special permissions.\nIf you can't do this, you'll have to create an App Registration."]}),"\n",(0,t.jsx)(r.h3,{id:"app-registration",children:"App Registration"}),"\n",(0,t.jsx)(r.p,{children:"If none of the other authentication methods work, you can create an app registration in the azure portal.\nBy default the graph plugin requires the following Application permissions (not Delegated) for Microsoft Graph:"}),"\n",(0,t.jsxs)(r.ul,{children:["\n",(0,t.jsx)(r.li,{children:(0,t.jsx)(r.code,{children:"GroupMember.Read.All"})}),"\n",(0,t.jsx)(r.li,{children:(0,t.jsx)(r.code,{children:"User.Read.All"})}),"\n"]}),"\n",(0,t.jsx)(r.p,{children:"If your organization required Admin Consent for these permissions, that will need to be granted."}),"\n",(0,t.jsxs)(r.p,{children:["When authenticating with a ClientId/ClientSecret, you can either set the ",(0,t.jsx)(r.code,{children:"AZURE_TENANT_ID"}),", ",(0,t.jsx)(r.code,{children:"AZURE_CLIENT_ID"})," and ",(0,t.jsx)(r.code,{children:"AZURE_CLIENT_SECRET"})," environment variables, or specify the values in configuration"]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-yaml",children:"microsoftGraphOrg:\n  default:\n    ##...\n    clientId: 9ef1aac6-b454-4e69-9cf5-7199df049281\n    clientSecret: REDACTED\n"})}),"\n",(0,t.jsxs)(r.p,{children:["To authenticate with a certificate rather than a client secret, you can set the ",(0,t.jsx)(r.code,{children:"AZURE_TENANT_ID"}),", ",(0,t.jsx)(r.code,{children:"AZURE_CLIENT_ID"})," and ",(0,t.jsx)(r.code,{children:"AZURE_CLIENT_CERTIFICATE_PATH"})," environments"]}),"\n",(0,t.jsx)(r.h3,{id:"managed-identity",children:"Managed Identity"}),"\n",(0,t.jsxs)(r.p,{children:["If deploying to resources that supports Managed Identity, and has identities configured (e.g. Azure App Services, Azure Container Apps), Managed Identity should be picked up without any additional configuration.\nIf your app has multiple managed identities, you may need to set the ",(0,t.jsx)(r.code,{children:"AZURE_CLIENT_ID"})," environment variable to tell Azure Identity which identity to use."]}),"\n",(0,t.jsxs)(r.p,{children:["To grant the managed identity the same permissions as mentioned in ",(0,t.jsx)(r.em,{children:"App Registration"})," above, ",(0,t.jsx)(r.a,{href:"https://docs.microsoft.com/en-us/azure/app-service/tutorial-connect-app-access-microsoft-graph-as-app-javascript?tabs=azure-powershell",children:"please follow this guide"})]}),"\n",(0,t.jsx)(r.h2,{id:"filtering-imported-users-and-groups",children:"Filtering imported Users and Groups"}),"\n",(0,t.jsxs)(r.p,{children:["By default, the plugin will import all users and groups from your directory.\nThis can be customized through ",(0,t.jsx)(r.a,{href:"https://learn.microsoft.com/en-us/graph/filter-query-parameter",children:"filters"})," and ",(0,t.jsx)(r.a,{href:"https://learn.microsoft.com/en-us/graph/search-query-parameter",children:"search"})," queries. Keep in mind that if you omit filters and search queries for the user or group properties, the plugin will automatically import all available users or groups."]}),"\n",(0,t.jsx)(r.h3,{id:"groups",children:"Groups"}),"\n",(0,t.jsxs)(r.p,{children:["A smaller set of groups can be obtained by configuring a search query or a filter.\nIf both ",(0,t.jsx)(r.code,{children:"filter"})," and ",(0,t.jsx)(r.code,{children:"search"})," are provided, then groups must match both to be ingested."]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-yaml",children:'microsoftGraphOrg:\n  providerId:\n    group:\n      filter: securityEnabled eq false and mailEnabled eq true and groupTypes/any(c:c+eq+\'Unified\')\n      search: \'"description:One" AND ("displayName:Video" OR "displayName:Drive")\'\n'})}),"\n",(0,t.jsxs)(r.p,{children:["If you don't want to only ingest groups matching the ",(0,t.jsx)(r.code,{children:"search"})," and/or ",(0,t.jsx)(r.code,{children:"filter"})," query, but also the groups which are members of the matched groups, you can use the ",(0,t.jsx)(r.code,{children:"includeSubGroups"})," configuration:"]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-yaml",children:'microsoftGraphOrg:\n  providerId:\n    group:\n      filter: securityEnabled eq false and mailEnabled eq true and groupTypes/any(c:c+eq+\'Unified\')\n      search: \'"description:One" AND ("displayName:Video" OR "displayName:Drive")\'\n      includeSubGroups: true\n'})}),"\n",(0,t.jsx)(r.p,{children:"In addition to these groups, one additional group will be created for your organization.\nAll imported groups will be a child of this group."}),"\n",(0,t.jsxs)(r.p,{children:["By default the provider will get groups using the msgraph ",(0,t.jsx)(r.code,{children:"/group"})," endpoint, but it is possible to use different endpoints by setting the ",(0,t.jsx)(r.code,{children:"path"})," configuration. All the endpoint containing ",(0,t.jsx)(r.code,{children:"/microsoft.graph.group"})," will return the right type of group object. ",(0,t.jsx)(r.a,{href:"#Using-path-parameter",children:"See usage"})," for more details."]}),"\n",(0,t.jsx)(r.h3,{id:"users",children:"Users"}),"\n",(0,t.jsxs)(r.p,{children:["There are two modes for importing users - You can import all user objects matching a ",(0,t.jsx)(r.code,{children:"filter"}),"."]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-yaml",children:"microsoftGraphOrg:\n  providerId:\n    user:\n      filter: accountEnabled eq true and userType eq 'member'\n"})}),"\n",(0,t.jsxs)(r.p,{children:["Alternatively you can import users that are members of specific groups.\nFor each group matching the ",(0,t.jsx)(r.code,{children:"search"})," and ",(0,t.jsx)(r.code,{children:"filter"})," query, each group member will be imported.\nOnly direct group members will be imported, not transient users."]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-yaml",children:'microsoftGraphOrg:\n  providerId:\n    userGroupMember:\n      filter: "displayName eq \'Backstage Users\'"\n      search: \'"description:One" AND ("displayName:Video" OR "displayName:Drive")\'\n'})}),"\n",(0,t.jsxs)(r.p,{children:["By default the provider will get user using the msgraph ",(0,t.jsx)(r.code,{children:"/user"})," endpoint, but it is possible to use different endpoints by setting the ",(0,t.jsx)(r.code,{children:"path"})," configuration. All the endpoint containing ",(0,t.jsx)(r.code,{children:"/microsoft.graph.user"})," will return the right type of user object. ",(0,t.jsx)(r.a,{href:"#Using-path-parameter",children:"See usage"})," for more details."]}),"\n",(0,t.jsxs)(r.h3,{id:"using-path-parameter",children:["Using ",(0,t.jsx)(r.code,{children:"path"})," parameter"]}),"\n",(0,t.jsxs)(r.p,{children:["By default the provider will get groups and users using the msgraph ",(0,t.jsx)(r.code,{children:"/group"})," and ",(0,t.jsx)(r.code,{children:"/user"})," endpoints, but it is possible to use different endpoints by setting the ",(0,t.jsx)(r.code,{children:"path"})," configuration.\nAll the endpoint containing ",(0,t.jsx)(r.code,{children:"/microsoft.graph.user"})," will return the right type of user object and all the endpoint containing ",(0,t.jsx)(r.code,{children:"/microsoft.graph.group"})," will return the right type of group object."]}),"\n",(0,t.jsx)(r.h4,{id:"example",children:"Example"}),"\n",(0,t.jsxs)(r.p,{children:["Given the following org structure it is possible to use the ",(0,t.jsx)(r.code,{children:"path"})," parameter to get all the users and groups that are members of the group ",(0,t.jsx)(r.code,{children:"someRootGroup"})," on all levels."]}),"\n",(0,t.jsxs)(r.div,{align:"center",children:["\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.img,{alt:"email",src:n(2188).A+"",width:"452",height:"425"})}),"\n"]}),"\n",(0,t.jsx)(r.p,{children:"The configuration would look like this:"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-yaml",children:"microsoftGraphOrg:\n  providerId:\n    group:\n      path: /groups/{someRootGroup id}/transitiveMembers/microsoft.graph.group\n    user:\n      path: /groups/{someRootGroup id}/transitiveMembers/microsoft.graph.user\n"})}),"\n",(0,t.jsxs)(r.p,{children:["Using the transitive members endpoint will return all the users and groups that are members of the group ",(0,t.jsx)(r.code,{children:"someRootGroup"})," on all levels."]}),"\n",(0,t.jsx)(r.h3,{id:"user-photos",children:"User photos"}),"\n",(0,t.jsxs)(r.p,{children:["By default, the photos of users will be fetched and added to each user entity. For huge organizations this may be unfeasible, as it will take a ",(0,t.jsx)(r.em,{children:"very"})," long time, and can be disabled by setting ",(0,t.jsx)(r.code,{children:"loadPhotos"})," to ",(0,t.jsx)(r.code,{children:"false"}),":"]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-yaml",children:"microsoftGraphOrg:\n  providerId:\n    user:\n      filter: ...\n      loadPhotos: false\n"})}),"\n",(0,t.jsxs)(r.p,{children:["If you are using ",(0,t.jsx)(r.code,{children:"userGroupMember"}),", the configuration for ",(0,t.jsx)(r.code,{children:"loadPhotos"})," should still be managed under ",(0,t.jsx)(r.code,{children:"users:"})," while omitting ",(0,t.jsx)(r.code,{children:"search"})," and ",(0,t.jsx)(r.code,{children:"filters"}),"."]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-yaml",children:'microsoftGraphOrg:\n  providerId:\n    user:\n      loadPhotos: false\n    userGroupMember:\n      filter: "displayName eq \'Backstage Users\'"\n      search: \'"description:One" AND ("displayName:Video" OR "displayName:Drive")\'\n'})}),"\n",(0,t.jsx)(r.h2,{id:"customizing-transformation",children:"Customizing Transformation"}),"\n",(0,t.jsxs)(r.p,{children:["Ingested entities can be customized by providing custom transformers.\nThese can be used to completely replace the built in logic, or used to tweak it by using the default transformers (",(0,t.jsx)(r.code,{children:"defaultGroupTransformer"}),", ",(0,t.jsx)(r.code,{children:"defaultUserTransformer"})," and ",(0,t.jsx)(r.code,{children:"defaultOrganizationTransformer"}),"\nEntities can also be excluded from backstage by returning ",(0,t.jsx)(r.code,{children:"undefined"}),"."]}),"\n",(0,t.jsx)(r.p,{children:"When using custom transformers, you may want to customize the data returned.\nSeveral configuration options can be provided to tweak the Microsoft Graph query to get the data you need"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-yaml",children:"microsoftGraphOrg:\n  providerId:\n    user:\n      expand: manager\n    group:\n      expand: member\n      select: ['id', 'displayName', 'description']\n"})}),"\n",(0,t.jsx)(r.h3,{id:"using-provider-config-transformer",children:"Using Provider Config Transformer"}),"\n",(0,t.jsxs)(r.p,{children:["Dynamic configuration scaling allows the ",(0,t.jsx)(r.code,{children:"msgraph"})," catalog plugin to adjust its settings at runtime without requiring a redeploy. This feature is useful for scenarios where configuration needs to be updated based on real-time events or changing conditions. For example, you can dynamically adjust synchronization schedules, filters, and search parameters to optimize performance and responsiveness."]}),"\n",(0,t.jsx)(r.admonition,{type:"note",children:(0,t.jsxs)(r.p,{children:["Adjusting fields that are not used on each scheduled ingestion (e.g., ",(0,t.jsx)(r.code,{children:"id"}),", ",(0,t.jsx)(r.code,{children:"schedule"}),") will have no effect."]})}),"\n",(0,t.jsx)(r.admonition,{type:"warning",children:(0,t.jsx)(r.p,{children:"Dynamically changing configuration on the fly can introduce unintended consequences, such as system instability and configuration errors. Please review your transformer carefully to ensure that it is working as anticipated!"})}),"\n",(0,t.jsx)(r.h4,{id:"example-use-cases",children:"Example Use Cases:"}),"\n",(0,t.jsxs)(r.ul,{children:["\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.strong,{children:"Filter Scaling"}),": Adjust filters like ",(0,t.jsx)(r.code,{children:"userGroupMember"})," and ",(0,t.jsx)(r.code,{children:"groupFilter"})," dynamically."]}),"\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.strong,{children:"Search Parameter Adjustment"}),": Change search parameters such as ",(0,t.jsx)(r.code,{children:"groupSearch"})," and ",(0,t.jsx)(r.code,{children:"userSelect"})," on-the-fly."]}),"\n"]}),"\n",(0,t.jsx)(r.h3,{id:"using-custom-transformers",children:"Using Custom Transformers"}),"\n",(0,t.jsxs)(r.p,{children:["Transformers can be configured by extending ",(0,t.jsx)(r.code,{children:"microsoftGraphOrgEntityProviderTransformExtensionPoint"}),". Here is an example:"]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-ts",metastring:'title="packages/backend/src/index.ts"',children:"import { createBackendModule } from '@backstage/backend-plugin-api';\nimport { microsoftGraphOrgEntityProviderTransformExtensionPoint } from '@backstage/plugin-catalog-backend-module-msgraph/alpha';\nimport {\n  myUserTransformer,\n  myGroupTransformer,\n  myOrganizationTransformer,\n  myProviderConfigTransformer,\n} from './transformers';\n\nbackend.add(\n  createBackendModule({\n    pluginId: 'catalog',\n    moduleId: 'microsoft-graph-extensions',\n    register(env) {\n      env.registerInit({\n        deps: {\n          /* highlight-add-start */\n          microsoftGraphTransformers:\n            microsoftGraphOrgEntityProviderTransformExtensionPoint,\n          /* highlight-add-end */\n        },\n        async init({ microsoftGraphTransformers }) {\n          /* highlight-add-start */\n          microsoftGraphTransformers.setUserTransformer(myUserTransformer);\n          microsoftGraphTransformers.setGroupTransformer(myGroupTransformer);\n          microsoftGraphTransformers.setOrganizationTransformer(\n            myOrganizationTransformer,\n          );\n          microsoftGraphTransformers.setProviderConfigTransformer(\n            myProviderConfigTransformer,\n          );\n          /* highlight-add-end */\n        },\n      });\n    },\n  }),\n);\n"})}),"\n",(0,t.jsxs)(r.p,{children:["The ",(0,t.jsx)(r.code,{children:"myUserTransformer"}),", ",(0,t.jsx)(r.code,{children:"myGroupTransformer"}),", ",(0,t.jsx)(r.code,{children:"myOrganizationTransformer"}),", and ",(0,t.jsx)(r.code,{children:"myProviderConfigTransformer"})," transformer functions are from the examples in the section below."]}),"\n",(0,t.jsx)(r.h3,{id:"transformer-examples",children:"Transformer Examples"}),"\n",(0,t.jsxs)(r.p,{children:["The following provides an example of each kind of transformer. We recommend creating a ",(0,t.jsx)(r.code,{children:"transformers.ts"})," file in your ",(0,t.jsx)(r.code,{children:"packages/backend/src"})," folder for these."]}),"\n",(0,t.jsx)(r.p,{children:"First, lets set up the basic structure of the file, with functions for each kind of transformer that simply passes through the default transformer unchanged."}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-ts",metastring:'title="packages/backend/src/extensions/transformers.ts"',children:"import * as MicrosoftGraph from '@microsoft/microsoft-graph-types';\nimport {\n  defaultGroupTransformer,\n  defaultUserTransformer,\n  defaultOrganizationTransformer,\n  microsoftGraphOrgEntityProviderTransformExtensionPoint,\n  MicrosoftGraphProviderConfig,\n} from '@backstage/plugin-catalog-backend-module-msgraph';\nimport { GroupEntity, UserEntity } from '@backstage/catalog-model';\nimport { createBackendModule } from '@backstage/backend-plugin-api';\n\n// The Group transformer transforms Groups that are ingested from MS Graph\nexport async function myGroupTransformer(\n  group: MicrosoftGraph.Group,\n  groupPhoto?: string,\n): Promise<GroupEntity | undefined> {\n  const backstageGroup = await defaultGroupTransformer(group, groupPhoto);\n  return backstageGroup;\n}\n\n// The User transformer transforms Users that are ingested from MS Graph\nexport async function myUserTransformer(\n  graphUser: MicrosoftGraph.User,\n  userPhoto?: string,\n): Promise<UserEntity | undefined> {\n  const backstageUser = await defaultUserTransformer(graphUser, userPhoto);\n  return backstageUser;\n}\n\n// The Organization transformer transforms the root MS Graph Organization into a Group\nexport async function myOrganizationTransformer(\n  graphOrganization: MicrosoftGraph.Organization,\n): Promise<GroupEntity | undefined> {\n  const backstageOrg = await defaultOrganizationTransformer(graphOrganization);\n  return backstageOrg;\n}\n\n// The Provider Config transformer enables modification of the plugin config\nexport async function myProviderConfigTransformer(\n  provider: MicrosoftGraphProviderConfig,\n): Promise<MicrosoftGraphProviderConfig> {\n  return provider;\n}\n\n// Wrapping these functions in a Module allows us to inject them into the Catalog plugin easily\nexport default createBackendModule({\n  pluginId: 'catalog',\n  moduleId: 'msgraph-org',\n  register(reg) {\n    reg.registerInit({\n      deps: {\n        microsoftGraphTransformers:\n          microsoftGraphOrgEntityProviderTransformExtensionPoint,\n      },\n      async init({ microsoftGraphTransformers }) {\n        // Set the transformers to our custom functions\n        microsoftGraphTransformers.setUserTransformer(myUserTransformer);\n        microsoftGraphTransformers.setGroupTransformer(myGroupTransformer);\n        microsoftGraphTransformers.setOrganizationTransformer(\n          myOrganizationTransformer,\n        );\n        microsoftGraphTransformers.setProviderConfigTransformer(\n          myProviderConfigTransformer,\n        );\n      },\n    });\n  },\n});\n"})}),"\n",(0,t.jsx)(r.p,{children:"Now lets customize each of the providers to suit our needs."}),"\n",(0,t.jsx)(r.p,{children:"This Group Transformer example will have the default logic completely removed and replaced with our custom logic:"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-ts",children:"export async function myGroupTransformer(\n  group: MicrosoftGraph.Group,\n  groupPhoto?: string,\n): Promise<GroupEntity | undefined> {\n  // highlight-remove-start\n  const backstageGroup = await defaultGroupTransformer(group, groupPhoto);\n  return backstageGroup;\n  // highlight-remove-end\n  // highlight-add-start\n  // All of our groups are prefixed with the organisational unit: 'Engineering - Team A'\n  // We want to drop the org unit from the group name and use it for the namespace instead\n  const groupNameArr = group.displayName.split(' - ');\n  const displayName = groupNameArr[1];\n  // Standardise name and namespace by replacing spaces with hyphens and converting to lowercase\n  const namespace = groupNameArr[0].replace(' ', '-').toLowerCase();\n  const groupName = groupNameArr[1].replace(' ', '-').toLowerCase();\n\n  return {\n    apiVersion: 'backstage.io/v1alpha1',\n    kind: 'Group',\n    metadata: {\n      name: groupName,\n      description: group.description,\n      annotations: {},\n    },\n    spec: {\n      type: 'team',\n      displayName: displayName,\n      email: group.mail,\n      children: [],\n    },\n  };\n  // highlight-add-end\n}\n"})}),"\n",(0,t.jsx)(r.p,{children:"This User Transformer example makes use of the built-in logic, but also modifies the username and sets a description"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-ts",children:"export async function myUserTransformer(\n  graphUser: MicrosoftGraph.User,\n  userPhoto?: string,\n): Promise<UserEntity | undefined> {\n  const backstageUser = await defaultUserTransformer(graphUser, userPhoto);\n  // highlight-add-start\n  // Make sure the default transformer returned an entity\n  if (backstageUser) {\n    // Update the description to make it obvious where this entity came from\n    backstageUser.metadata.description =\n      'Loaded from Microsoft Entra ID via MyCustomUserTransformer';\n\n    // The default transformer sets the username to the email address with invalid characters subbed out: 'user_domain.com'\n    // Set the username to the local part of the email address in lowercase without the domain\n    const newName = backstageUser.metadata.name.split('_')[0].toLowerCase();\n    backstageUser.metadata.name = newName;\n\n    return backstageUser;\n  }\n  return undefined;\n  // highlight-add-end\n  // highlight-remove-start\n  return backstageUser;\n  // highlight-remove-end\n}\n"})}),"\n",(0,t.jsx)(r.p,{children:"This Organization Transformer example removes the organization group completely by returning undefined"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-ts",children:"export async function myOrganizationTransformer(\n  graphOrganization: MicrosoftGraph.Organization,\n): Promise<GroupEntity | undefined> {\n  // highlight-remove-start\n  const backstageOrg = await defaultOrganizationTransformer(graphOrganization);\n  return backstageOrg;\n  // highlight-remove-end\n  // highlight-add-start\n  // The org transformer creates a group to be used as the base of the relationship tree for groups\n  // We don't need this to be created, so return undefined instead of an entity\n  return undefined;\n  // highlight-add-end\n}\n"})}),"\n",(0,t.jsx)(r.p,{children:"This Config Transformer example expands the group filter to also include 'azure-group-a'"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-ts",children:"export async function myProviderConfigTransformer(\n  provider: MicrosoftGraphProviderConfig,\n): Promise<MicrosoftGraphProviderConfig> {\n  // highlight-add-start\n  // The filter in our config file relies on a property that has been intermittantly causing this important group to fail ingestion\n  // Ensure the group is always discovered by the filter\n  if (!provider.groupFilter?.includes('azure-group-a')) {\n    provider.groupFilter = `${provider.groupFilter} or displayName eq 'azure-group-a'`;\n  }\n  // highlight-add-end\n  return provider;\n}\n"})}),"\n",(0,t.jsx)(r.p,{children:"Now we just need to add our new module to the Backend."}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-ts",metastring:'title="packages/backend/src/index.ts"',children:"// Your file will have more than this in it\n\nconst backend = createBackend();\n\n...\n\n// highlight-add-start\nbackend.add(import('./extensions/transformers'));\n// highlight-add-end\n\n...\n\nbackend.start();\n"})}),"\n",(0,t.jsx)(r.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,t.jsx)(r.h3,{id:"no-data",children:"No data"}),"\n",(0,t.jsxs)(r.p,{children:["First check your logs for the message ",(0,t.jsx)(r.code,{children:"Reading msgraph users and groups"}),".\nIf you don't see this, check you've registered the provider, and that the schedule is valid"]}),"\n",(0,t.jsxs)(r.p,{children:["If you see a log entry ",(0,t.jsx)(r.code,{children:"Read 0 msgraph users and 0 msgraph groups"}),", check your search and filter arguments."]}),"\n",(0,t.jsxs)(r.p,{children:["If you see the start message (",(0,t.jsx)(r.code,{children:"Reading msgraph users and groups"}),") but no end message (",(0,t.jsx)(r.code,{children:"Read X msgraph users and Y msgraph groups"}),"), then it is likely the job is taking a long time due to a large volume of data.\nThe default behavior is to import all users and groups, which is often more data than needed.\nTry importing a smaller set of data (e.g. ",(0,t.jsx)(r.code,{children:"filter: displayName eq 'John Smith'"}),")."]}),"\n",(0,t.jsx)(r.h3,{id:"authentication--token-errors",children:"Authentication / Token Errors"}),"\n",(0,t.jsxs)(r.p,{children:["See ",(0,t.jsx)(r.a,{href:"https://aka.ms/azsdk/js/identity/troubleshoot",children:"Troubleshooting Azure Identity Authentication Issues"})]}),"\n",(0,t.jsx)(r.h3,{id:"error-while-reading-users-from-microsoft-graph-authorization_requestdenied---insufficient-privileges-to-complete-the-operation",children:"Error while reading users from Microsoft Graph: Authorization_RequestDenied - Insufficient privileges to complete the operation"}),"\n",(0,t.jsxs)(r.ul,{children:["\n",(0,t.jsx)(r.li,{children:"Make sure you've granted all the required permissions to your application registration or managed identity"}),"\n",(0,t.jsxs)(r.li,{children:["Make sure the permissions are ",(0,t.jsx)(r.code,{children:"Application"})," permissions rather than ",(0,t.jsx)(r.code,{children:"Delegated"})]}),"\n",(0,t.jsx)(r.li,{children:'If your organization has configured "Admin consent" to be required, make sure this has been granted for your application permissions'}),"\n",(0,t.jsxs)(r.li,{children:["If your group queries are returning Microsoft Teams groups, you may need to grant addition permissions (e.g. ",(0,t.jsx)(r.code,{children:"Team.ReadBasic.All"}),", ",(0,t.jsx)(r.code,{children:"TeamMember.Read.All"}),")"]}),"\n",(0,t.jsxs)(r.li,{children:["If you've added additional ",(0,t.jsx)(r.code,{children:"select"})," or ",(0,t.jsx)(r.code,{children:"expand"})," fields, those may need additional permissions granted"]}),"\n"]})]})}function h(e={}){const{wrapper:r}={...(0,i.R)(),...e.components};return r?(0,t.jsx)(r,{...e,children:(0,t.jsx)(c,{...e})}):c(e)}},221020:(e,r,n)=>{var t=n(296540),i=Symbol.for("react.element"),s=Symbol.for("react.fragment"),a=Object.prototype.hasOwnProperty,o=t.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,d={key:!0,ref:!0,__self:!0,__source:!0};function l(e,r,n){var t,s={},l=null,c=null;for(t in void 0!==n&&(l=""+n),void 0!==r.key&&(l=""+r.key),void 0!==r.ref&&(c=r.ref),r)a.call(r,t)&&!d.hasOwnProperty(t)&&(s[t]=r[t]);if(e&&e.defaultProps)for(t in r=e.defaultProps)void 0===s[t]&&(s[t]=r[t]);return{$$typeof:i,type:e,key:l,ref:c,props:s,_owner:o.current}}r.Fragment=s,r.jsx=l,r.jsxs=l},474848:(e,r,n)=>{e.exports=n(221020)},2188:(e,r,n)=>{n.d(r,{A:()=>t});const t=n.p+"assets/images/org-8bddc5a316579d360f882e608552cd8c.svg"},28453:(e,r,n)=>{n.d(r,{R:()=>a,x:()=>o});var t=n(296540);const i={},s=t.createContext(i);function a(e){const r=t.useContext(s);return t.useMemo((function(){return"function"==typeof e?e(r):{...r,...e}}),[r,e])}function o(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),t.createElement(s.Provider,{value:r},e.children)}}}]);