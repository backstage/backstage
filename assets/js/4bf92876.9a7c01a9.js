"use strict";(self.webpackChunkbackstage_microsite=self.webpackChunkbackstage_microsite||[]).push([["23216"],{331228(e,n,i){i.r(n),i.d(n,{assets:()=>s,contentTitle:()=>r,default:()=>h,frontMatter:()=>l,metadata:()=>t,toc:()=>c});var t=i(906614),a=i(474848),o=i(28453);let l={id:"writing",title:"Writing Backstage Configuration Files",description:"Documentation on Writing Backstage Configuration Files"},r,s={},c=[{value:"File Format",id:"file-format",level:2},{value:"Environment Variable Overrides",id:"environment-variable-overrides",level:2},{value:"Configuration Files",id:"configuration-files",level:2},{value:"Includes and Dynamic Data",id:"includes-and-dynamic-data",level:2},{value:"Env Includes",id:"env-includes",level:3},{value:"File Includes",id:"file-includes",level:3},{value:"Including Files",id:"including-files",level:3},{value:"Environment Variable Substitution",id:"environment-variable-substitution",level:2},{value:"Combining Includes and Environment Variable Substitution",id:"combining-includes-and-environment-variable-substitution",level:2}];function d(e){let n={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.h2,{id:"file-format",children:"File Format"}),"\n",(0,a.jsxs)(n.p,{children:["Configuration is stored in YAML format in ",(0,a.jsx)(n.code,{children:"app-config.yaml"})," files. This\nconfiguration is shared between the frontend and backend and it looks something\nlike this:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:"app:\n  title: Backstage Example App\n  baseUrl: http://localhost:3000\n\nbackend:\n  listen: 0.0.0.0:7007\n  baseUrl: http://localhost:7007\n\norganization:\n  name: CNCF\n\nproxy:\n  /my/api:\n    target: https://example.com/api/\n    changeOrigin: true\n    pathRewrite:\n      ^/proxy/my/api/: /\n"})}),"\n",(0,a.jsx)(n.p,{children:"Configuration files are typically checked in and stored in the repo that houses\nthe rest of the Backstage application."}),"\n",(0,a.jsx)(n.p,{children:"The particular configuration that is available to each Backstage app depends on\nwhat plugins and packages are installed. To view the configuration reference for\nyour own project, including what configuration keys available and whether they\nare needed by the frontend, use the following command:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-sh",children:"yarn backstage-cli config:docs\n"})}),"\n",(0,a.jsx)(n.h2,{id:"environment-variable-overrides",children:"Environment Variable Overrides"}),"\n",(0,a.jsxs)(n.p,{children:["Individual configuration values can be overridden using environment variables\nprefixed with ",(0,a.jsx)(n.code,{children:"APP_CONFIG_"}),". Everything following that prefix in the environment\nvariable name will be used as the config key, with ",(0,a.jsx)(n.code,{children:"_"})," replaced by ",(0,a.jsx)(n.code,{children:"."}),". For\nexample, to override the ",(0,a.jsx)(n.code,{children:"app.baseUrl"})," value, set the ",(0,a.jsx)(n.code,{children:"APP_CONFIG_app_baseUrl"}),"\nenvironment variable to the desired value."]}),"\n",(0,a.jsxs)(n.p,{children:["The value of the environment variable is parsed as JSON, but it will fall back\nto being interpreted as a string if it fails to parse. Note that if you for\nexample want to pass on the string ",(0,a.jsx)(n.code,{children:'"false"'}),", you need to wrap it in double\nquotes, e.g. ",(0,a.jsx)(n.code,{children:"export APP_CONFIG_example='\"false\"'"}),"."]}),"\n",(0,a.jsx)(n.p,{children:"While it may be tempting to use environment variable overrides for supplying a\nlot of configuration values, we recommend using them sparingly. Try to stick to\nusing configuration files, and only use environment variables for things like\nreusing deployment artifacts across staging and production environments."}),"\n",(0,a.jsxs)(n.p,{children:["Note that environment variables work for frontend configuration too. They are\npicked up by the serve tasks of ",(0,a.jsx)(n.code,{children:"@backstage/cli"})," for local development, and are\ninjected by the entrypoint of the nginx container serving the frontend in a\nproduction build."]}),"\n",(0,a.jsx)(n.h2,{id:"configuration-files",children:"Configuration Files"}),"\n",(0,a.jsxs)(n.p,{children:["It is possible to have multiple configuration files (bundled and/or remote*),\nboth to support different environments, but also to define configuration that is\nlocal to specific packages. The configuration files to load are selected using a\n",(0,a.jsx)(n.code,{children:"--config <local-path|url>"})," flag, and it is possible to load any number of\nfiles. Paths are relative to the working directory of the executed process, for\nexample ",(0,a.jsx)(n.code,{children:"package/backend"}),". This means that to select a config file in the repo\nroot when running the backend, you would use ",(0,a.jsx)(n.code,{children:"--config ../../my-config.yaml"}),",\nand for config file on a config server you would use\n",(0,a.jsx)(n.code,{children:"--config https://some.domain.io/app-config.yaml"})]}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"Note"}),": In case URLs are passed, it is also needed to set the remote option in\nthe loadBackendConfig call."]}),"\n",(0,a.jsxs)(n.p,{children:["If no ",(0,a.jsx)(n.code,{children:"config"})," flags are specified, the default behavior is to load\n",(0,a.jsx)(n.code,{children:"app-config.yaml"})," and, if it exists, ",(0,a.jsx)(n.code,{children:"app-config.local.yaml"})," from the repo root.\nIn the provided project setup, ",(0,a.jsx)(n.code,{children:"app-config.local.yaml"})," is ",(0,a.jsx)(n.code,{children:".gitignore"}),"'d, making\nit a good place to add config overrides and secrets for local development."]}),"\n",(0,a.jsxs)(n.p,{children:["Note that if any config flags are provided, the default ",(0,a.jsx)(n.code,{children:"app-config.yaml"})," files\nare NOT loaded. To include them you need to explicitly include them with a flag,\nfor example:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"yarn start --config ../../app-config.yaml --config ../../app-config.staging.yaml --config https://some.domain.io/app-config.yaml\n"})}),"\n",(0,a.jsx)(n.p,{children:"All loaded configuration files are merged together using the following rules:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"Configurations have different priority, higher priority means you replace\nvalues from configurations with lower priority."}),"\n",(0,a.jsx)(n.li,{children:"Primitive values are completely replaced, as are arrays and all of their\ncontents."}),"\n",(0,a.jsx)(n.li,{children:"Objects are merged together deeply, meaning that if any of the included\nconfigs contain a value for a given path, it will be found."}),"\n",(0,a.jsxs)(n.li,{children:["A ",(0,a.jsx)(n.code,{children:"null"})," value in a config file will be treated as an explicit absence of\nconfiguration. This means that the reading will not fall back to a lower priority\nconfig, but it will still be treated as if the configuration was not present."]}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"The priority of the configurations is determined by the following rules, in\norder:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["Configuration from the ",(0,a.jsx)(n.code,{children:"APP_CONFIG_"})," environment variables has the highest\npriority, followed by files."]}),"\n",(0,a.jsx)(n.li,{children:"Files loaded with config flags are ordered by priority, where the last flag\nhas the highest priority."}),"\n",(0,a.jsxs)(n.li,{children:["If no config flags are provided, ",(0,a.jsx)(n.code,{children:"app-config.local.yaml"})," has higher priority\nthan ",(0,a.jsx)(n.code,{children:"app-config.yaml"}),"."]}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"includes-and-dynamic-data",children:"Includes and Dynamic Data"}),"\n",(0,a.jsxs)(n.p,{children:["Includes are supported via special data loading keys that are prefixed with ",(0,a.jsx)(n.code,{children:"$"}),",\nwhich in turn provide a number of different ways to read in data. To load in an\nexternal configuration value, supply an object with one of the special include\nkeys, for example ",(0,a.jsx)(n.code,{children:"$env"})," or ",(0,a.jsx)(n.code,{children:"$file"}),". A full list of supported include keys can\nbe found below. For example, the following will read the config key\n",(0,a.jsx)(n.code,{children:"backend.mySecretKey"})," from the environment variable ",(0,a.jsx)(n.code,{children:"MY_SECRET_KEY"}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:"backend:\n  mySecretKey:\n    $env: MY_SECRET_KEY\n"})}),"\n",(0,a.jsxs)(n.p,{children:["With the above configuration, calling ",(0,a.jsx)(n.code,{children:"config.getString('backend.mySecretKey')"}),"\nwill return the value of the environment variable ",(0,a.jsx)(n.code,{children:"MY_SECRET_KEY"})," when the\nbackend started up. All includes are loaded at startup, so changing the contents\nof files or environment variables will not be reflected at runtime."]}),"\n",(0,a.jsx)(n.p,{children:"Below is a list of the currently supported methods for loading includes."}),"\n",(0,a.jsx)(n.h3,{id:"env-includes",children:"Env Includes"}),"\n",(0,a.jsxs)(n.p,{children:["This reads a string value from an environment variable. For example, the\nfollowing configuration loads the string value from the ",(0,a.jsx)(n.code,{children:"MY_SECRET"})," environment\nvariable."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:"$env: MY_SECRET\n"})}),"\n",(0,a.jsxs)(n.p,{children:["Note however, that it's often more convenient to use\n",(0,a.jsx)(n.a,{href:"#environment-variable-substitution",children:"environment variable substitution"})," instead."]}),"\n",(0,a.jsx)(n.h3,{id:"file-includes",children:"File Includes"}),"\n",(0,a.jsxs)(n.p,{children:["This reads a string value from the entire contents of a text file. The file path\nis relative to the source config file. For example, the following reads the\ncontents of ",(0,a.jsx)(n.code,{children:"my-secret.txt"})," relative to the config file itself:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:"$file: ./my-secret.txt\n"})}),"\n",(0,a.jsx)(n.h3,{id:"including-files",children:"Including Files"}),"\n",(0,a.jsxs)(n.p,{children:["The ",(0,a.jsx)(n.code,{children:"$include"})," keyword can be used to load configuration values from an external\nfile. It's able to load and parse data from ",(0,a.jsx)(n.code,{children:".json"}),", ",(0,a.jsx)(n.code,{children:".yml"}),", and ",(0,a.jsx)(n.code,{children:".yaml"})," files.\nIt's also possible to include a URL fragment (",(0,a.jsx)(n.code,{children:"#"}),") to point to a value at the\ngiven path in the file, using a dot-separated list of keys."]}),"\n",(0,a.jsxs)(n.p,{children:["For example, the following would read ",(0,a.jsx)(n.code,{children:"my-secret-key"})," from ",(0,a.jsx)(n.code,{children:"my-secrets.json"}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:"$include: ./my-secrets.json#deployment.key\n"})}),"\n",(0,a.jsxs)(n.p,{children:["Example ",(0,a.jsx)(n.code,{children:"my-secrets.json"})," file:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-json",children:'{\n  "deployment": {\n    "key": "my-secret-key"\n  }\n}\n'})}),"\n",(0,a.jsx)(n.h2,{id:"environment-variable-substitution",children:"Environment Variable Substitution"}),"\n",(0,a.jsxs)(n.p,{children:["Configuration files support environment variable substitution via a ",(0,a.jsx)(n.code,{children:"${MY_VAR}"}),"\nsyntax. For example:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:"app:\n  baseUrl: https://${HOST}\n"})}),"\n",(0,a.jsxs)(n.p,{children:["Note that all environment variables must be available, or the entire\nconfiguration value will evaluate to ",(0,a.jsx)(n.code,{children:"undefined"}),"."]}),"\n",(0,a.jsxs)(n.p,{children:["The substitution syntax can be escaped using ",(0,a.jsx)(n.code,{children:"$${...}"}),", which will be resolved\nas ",(0,a.jsx)(n.code,{children:"${...}"}),"."]}),"\n",(0,a.jsxs)(n.p,{children:["Parameter substitution syntax (e.g. ",(0,a.jsx)(n.code,{children:"${MY_VAR:-default-value}"}),") is also\nsupported to provide a default or fallback value for a given environment\nvariable if it is unset, or is declared but has no value. For example:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:"app:\n  baseUrl: https://${HOST:-localhost:3000}\n"})}),"\n",(0,a.jsxs)(n.p,{children:["In the above example, when ",(0,a.jsx)(n.code,{children:"HOST"})," is unset or has no value, it will be\nsubstituted with ",(0,a.jsx)(n.code,{children:"localhost:3000"}),"."]}),"\n",(0,a.jsx)(n.h2,{id:"combining-includes-and-environment-variable-substitution",children:"Combining Includes and Environment Variable Substitution"}),"\n",(0,a.jsx)(n.p,{children:"The Includes and Environment Variable Substitutions can be combined to do\nsomething like read a secrets configuration for a specific environment. For\nexample:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:"integrations:\n  github:\n    - host: github.com\n      apps:\n        - $include: secrets.${BACKSTAGE_ENVIRONMENT}.yaml\n"})}),"\n",(0,a.jsxs)(n.p,{children:["Example ",(0,a.jsx)(n.code,{children:"secrets.prod.yaml"}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:"appId: 1\nwebhookUrl: https://smee.io/foo\nclientId: someGithubAppClientId\nclientSecret: someGithubAppClientSecret\nwebhookSecret: someWebhookSecret\nprivateKey: |\n  -----BEGIN RSA PRIVATE KEY-----\n  SomeRsaPrivateKeySecurelyStored\n  -----END RSA PRIVATE KEY-----\n"})}),"\n",(0,a.jsx)(n.admonition,{type:"warning",children:(0,a.jsx)(n.p,{children:"Sensitive information, such as private keys, should not be hard coded."})}),"\n",(0,a.jsx)(n.p,{children:"We recommend that this entire file should be a secret and stored as such in a secure storage solution like Vault, to ensure they are neither exposed nor misused. This example key part only shows the format on how to use the yaml | syntax to make sure that the key is valid."})]})}function h(e={}){let{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(d,{...e})}):d(e)}},28453(e,n,i){i.d(n,{R:()=>l,x:()=>r});var t=i(296540);let a={},o=t.createContext(a);function l(e){let n=t.useContext(o);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:l(e.components),t.createElement(o.Provider,{value:n},e.children)}},906614(e){e.exports=JSON.parse('{"id":"conf/writing","title":"Writing Backstage Configuration Files","description":"Documentation on Writing Backstage Configuration Files","source":"@site/../docs/conf/writing.md","sourceDirName":"conf","slug":"/conf/writing","permalink":"/docs/next/conf/writing","draft":false,"unlisted":false,"editUrl":"https://github.com/backstage/backstage/edit/master/docs/conf/writing.md","tags":[],"version":"current","frontMatter":{"id":"writing","title":"Writing Backstage Configuration Files","description":"Documentation on Writing Backstage Configuration Files"},"sidebar":"docs","previous":{"title":"Reading Backstage Configuration","permalink":"/docs/next/conf/reading"},"next":{"title":"Defining Configuration for your Plugin","permalink":"/docs/next/conf/defining"}}')}}]);