/*! For license information please see bbbbc1d4.0ea2f9e3.js.LICENSE.txt */
"use strict";(self.webpackChunkbackstage_microsite=self.webpackChunkbackstage_microsite||[]).push([[619195],{875294:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>s,default:()=>h,frontMatter:()=>o,metadata:()=>a,toc:()=>d});var i=t(474848),r=t(28453);const o={id:"provider",title:"Microsoft Azure Authentication Provider",sidebar_label:"Azure",description:"Adding Microsoft Azure as an authentication provider in Backstage"},s=void 0,a={id:"auth/microsoft/provider",title:"Microsoft Azure Authentication Provider",description:"Adding Microsoft Azure as an authentication provider in Backstage",source:"@site/../docs/auth/microsoft/provider.md",sourceDirName:"auth/microsoft",slug:"/auth/microsoft/provider",permalink:"/docs/next/auth/microsoft/provider",draft:!1,unlisted:!1,editUrl:"https://github.com/backstage/backstage/edit/master/docs/auth/microsoft/provider.md",tags:[],version:"current",frontMatter:{id:"provider",title:"Microsoft Azure Authentication Provider",sidebar_label:"Azure",description:"Adding Microsoft Azure as an authentication provider in Backstage"},sidebar:"docs",previous:{title:"AWS ALB",permalink:"/docs/next/auth/aws-alb/provider"},next:{title:"Azure Easy Auth",permalink:"/docs/next/auth/microsoft/easy-auth"}},c={},d=[{value:"Configure App Registration on Azure",id:"configure-app-registration-on-azure",level:2},{value:"Outbound Network Access",id:"outbound-network-access",level:2},{value:"Configuration",id:"configuration",level:2},{value:"Resolvers",id:"resolvers",level:3},{value:"Backend Installation",id:"backend-installation",level:2},{value:"Adding the provider to the Backstage frontend",id:"adding-the-provider-to-the-backstage-frontend",level:2}];function l(e){const n={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(n.p,{children:["The Backstage ",(0,i.jsx)(n.code,{children:"core-plugin-api"})," package comes with a Microsoft authentication\nprovider that can authenticate users using Azure OAuth."]}),"\n",(0,i.jsx)(n.h2,{id:"configure-app-registration-on-azure",children:"Configure App Registration on Azure"}),"\n",(0,i.jsx)(n.p,{children:"Depending on how locked down your company is, you may need a directory administrator to do some or all of these instructions."}),"\n",(0,i.jsxs)(n.p,{children:["Go to ",(0,i.jsx)(n.a,{href:"https://portal.azure.com/#view/Microsoft_AAD_RegisteredApps/ApplicationsListBlade",children:"Azure Portal > App registrations"})," and find your existing app registration, or create a new one.\nIf you have an existing App Registration for Backstage, use that rather than create a new one."]}),"\n",(0,i.jsxs)(n.p,{children:["On your app registration's overview page, add a new ",(0,i.jsx)(n.code,{children:"Web"})," platform configuration, with the configuration:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Redirect URI"}),": ",(0,i.jsx)(n.code,{children:"https://your-backstage.com/api/auth/microsoft/handler/frame"})," (for local dev, typically ",(0,i.jsx)(n.code,{children:"http://localhost:7007/api/auth/microsoft/handler/frame"}),")"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Front-channel logout Url"}),": blank"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Implicit grant and hybrid flows"}),": All unchecked"]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["On the ",(0,i.jsx)(n.strong,{children:"API permissions"})," tab, click on ",(0,i.jsx)(n.code,{children:"Add Permission"}),", then add the following ",(0,i.jsx)(n.code,{children:"Delegated"})," permission for the ",(0,i.jsx)(n.code,{children:"Microsoft Graph"})," API."]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"email"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"offline_access"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"openid"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"profile"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"User.Read"})}),"\n",(0,i.jsxs)(n.li,{children:["Optional custom scopes of the ",(0,i.jsx)(n.code,{children:"Microsoft Graph"})," API defined in the app-config.yaml file."]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["Your company may require you to grant ",(0,i.jsx)(n.a,{href:"https://learn.microsoft.com/en-us/azure/active-directory/manage-apps/user-admin-consent-overview",children:"admin consent"})," for these permissions.\nEven if your company doesn't require admin consent, you may wish to do so as it means users don't need to individually consent the first time they access backstage.\nTo grant admin consent, a directory admin will need to come to this page and click on the ",(0,i.jsx)(n.strong,{children:"Grant admin consent for COMPANY NAME"})," button."]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"App Registration Permissions",src:t(711556).A+"",width:"1534",height:"773"})}),"\n",(0,i.jsxs)(n.p,{children:["If you're using an existing app registration, and backstage already has a client secret, you can re-use that.\nIf not, go to the ",(0,i.jsx)(n.strong,{children:"Certificates & Secrets"})," page, then the ",(0,i.jsx)(n.strong,{children:"Client secrets"})," tab and create a new client secret.\nMake a note of this value as you'll need it in the next section."]}),"\n",(0,i.jsx)(n.h2,{id:"outbound-network-access",children:"Outbound Network Access"}),"\n",(0,i.jsx)(n.p,{children:"If your environment has restrictions on outgoing access (e.g. through\nfirewall rules), make sure your Backstage backend has access to the following\nhosts:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"login.microsoftonline.com"}),", to get and exchange authorization codes and access\ntokens"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"graph.microsoft.com"}),", to fetch user profile information (as seen\nin ",(0,i.jsx)(n.a,{href:"https://github.com/seanfisher/passport-microsoft/blob/0456aa9bce05579c18e77f51330176eb26373658/lib/strategy.js#L93-L95",children:"this source code"}),").\nIf this host is unreachable, users may see an ",(0,i.jsx)(n.code,{children:"Authentication failed, failed to fetch user profile"})," error when they attempt to log in."]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"configuration",children:"Configuration"}),"\n",(0,i.jsxs)(n.p,{children:["The provider configuration can then be added to your ",(0,i.jsx)(n.code,{children:"app-config.yaml"})," under the\nroot ",(0,i.jsx)(n.code,{children:"auth"})," configuration:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"auth:\n  environment: development\n  providers:\n    microsoft:\n      development:\n        clientId: ${AZURE_CLIENT_ID}\n        clientSecret: ${AZURE_CLIENT_SECRET}\n        tenantId: ${AZURE_TENANT_ID}\n        domainHint: ${AZURE_TENANT_ID}\n        signIn:\n          resolvers:\n            # See https://backstage.io/docs/auth/microsoft/provider#resolvers for more resolvers\n            - resolver: userIdMatchingUserEntityAnnotation\n"})}),"\n",(0,i.jsx)(n.p,{children:"The Microsoft provider is a structure with three mandatory configuration keys:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"clientId"}),": Application (client) ID, found on App Registration > Overview"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"clientSecret"}),": Secret, found on App Registration > Certificates & secrets"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"tenantId"}),": Directory (tenant) ID, found on App Registration > Overview"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"domainHint"})," (optional): Typically the same as ",(0,i.jsx)(n.code,{children:"tenantId"}),".\nLeave blank if your app registration is multi tenant.\nWhen specified, this reduces login friction for users with accounts in multiple tenants by automatically filtering away accounts from other tenants.\nFor more details, see ",(0,i.jsx)(n.a,{href:"https://learn.microsoft.com/en-us/azure/active-directory/manage-apps/home-realm-discovery-policy",children:"Home Realm Discovery"})]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"additionalScopes"})," (optional): List of scopes for the App Registration, to be requested in addition to the required ones."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"skipUserProfile"})," (optional): If true, skips loading the user profile even if the ",(0,i.jsx)(n.code,{children:"User.Read"})," scope is present. This is a performance optimization during login and can be used with resolvers that only needs the email address in ",(0,i.jsx)(n.code,{children:"spec.profile.email"})," obtained when the ",(0,i.jsx)(n.code,{children:"email"})," OAuth2 scope is present."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"sessionDuration"})," (optional): Lifespan of the user session."]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"resolvers",children:"Resolvers"}),"\n",(0,i.jsx)(n.p,{children:"This provider includes several resolvers out of the box that you can use:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"emailMatchingUserEntityProfileEmail"}),": Matches the email address from the auth provider with the User entity that has a matching ",(0,i.jsx)(n.code,{children:"spec.profile.email"}),". If no match is found it will throw a ",(0,i.jsx)(n.code,{children:"NotFoundError"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"emailLocalPartMatchingUserEntityName"}),": Matches the ",(0,i.jsx)(n.a,{href:"https://en.wikipedia.org/wiki/Email_address#Local-part",children:"local part"})," of the email address from the auth provider with the User entity that has a matching ",(0,i.jsx)(n.code,{children:"name"}),". If no match is found it will throw a ",(0,i.jsx)(n.code,{children:"NotFoundError"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"emailMatchingUserEntityAnnotation"}),": Matches the email address from the auth provider with the User entity where the value of the ",(0,i.jsx)(n.code,{children:"microsoft.com/email"})," annotation matches. If no match is found it will throw a ",(0,i.jsx)(n.code,{children:"NotFoundError"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"userIdMatchingUserEntityAnnotation"}),": Matches the user profile ID from the auth provider with the User entity where the value of the ",(0,i.jsx)(n.code,{children:"graph.microsoft.com/user-id"})," annotation matches. This resolver is recommended to resolve users without an email in their profile. If no match is found it will throw a ",(0,i.jsx)(n.code,{children:"NotFoundError"}),"."]}),"\n"]}),"\n",(0,i.jsx)(n.admonition,{title:"Note",type:"note",children:(0,i.jsxs)(n.p,{children:["The resolvers will be tried in order, but will only be skipped if they throw a ",(0,i.jsx)(n.code,{children:"NotFoundError"}),"."]})}),"\n",(0,i.jsxs)(n.p,{children:["If these resolvers do not fit your needs you can build a custom resolver, this is covered in the ",(0,i.jsx)(n.a,{href:"/docs/next/auth/identity-resolver#building-custom-resolvers",children:"Building Custom Resolvers"})," section of the Sign-in Identities and Resolvers documentation."]}),"\n",(0,i.jsx)(n.h2,{id:"backend-installation",children:"Backend Installation"}),"\n",(0,i.jsx)(n.p,{children:"To add the provider to the backend we will first need to install the package by running this command:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",metastring:'title="from your Backstage root directory"',children:"yarn --cwd packages/backend add @backstage/plugin-auth-backend-module-microsoft-provider\n"})}),"\n",(0,i.jsx)(n.p,{children:"Then we will need to this line:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",metastring:'title="in packages/backend/src/index.ts"',children:"backend.add(import('@backstage/plugin-auth-backend'));\n/* highlight-add-start */\nbackend.add(import('@backstage/plugin-auth-backend-module-microsoft-provider'));\n/* highlight-add-end */\n"})}),"\n",(0,i.jsx)(n.h2,{id:"adding-the-provider-to-the-backstage-frontend",children:"Adding the provider to the Backstage frontend"}),"\n",(0,i.jsxs)(n.p,{children:["To add the provider to the frontend, add the ",(0,i.jsx)(n.code,{children:"microsoftAuthApiRef"})," reference and\n",(0,i.jsx)(n.code,{children:"SignInPage"})," component as shown in\n",(0,i.jsx)(n.a,{href:"/docs/next/auth/#sign-in-configuration",children:"Adding the provider to the sign-in page"}),"."]})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(l,{...e})}):l(e)}},221020:(e,n,t)=>{var i=t(296540),r=Symbol.for("react.element"),o=Symbol.for("react.fragment"),s=Object.prototype.hasOwnProperty,a=i.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,c={key:!0,ref:!0,__self:!0,__source:!0};function d(e,n,t){var i,o={},d=null,l=null;for(i in void 0!==t&&(d=""+t),void 0!==n.key&&(d=""+n.key),void 0!==n.ref&&(l=n.ref),n)s.call(n,i)&&!c.hasOwnProperty(i)&&(o[i]=n[i]);if(e&&e.defaultProps)for(i in n=e.defaultProps)void 0===o[i]&&(o[i]=n[i]);return{$$typeof:r,type:e,key:d,ref:l,props:o,_owner:a.current}}n.Fragment=o,n.jsx=d,n.jsxs=d},474848:(e,n,t)=>{e.exports=t(221020)},711556:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/permissions-1b98f6b542dfb1313b29e075e8ab8094.png"},28453:(e,n,t)=>{t.d(n,{R:()=>s,x:()=>a});var i=t(296540);const r={},o=i.createContext(r);function s(e){const n=i.useContext(o);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:s(e.components),i.createElement(o.Provider,{value:n},e.children)}}}]);